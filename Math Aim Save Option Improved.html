<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MATH AIM ‚Äî Solve & Shoot</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{--cyan:#00f0ff;--pink:#ff2d95;--green:#39ff14;--yellow:#ffe600;--orange:#ff6b00;--red:#ff003c;--purple:#b44dff;--bg:#0a0a1a;--panel:rgba(10,10,30,0.92);--border:rgba(0,240,255,0.3)}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:'Rajdhani',sans-serif;color:#e0e8ff;cursor:default;user-select:none}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 50%,rgba(0,240,255,.06) 0%,transparent 60%),radial-gradient(ellipse at 80% 20%,rgba(255,45,149,.05) 0%,transparent 50%),radial-gradient(ellipse at 50% 80%,rgba(57,255,20,.04) 0%,transparent 50%);z-index:0;pointer-events:none}
body::after{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,240,255,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,240,255,.03) 1px,transparent 1px);background-size:60px 60px;z-index:0;pointer-events:none}
.screen{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:10}.screen.active{display:flex}
.exit-btn{position:fixed;top:14px;right:20px;z-index:200;font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:3px;text-transform:uppercase;padding:8px 16px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.45);border-radius:4px;cursor:pointer;transition:all .2s;display:none}.exit-btn:hover{background:rgba(255,0,60,.1);border-color:var(--red);color:var(--red)}.exit-btn.visible{display:block}
#menuScreen{gap:28px}
.game-title{font-family:'Orbitron',sans-serif;font-size:clamp(42px,7vw,80px);font-weight:900;letter-spacing:6px;text-align:center;background:linear-gradient(135deg,var(--cyan),var(--pink),var(--cyan));background-size:200% 200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:gradShift 4s ease infinite;filter:drop-shadow(0 0 30px rgba(0,240,255,.3))}
.game-subtitle{font-family:'Share Tech Mono',monospace;font-size:clamp(14px,2vw,20px);color:rgba(0,240,255,.6);letter-spacing:8px;text-transform:uppercase;margin-top:-10px}
@keyframes gradShift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.level-select-container{display:flex;flex-direction:column;align-items:center;gap:16px}
.level-label{font-family:'Share Tech Mono',monospace;font-size:16px;color:rgba(255,255,255,.5);letter-spacing:4px;text-transform:uppercase}
.level-display{font-family:'Orbitron',sans-serif;font-size:64px;font-weight:900;color:var(--cyan);text-shadow:0 0 20px rgba(0,240,255,.5);min-width:120px;text-align:center;transition:color .3s,text-shadow .3s}
.level-slider-row{display:flex;align-items:center;gap:16px}
.level-slider{-webkit-appearance:none;appearance:none;width:clamp(250px,40vw,450px);height:6px;background:linear-gradient(90deg,var(--green),var(--yellow),var(--orange),var(--red));border-radius:3px;outline:none;cursor:pointer}
.level-slider::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;background:#fff;border-radius:50%;box-shadow:0 0 12px rgba(0,240,255,.8);cursor:pointer}
.level-slider::-moz-range-thumb{width:24px;height:24px;background:#fff;border:none;border-radius:50%;box-shadow:0 0 12px rgba(0,240,255,.8);cursor:pointer}
.slider-end-label{font-family:'Share Tech Mono',monospace;font-size:12px;color:rgba(255,255,255,.35);letter-spacing:2px;text-transform:uppercase;min-width:50px}.slider-end-label:first-child{text-align:right}
.difficulty-desc{font-family:'Share Tech Mono',monospace;font-size:14px;min-height:20px;letter-spacing:1px;transition:color .3s}
.rounds-row{display:flex;align-items:center;gap:14px}
.rounds-label{font-family:'Share Tech Mono',monospace;font-size:14px;color:rgba(255,255,255,.45);letter-spacing:3px;text-transform:uppercase}
.rounds-btn{background:transparent;border:1px solid rgba(0,240,255,.3);color:var(--cyan);font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700;width:48px;height:48px;border-radius:8px;cursor:pointer;transition:all .2s}.rounds-btn:hover{background:rgba(0,240,255,.1)}.rounds-btn.selected{background:rgba(0,240,255,.15);border-color:var(--cyan);box-shadow:0 0 12px rgba(0,240,255,.3)}
.target-cap-container{display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:4px}
.cap-value{font-family:'Orbitron',sans-serif;font-size:36px;font-weight:900;color:var(--yellow);text-shadow:0 0 15px rgba(255,230,0,.3);min-width:80px;text-align:center}
.cap-slider{-webkit-appearance:none;appearance:none;width:clamp(200px,30vw,350px);height:6px;background:linear-gradient(90deg,var(--green),var(--yellow));border-radius:3px;outline:none;cursor:pointer}
.cap-slider::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:#fff;border-radius:50%;box-shadow:0 0 10px rgba(255,230,0,.6);cursor:pointer}
.cap-slider::-moz-range-thumb{width:20px;height:20px;background:#fff;border:none;border-radius:50%;box-shadow:0 0 10px rgba(255,230,0,.6);cursor:pointer}
.cap-max-row{display:flex;align-items:center;gap:8px}
.cap-max-label{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.3);letter-spacing:2px;text-transform:uppercase}
.cap-max-input{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;color:var(--yellow);background:rgba(255,230,0,.06);border:1px solid rgba(255,230,0,.2);border-radius:6px;padding:4px 10px;width:80px;text-align:center;outline:none;transition:all .2s;-moz-appearance:textfield}
.cap-max-input::-webkit-outer-spin-button,.cap-max-input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
.cap-max-input:focus{border-color:var(--yellow);box-shadow:0 0 12px rgba(255,230,0,.15)}
.cap-desc{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.25);letter-spacing:1px;text-align:center;max-width:400px}
.start-btn,.demo-btn{font-family:'Orbitron',sans-serif;font-size:22px;font-weight:700;letter-spacing:6px;text-transform:uppercase;padding:18px 60px;background:transparent;border:2px solid var(--cyan);color:var(--cyan);border-radius:4px;cursor:pointer;transition:all .3s}
.start-btn:hover,.demo-btn:hover{background:rgba(0,240,255,.1);box-shadow:0 0 30px rgba(0,240,255,.3);transform:translateY(-2px)}
.demo-btn{font-size:16px;padding:14px 40px;border-color:var(--pink);color:var(--pink);letter-spacing:4px}
.demo-btn:hover{border-color:var(--pink);box-shadow:0 0 30px rgba(255,45,149,.3)}
.menu-buttons{display:flex;gap:16px;align-items:center;flex-wrap:wrap;justify-content:center}
#mathScreen{gap:0;padding:20px}
.math-hud{display:flex;justify-content:space-between;align-items:center;width:100%;max-width:900px;padding:0 20px;margin-bottom:16px}
.hud-item{display:flex;flex-direction:column;align-items:center;gap:2px}
.hud-label{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.35);letter-spacing:3px;text-transform:uppercase}
.hud-value{font-family:'Orbitron',sans-serif;font-size:26px;font-weight:700;color:var(--cyan)}
.timer-ring-container{position:relative;width:140px;height:140px;margin:6px 0 12px}
.timer-ring{width:100%;height:100%;transform:rotate(-90deg)}
.timer-ring-bg{fill:none;stroke:rgba(255,255,255,.06);stroke-width:6}
.timer-ring-fill{fill:none;stroke:var(--green);stroke-width:6;stroke-linecap:round;stroke-dasharray:440;stroke-dashoffset:440;transition:stroke .5s;filter:drop-shadow(0 0 6px currentColor)}
.timer-text{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.timer-seconds{font-family:'Orbitron',sans-serif;font-size:38px;font-weight:900;color:var(--green);transition:color .5s}
.timer-label{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:rgba(255,255,255,.3);text-transform:uppercase;margin-top:-2px}
.pressure-badge{font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:2px;margin-top:4px;padding:4px 12px;border-radius:4px;border:1px solid}
.math-question-box{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:26px 44px;margin-bottom:16px;text-align:center;min-width:350px;max-width:700px;box-shadow:0 0 40px rgba(0,240,255,.05)}
.math-question{font-family:'Share Tech Mono',monospace;font-size:clamp(24px,4vw,40px);color:#fff;letter-spacing:2px;line-height:1.4}
.answers-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;width:100%;max-width:500px}
.answer-btn{font-family:'Orbitron',sans-serif;font-size:22px;font-weight:700;padding:18px 24px;background:rgba(255,255,255,.03);border:2px solid rgba(255,255,255,.12);color:#c0c8e0;border-radius:8px;cursor:pointer;transition:all .2s}.answer-btn:hover{border-color:var(--cyan);color:var(--cyan);background:rgba(0,240,255,.06)}.answer-btn.correct{border-color:var(--green);color:var(--green);background:rgba(57,255,20,.1)}.answer-btn.wrong{border-color:var(--red);color:var(--red);background:rgba(255,0,60,.1)}
#shootScreen{cursor:crosshair}
.shoot-canvas-container{position:fixed;inset:0;z-index:5}
#shootCanvas{width:100%;height:100%;display:block}
.shoot-hud{position:fixed;top:0;left:0;right:0;display:flex;justify-content:center;align-items:center;gap:20px;flex-wrap:wrap;padding:10px 20px;background:linear-gradient(180deg,rgba(0,0,0,.75) 0%,transparent 100%);z-index:20;pointer-events:none}
.shoot-hud-item{font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:1px;color:rgba(255,255,255,.65)}.shoot-hud-item span{font-family:'Orbitron',sans-serif;font-weight:700;color:var(--cyan);font-size:16px}
.combo-display{position:fixed;top:60px;left:50%;transform:translateX(-50%);font-family:'Orbitron',sans-serif;font-size:28px;font-weight:900;z-index:25;pointer-events:none;opacity:0;transition:all .3s;text-shadow:0 0 20px currentColor}.combo-display.visible{opacity:1}
.shoot-center-msg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Orbitron',sans-serif;font-size:clamp(36px,6vw,72px);font-weight:900;letter-spacing:6px;z-index:25;pointer-events:none;opacity:0;transition:opacity .3s}.shoot-center-msg.visible{opacity:1}
#roundResultScreen{gap:12px;padding:20px;overflow-y:auto;justify-content:center;align-items:center}
.round-result-title{font-family:'Orbitron',sans-serif;font-size:24px;font-weight:900;letter-spacing:4px;color:var(--cyan);text-shadow:0 0 20px rgba(0,240,255,.4);margin-bottom:8px;flex-shrink:0}
.round-stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;max-width:720px;width:100%;flex-shrink:0}
.stat-card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px 5px;text-align:center}
.stat-card-label{font-family:'Share Tech Mono',monospace;font-size:8px;color:rgba(255,255,255,.35);letter-spacing:2px;text-transform:uppercase;margin-bottom:2px}
.stat-card-value{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:900}
.stat-card-sub{font-family:'Share Tech Mono',monospace;font-size:7px;margin-top:1px;letter-spacing:1px}
.next-round-btn{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;letter-spacing:4px;padding:14px 44px;background:transparent;border:2px solid var(--cyan);color:var(--cyan);border-radius:4px;cursor:pointer;transition:all .3s;margin-top:6px;flex-shrink:0}.next-round-btn:hover{background:rgba(0,240,255,.1)}
#finalScreen{gap:10px;padding:20px;overflow-y:auto;justify-content:flex-start;padding-top:50px}
.final-title{font-family:'Orbitron',sans-serif;font-size:clamp(22px,4vw,36px);font-weight:900;letter-spacing:4px;background:linear-gradient(135deg,var(--cyan),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;flex-shrink:0}
.final-match-info{font-family:'Share Tech Mono',monospace;font-size:14px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.5);margin-top:-2px;flex-shrink:0}
.final-score-big{font-family:'Orbitron',sans-serif;font-size:clamp(48px,8vw,80px);font-weight:900;color:#fff;text-shadow:0 0 40px rgba(0,240,255,.4)}
.final-score-label{font-family:'Share Tech Mono',monospace;font-size:13px;color:rgba(255,255,255,.4);letter-spacing:4px;margin-top:-6px}
.mastery-bar{width:100%;max-width:500px;margin:4px 0}.mastery-bar-bg{width:100%;height:10px;background:rgba(255,255,255,.06);border-radius:5px;overflow:hidden}.mastery-bar-fill{height:100%;border-radius:5px;transition:width 1s ease}
.mastery-label{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.4);letter-spacing:2px;text-align:center;margin-top:4px}
.final-metrics-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;width:100%;max-width:860px}
.fm-card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:10px 4px;text-align:center}
.fm-title{font-family:'Share Tech Mono',monospace;font-size:8px;color:rgba(255,255,255,.3);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.fm-value{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700}
.fm-rank{font-family:'Share Tech Mono',monospace;font-size:9px;margin-top:2px;letter-spacing:1px}
.round-breakdown{width:100%;max-width:920px;margin-top:6px}
.breakdown-title{font-family:'Share Tech Mono',monospace;font-size:12px;color:rgba(255,255,255,.35);letter-spacing:4px;text-transform:uppercase;text-align:center;margin-bottom:6px}
.breakdown-table{width:100%;border-collapse:collapse}
.breakdown-table th{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(255,255,255,.3);letter-spacing:1px;text-transform:uppercase;padding:5px 3px;border-bottom:1px solid rgba(255,255,255,.08);text-align:center}
.breakdown-table td{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;text-align:center;padding:4px 3px;border-bottom:1px solid rgba(255,255,255,.04);color:rgba(255,255,255,.7)}
.play-again-btn{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700;letter-spacing:4px;padding:14px 44px;background:transparent;border:2px solid var(--pink);color:var(--pink);border-radius:4px;cursor:pointer;transition:all .3s}.play-again-btn:hover{background:rgba(255,45,149,.1)}
.save-score-btn{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700;letter-spacing:4px;padding:14px 44px;background:transparent;border:2px solid var(--cyan);color:var(--cyan);border-radius:4px;cursor:pointer;transition:all .3s}.save-score-btn:hover{background:rgba(0,240,255,.1);box-shadow:0 0 20px rgba(0,240,255,.2)}
.final-buttons{display:flex;gap:16px;align-items:center;flex-wrap:wrap;justify-content:center;margin:10px 0 30px}
.wrong-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px;z-index:100;background:rgba(10,10,26,.85)}.wrong-overlay.visible{display:flex}
.wrong-overlay-title{font-family:'Orbitron',sans-serif;font-size:48px;font-weight:900;color:var(--red);text-shadow:0 0 30px rgba(255,0,60,.5);letter-spacing:6px}
.wrong-overlay-sub{font-family:'Share Tech Mono',monospace;font-size:18px;color:rgba(255,255,255,.5)}
.muzzle-flash{position:fixed;pointer-events:none;z-index:50;width:30px;height:30px;border-radius:50%;background:radial-gradient(circle,rgba(255,255,200,.9) 0%,rgba(255,200,50,.4) 40%,transparent 70%);transform:translate(-50%,-50%);animation:flashOut .15s ease-out forwards}
@keyframes flashOut{0%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-50%) scale(2)}}

/* DEMO BANNER */
.demo-banner{position:fixed;bottom:0;left:0;right:0;z-index:300;text-align:center;padding:8px;background:linear-gradient(90deg,rgba(255,45,149,.15),rgba(0,240,255,.15),rgba(255,45,149,.15));border-top:2px solid var(--pink);pointer-events:none;display:none}
.demo-banner.visible{display:block}
.demo-banner-text{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;letter-spacing:6px;color:var(--pink);text-shadow:0 0 15px rgba(255,45,149,.5)}
.demo-banner-sub{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,255,255,.5);letter-spacing:2px;margin-top:2px}

@media(max-width:700px){.answers-grid{grid-template-columns:1fr;max-width:300px}.round-stats-grid{grid-template-columns:repeat(2,1fr)}.final-metrics-grid{grid-template-columns:repeat(3,1fr)}.math-question-box{padding:18px 20px;min-width:0}.shoot-hud{gap:8px;padding:6px 10px}.breakdown-table th,.breakdown-table td{padding:3px 2px;font-size:10px}}
</style>
</head>
<body>
<button class="exit-btn" id="exitBtn">‚úï Menu</button>
<div class="demo-banner" id="demoBanner"><div class="demo-banner-text" id="demoBannerText">ü§ñ AI DEMO</div><div class="demo-banner-sub" id="demoBannerSub">Level 1 ‚Äî Simple Arithmetic</div></div>

<div id="menuScreen" class="screen active">
  <div class="game-title">MATH AIM</div>
  <div class="game-subtitle">Solve & Shoot</div>
  <div class="level-select-container">
    <div class="level-label">Difficulty Level</div>
    <div class="level-display" id="levelDisplay">1</div>
    <div class="level-slider-row"><span class="slider-end-label">Easy</span><input type="range" class="level-slider" id="levelSlider" min="1" max="25" value="1"><span class="slider-end-label">Hard</span></div>
    <div class="difficulty-desc" id="diffDesc" style="color:var(--green)">Simple arithmetic ‚Ä¢ Generous time ‚Ä¢ Large slow targets</div>
  </div>
  <div class="rounds-row"><span class="rounds-label">Rounds</span><button class="rounds-btn selected" data-rounds="5">5</button><button class="rounds-btn" data-rounds="10">10</button><button class="rounds-btn" data-rounds="15">15</button><button class="rounds-btn" data-rounds="20">20</button></div>
  <div class="target-cap-container">
    <div class="level-label">Max Targets Per Round</div>
    <div class="cap-value" id="capValue">30</div>
    <div class="level-slider-row"><span class="slider-end-label">1</span><input type="range" class="level-slider cap-slider" id="capSlider" min="1" max="50" value="30"><span class="slider-end-label" id="capMaxLabel">50</span></div>
    <div class="cap-max-row"><span class="cap-max-label">Slider max:</span><input type="number" class="cap-max-input" id="capMaxInput" value="50" min="1"></div>
    <div class="cap-desc" id="capDesc">If the math answer exceeds this cap, fewer targets spawn but they become harder to hit.</div>
  </div>
  <div class="menu-buttons">
    <button class="start-btn" id="startBtn">START</button>
    <button class="demo-btn" id="demoBtn">ü§ñ WATCH DEMO</button>
  </div>
  <div style="margin-top:20px;font-family:'Share Tech Mono',monospace;font-size:12px;color:rgba(255,255,255,.25);letter-spacing:4px;text-transform:uppercase">Created by JLTHAKAD</div>
</div>

<div id="mathScreen" class="screen">
  <div class="math-hud"><div class="hud-item"><span class="hud-label">Round</span><span class="hud-value" id="hudRound">1/5</span></div><div class="hud-item"><span class="hud-label">Level</span><span class="hud-value" id="hudLevel">1</span></div><div class="hud-item"><span class="hud-label">Combo</span><span class="hud-value" id="hudCombo">0</span></div><div class="hud-item"><span class="hud-label">Score</span><span class="hud-value" id="hudScore">0</span></div></div>
  <div class="timer-ring-container"><svg class="timer-ring" viewBox="0 0 160 160"><circle class="timer-ring-bg" cx="80" cy="80" r="70"/><circle class="timer-ring-fill" id="timerRingFill" cx="80" cy="80" r="70"/></svg><div class="timer-text"><span class="timer-seconds" id="timerText">0.0</span><span class="timer-label">seconds</span></div></div>
  <div class="pressure-badge" id="pressureBadge" style="color:var(--cyan);border-color:var(--cyan)">1.0x PRESSURE</div>
  <div class="math-question-box"><div class="math-question" id="mathQuestion">12 + 7 = ?</div></div>
  <div class="answers-grid" id="answersGrid"></div>
</div>

<div id="shootScreen" class="screen">
  <div class="shoot-canvas-container"><canvas id="shootCanvas"></canvas></div>
  <div class="shoot-hud">
    <div class="shoot-hud-item">TARGETS: <span id="shootTargetsLeft">5</span></div>
    <div class="shoot-hud-item">HITS: <span id="shootHits">0</span></div>
    <div class="shoot-hud-item">PRECISION: <span id="shootAccuracy">‚Äî</span></div>
    <div class="shoot-hud-item">SPEED: <span id="shootSpeed">‚Äî</span></div>
    <div class="shoot-hud-item">COMBO: <span id="shootCombo">0</span></div>
    <div class="shoot-hud-item">MISSES: <span id="shootMisses">0</span></div>
    <div class="shoot-hud-item" id="capModHud" style="display:none">CAP MOD: <span id="shootCapMod">1.0x</span></div>
  </div>
  <div class="combo-display" id="comboDisplay"></div>
  <div class="shoot-center-msg" id="shootCenterMsg"></div>
</div>

<div id="roundResultScreen" class="screen">
  <div class="round-result-title" id="roundResultTitle">ROUND COMPLETE</div>
  <div class="round-stats-grid" id="roundStatsGrid"></div>
  <button class="next-round-btn" id="nextRoundBtn">NEXT ROUND</button>
</div>

<div id="finalScreen" class="screen">
  <div class="final-title">MATCH COMPLETE</div>
  <div class="final-match-info" id="finalMatchInfo"></div>
  <div class="final-score-big" id="finalScoreBig">0</div>
  <div class="final-score-label">TOTAL SCORE</div>
  <div class="mastery-bar"><div class="mastery-bar-bg"><div class="mastery-bar-fill" id="masteryFill"></div></div><div class="mastery-label" id="masteryLabel">MASTERY: 0 / 1000</div></div>
  <div class="final-metrics-grid" id="finalMetricsGrid"></div>
  <div class="round-breakdown"><div class="breakdown-title">Round Breakdown</div><table class="breakdown-table"><thead><tr><th>#</th><th>Math</th><th>Hits</th><th>Prec</th><th>Spd</th><th>Combo</th><th>Flick</th><th>Eff</th><th>Miss</th><th>Pts</th></tr></thead><tbody id="breakdownBody"></tbody></table></div>
  <div class="final-buttons"><button class="save-score-btn" id="saveScoreBtn">üì∏ SAVE SCORE</button><button class="play-again-btn" id="playAgainBtn">PLAY AGAIN</button></div>
</div>

<div class="wrong-overlay" id="wrongOverlay"><div class="wrong-overlay-title">WRONG!</div><div class="wrong-overlay-sub" id="wrongOverlaySub">The answer was 42</div></div>

<script>
const $=id=>document.getElementById(id);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CORE STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let level=1,totalRounds=5,currentRound=0,score=0,roundHistory=[],targetCap=30,lastAnswer=-1;
let correctAnswer=0,timerInterval=null,mathAnswered=false;
let mathStartTime=0,mathElapsed=0; // count-up stopwatch
let expectedTime=0; // baseline "par" time for the problem complexity
let roundMathCorrect=false,roundHits=0,roundMisses=0,roundTargetCount=0,problemDifficultyMult=1;
let capModifier=1; // how much harder targets become when capped
let canvas,ctx,targets=[],particles=[],hitFeedbacks=[],shootingActive=false,animFrameId=null,targetsRemaining=0;
let roundAccuracyScores=[],roundHitTimes=[],lastHitTime=0,shootPhaseStartTime=0;
let comboCount=0,maxCombo=0,roundMaxCombo=0,roundComboPoints=0;
let mouseTrail=[],roundFlickScores=[],firstBloodTime=0,firstBloodAwarded=false,mathConfidenceRatio=0;
let bullseyeChain=0,maxBullseyeChain=0,roundBullseyeBonus=0;
let totalClicks=0,totalCursorDist=0,hitPositions=[],lastMouseX=0,lastMouseY=0;
let lastShotWasMiss=false,roundRecoveries=0,clickTimestamps=[];
let clutchMathCount=0,clutchShotCount=0,clutchOpportunities=0;
let mouseX=0,mouseY=0;
let finalData=null; // stored for save screenshot

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEMO STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let demoMode=false,demoActive=false;
const DEMO_LEVELS=[1,5,10,15,20,25];
const DEMO_LEVEL_NAMES=['Simple Arithmetic','Basic Operations','Mixed Operations','Multi-Step Problems','Complex Math','Extreme Difficulty'];
let demoLevelIdx=0;
let aiX=0,aiY=0,aiTargetX=0,aiTargetY=0,aiMoving=false,aiAimTarget=null;
let aiMathTimeout=null,aiShootInterval=null,aiResultTimeout=null;

// AI skill parameters per demo level index (0-5)
const AI_SKILL=[
  {mathDelay:1500,aimSpeed:10,precRange:[88,99],missChance:.02,flickBase:400},
  {mathDelay:2000,aimSpeed:9,precRange:[82,96],missChance:.04,flickBase:600},
  {mathDelay:2500,aimSpeed:8,precRange:[76,93],missChance:.06,flickBase:800},
  {mathDelay:3000,aimSpeed:7,precRange:[70,90],missChance:.08,flickBase:1000},
  {mathDelay:3500,aimSpeed:6.5,precRange:[65,87],missChance:.10,flickBase:1200},
  {mathDelay:4000,aimSpeed:6,precRange:[60,84],missChance:.13,flickBase:1400},
];

function getPersonalBest(){try{return JSON.parse(localStorage.getItem('mathaim_pb_lv'+level+'_r'+totalRounds))||null}catch(e){return null}}
function setPersonalBest(d){try{localStorage.setItem('mathaim_pb_lv'+level+'_r'+totalRounds,JSON.stringify(d))}catch(e){}}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));$(id).classList.add('active');$('exitBtn').classList.toggle('visible',id!=='menuScreen')}

function exitToMenu(){
  clearInterval(timerInterval);clearTimeout(aiMathTimeout);clearTimeout(aiResultTimeout);clearInterval(aiShootInterval);
  shootingActive=false;demoActive=false;demoMode=false;
  if(animFrameId)cancelAnimationFrame(animFrameId);
  $('wrongOverlay').classList.remove('visible');$('shootCenterMsg').classList.remove('visible');
  $('demoBanner').classList.remove('visible');showScreen('menuScreen');
}
$('exitBtn').addEventListener('click',exitToMenu);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MENU ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const levelSlider=$('levelSlider'),levelDisplay=$('levelDisplay'),diffDesc=$('diffDesc');
function getLevelColor(l){return l<=5?'var(--green)':l<=10?'var(--cyan)':l<=15?'var(--yellow)':l<=20?'var(--orange)':'var(--red)'}
function getLevelDesc(l){return l<=3?'Simple arithmetic ‚Ä¢ Generous time ‚Ä¢ Large slow targets':l<=6?'Basic operations ‚Ä¢ Comfortable time ‚Ä¢ Moderate targets':l<=10?'Mixed operations ‚Ä¢ Fair time ‚Ä¢ Moving targets':l<=15?'Multi-step problems ‚Ä¢ Tight time ‚Ä¢ Fast targets':l<=20?'Complex math ‚Ä¢ Limited time ‚Ä¢ Erratic targets':l<=23?'Advanced problems ‚Ä¢ Strict time ‚Ä¢ Chaotic targets':'Extreme difficulty ‚Ä¢ Minimal time ‚Ä¢ Precision required'}
levelSlider.addEventListener('input',()=>{level=+levelSlider.value;levelDisplay.textContent=level;const c=getLevelColor(level);levelDisplay.style.color=c;levelDisplay.style.textShadow=`0 0 20px ${c}`;diffDesc.textContent=getLevelDesc(level);diffDesc.style.color=c});
document.querySelectorAll('.rounds-btn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.rounds-btn').forEach(x=>x.classList.remove('selected'));b.classList.add('selected');totalRounds=+b.dataset.rounds}));
const capSlider=$('capSlider'),capValue=$('capValue'),capMaxInput=$('capMaxInput'),capMaxLabel=$('capMaxLabel');
capSlider.addEventListener('input',()=>{targetCap=+capSlider.value;capValue.textContent=targetCap});
capMaxInput.addEventListener('input',()=>{let v=parseInt(capMaxInput.value)||1;if(v<1)v=1;capSlider.max=v;capMaxLabel.textContent=v;if(+capSlider.value>v){capSlider.value=v;targetCap=v;capValue.textContent=v}});
capMaxInput.addEventListener('blur',()=>{let v=parseInt(capMaxInput.value)||1;if(v<1){v=1;capMaxInput.value=1}capSlider.max=v;capMaxLabel.textContent=v;if(+capSlider.value>v){capSlider.value=v;targetCap=v;capValue.textContent=v}});
$('startBtn').addEventListener('click',()=>{demoMode=false;level=+levelSlider.value;targetCap=Math.max(1,+capSlider.value);lastAnswer=-1;currentRound=0;score=0;roundHistory=[];comboCount=0;maxCombo=0;clutchMathCount=0;clutchShotCount=0;clutchOpportunities=0;nextRound()});
$('nextRoundBtn').addEventListener('click',()=>{if(demoMode)demoNextStep();else nextRound()});
$('playAgainBtn').addEventListener('click',()=>{demoMode=false;$('demoBanner').classList.remove('visible');showScreen('menuScreen')});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEMO START ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
$('demoBtn').addEventListener('click',startDemo);
function startDemo(){
  demoMode=true;demoActive=true;demoLevelIdx=0;currentRound=0;score=0;roundHistory=[];
  comboCount=0;maxCombo=0;clutchMathCount=0;clutchShotCount=0;clutchOpportunities=0;
  totalRounds=DEMO_LEVELS.length;lastAnswer=-1;targetCap=30;
  aiX=window.innerWidth/2;aiY=window.innerHeight/2;
  $('demoBanner').classList.add('visible');
  updateDemoBanner();demoNextRound();
}
function updateDemoBanner(){
  $('demoBannerText').textContent='ü§ñ AI DEMO ‚Äî LEVEL '+DEMO_LEVELS[demoLevelIdx];
  $('demoBannerSub').textContent=DEMO_LEVEL_NAMES[demoLevelIdx]+' ‚Ä¢ Round '+(demoLevelIdx+1)+'/'+DEMO_LEVELS.length;
}
function demoNextRound(){
  if(demoLevelIdx>=DEMO_LEVELS.length){showFinalResults();return}
  level=DEMO_LEVELS[demoLevelIdx];updateDemoBanner();nextRound();
  // AI answers after a delay proportional to difficulty
  const skill=AI_SKILL[demoLevelIdx];
  aiMathTimeout=setTimeout(()=>{
    if(demoMode&&!mathAnswered)demoAnswerMath();
  },skill.mathDelay+randInt(300,1000));
}
function demoAnswerMath(){
  const btns=document.querySelectorAll('.answer-btn');
  // Find correct button ‚Äî hover effect first
  let correctBtn=null;
  btns.forEach(b=>{if(+b.textContent===correctAnswer)correctBtn=b});
  if(correctBtn&&!mathAnswered){
    correctBtn.classList.add('correct');// visual hover
    setTimeout(()=>handleAnswer(correctAnswer,correctBtn),300);
  }
}
function demoNextStep(){
  demoLevelIdx++;
  if(demoLevelIdx>=DEMO_LEVELS.length){showFinalResults();return}
  level=DEMO_LEVELS[demoLevelIdx];updateDemoBanner();nextRound();
  const skill=AI_SKILL[demoLevelIdx];
  aiMathTimeout=setTimeout(()=>{
    if(demoMode&&!mathAnswered)demoAnswerMath();
  },skill.mathDelay+randInt(300,1000));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI SHOOTING CONTROLLER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startAIShooting(){
  if(!demoMode)return;
  const skill=AI_SKILL[demoLevelIdx]||AI_SKILL[5];
  let currentTarget=null;
  let aimTime=0; // ms spent aiming at current target
  const baseAimDuration=lerp(250,600,demoLevelIdx/5); // how long AI aims before shooting
  let lastTickTime=performance.now();
  
  function pickTarget(){
    // Pick nearest alive target
    let best=null,bestDist=Infinity;
    for(const t of targets){if(!t.alive)continue;const d=Math.sqrt((t.x-aiX)**2+(t.y-aiY)**2);if(d<bestDist){bestDist=d;best=t}}
    return best;
  }
  
  function aiTick(){
    if(!shootingActive||!demoMode){clearInterval(aiInterval);return}
    const now=performance.now();
    const dt=now-lastTickTime;lastTickTime=now;
    
    // Pick target if none or current is dead
    if(!currentTarget||!currentTarget.alive){currentTarget=pickTarget();aimTime=0}
    if(!currentTarget){clearInterval(aiInterval);return}
    
    // Track target's CURRENT position directly
    const prec=randFloat(skill.precRange[0],skill.precRange[1])/100;
    const offsetX=(Math.random()-.5)*currentTarget.radius*(1-prec)*.8;
    const offsetY=(Math.random()-.5)*currentTarget.radius*(1-prec)*.8;
    const goalX=currentTarget.x+offsetX;
    const goalY=currentTarget.y+offsetY;
    
    // Move AI cursor aggressively toward target (high lerp factor)
    const lerpFactor=Math.min(1,0.25+skill.aimSpeed*0.05);
    const prevAiX=aiX,prevAiY=aiY;
    aiX+=(goalX-aiX)*lerpFactor;
    aiY+=(goalY-aiY)*lerpFactor;
    // Track cursor distance for path efficiency
    totalCursorDist+=Math.sqrt((aiX-prevAiX)**2+(aiY-prevAiY)**2);
    
    aimTime+=dt;
    
    // Check if AI is close enough AND has aimed long enough
    const distToCenter=Math.sqrt((aiX-currentTarget.x)**2+(aiY-currentTarget.y)**2);
    const insideTarget=distToCenter<currentTarget.radius*0.9;
    
    if(insideTarget&&aimTime>=baseAimDuration+randInt(-50,100)){
      // SHOOT ‚Äî decide hit or intentional miss
      if(Math.random()<skill.missChance){
        // Intentional miss: click outside the target
        const missAngle=Math.random()*Math.PI*2;
        const missDist=currentTarget.radius*(1.5+Math.random());
        triggerAIClick(currentTarget.x+Math.cos(missAngle)*missDist,currentTarget.y+Math.sin(missAngle)*missDist);
      }else{
        // Hit: click at AI's current position (which is inside the target)
        triggerAIClick(aiX,aiY);
      }
      // Reset for next target
      currentTarget=null;aimTime=0;
    }
  }
  
  var aiInterval=setInterval(aiTick,50);aiShootInterval=aiInterval;
}

function triggerAIClick(cx,cy){
  if(!shootingActive)return;
  const now=performance.now();
  // Flash
  const fl=document.createElement('div');fl.className='muzzle-flash';fl.style.left=cx+'px';fl.style.top=cy+'px';document.body.appendChild(fl);setTimeout(()=>fl.remove(),200);
  totalClicks++;clickTimestamps.push(now);
  // Update mouseTrail for flick scoring
  mouseTrail.push({x:cx,y:cy,t:now});if(mouseTrail.length>50)mouseTrail.shift();
  let hit=false;
  for(let i=targets.length-1;i>=0;i--){const tg=targets[i];if(tg.alive&&tg.hitTest(cx,cy)){
    tg.alive=false;roundHits++;targetsRemaining--;hit=true;
    const d1=Math.sqrt((cx-tg.x)**2+(cy-tg.y)**2),d2=Math.sqrt((cx-tg.prevX)**2+(cy-tg.prevY)**2),d3=Math.sqrt((cx-(tg.x+tg.prevX)/2)**2+(cy-(tg.y+tg.prevY)/2)**2),dist=Math.min(d1,d2,d3);
    const precPct=Math.round(Math.max(0,(1-dist/tg.radius))*100);roundAccuracyScores.push(precPct);
    const tsl=now-lastHitTime;roundHitTimes.push(tsl);lastHitTime=now;
    const trail=mouseTrail.filter(p=>now-p.t<80);let fpx=0;if(trail.length>=2){const f=trail[0],l=trail[trail.length-1],fd=Math.sqrt((l.x-f.x)**2+(l.y-f.y)**2),ft=(l.t-f.t)/1000;if(ft>0)fpx=fd/ft}roundFlickScores.push(fpx);
    if(!firstBloodAwarded){firstBloodTime=now-shootPhaseStartTime;firstBloodAwarded=true}
    comboCount++;if(comboCount>maxCombo)maxCombo=comboCount;if(comboCount>roundMaxCombo)roundMaxCombo=comboCount;
    const cMult=Math.min(3,1+Math.floor(comboCount/2)*.5);roundComboPoints+=Math.round(50*(cMult-1));
    if(precPct>=85){bullseyeChain++;if(bullseyeChain>maxBullseyeChain)maxBullseyeChain=bullseyeChain;roundBullseyeBonus+=20*Math.pow(2,Math.min(bullseyeChain-1,7))}else bullseyeChain=0;
    if(lastShotWasMiss&&precPct>=80&&tsl<=400)roundRecoveries++;lastShotWasMiss=false;
    if(roundMisses>0&&precPct>=90){clutchShotCount++;clutchOpportunities++}
    hitPositions.push({x:tg.x,y:tg.y});
    let fl2,fc;if(precPct>=95){fl2='PERFECT!';fc='#00f0ff'}else if(precPct>=80){fl2='GREAT!';fc='#39ff14'}else if(precPct>=60){fl2='GOOD';fc='#ffe600'}else if(precPct>=35){fl2='OK';fc='#ff6b00'}else{fl2='HIT';fc='#ff2d95'}
    let extra=[];if(comboCount>=3)extra.push(comboCount+'x');if(fpx>=1500)extra.push('INHUMAN');else if(fpx>=800)extra.push('‚ö°');if(bullseyeChain>=3)extra.push('üéØ√ó'+bullseyeChain);
    hitFeedbacks.push({x:tg.x,y:tg.y-tg.radius-10,label:fl2+' '+precPct+'%',sub:Math.round(tsl)+'ms'+(extra.length?' '+extra.join(' '):''),color:fc,life:1.8,vy:-55});
    spawnHit(tg.x,tg.y);updateShootHUD();
    if(comboCount>=3){const cd=$('comboDisplay');cd.textContent=comboCount+'x COMBO';cd.style.color=comboCount>=7?'var(--pink)':comboCount>=5?'var(--green)':'var(--cyan)';cd.classList.add('visible');clearTimeout(cd._to);cd._to=setTimeout(()=>cd.classList.remove('visible'),1500)}
    if(targetsRemaining<=0){shootingActive=false;setTimeout(()=>{cancelAnimationFrame(animFrameId);showRoundResult();if(demoMode){aiResultTimeout=setTimeout(()=>{if(demoMode)demoNextStep()},3000)}},500)}
    break;
  }}
  if(!hit){roundMisses++;comboCount=0;bullseyeChain=0;lastShotWasMiss=true;$('shootMisses').textContent=roundMisses;$('shootCombo').textContent='0';$('comboDisplay').classList.remove('visible');spawnMiss(cx,cy)}
}
function updateShootHUD(){
  $('shootHits').textContent=roundHits;$('shootTargetsLeft').textContent=targetsRemaining;
  $('shootCombo').textContent=comboCount;$('shootCombo').style.color=comboCount>=5?'var(--pink)':comboCount>=3?'var(--green)':'var(--cyan)';
  if(roundAccuracyScores.length){const a=Math.round(roundAccuracyScores.reduce((a,b)=>a+b,0)/roundAccuracyScores.length);$('shootAccuracy').textContent=a+'%';$('shootAccuracy').style.color=a>=80?'var(--green)':a>=50?'var(--yellow)':'var(--orange)'}
  if(roundHitTimes.length){const a=Math.round(roundHitTimes.reduce((a,b)=>a+b,0)/roundHitTimes.length);$('shootSpeed').textContent=a+'ms';$('shootSpeed').style.color=a<=500?'var(--green)':a<=1000?'var(--yellow)':'var(--orange)'}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MATH GENERATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateProblem(lv){
  let q,a,attempts=0;
  // Keep generating until we get a different answer from last round (max 20 tries)
  do{
    attempts++;
    a=undefined;
  if(lv<=3){const op=Math.random()<.5;const a1=randInt(1,15),a2=randInt(1,10);if(op){q=`${a1} + ${a2}`;a=a1+a2}else{const b=Math.max(a1,a2),s=Math.min(a1,a2);q=`${b} - ${s}`;a=b-s}}
  else if(lv<=6){const t=randInt(0,2);if(t===0){const a1=randInt(2,9),a2=randInt(2,9);q=`${a1} √ó ${a2}`;a=a1*a2}else if(t===1){const a1=randInt(10,50),a2=randInt(5,30);q=`${a1} + ${a2}`;a=a1+a2}else{const a1=randInt(20,60),a2=randInt(5,20);q=`${a1} - ${a2}`;a=a1-a2}}
  else if(lv<=10){const t=randInt(0,3);if(t===0){const a1=randInt(20,100),a2=randInt(10,80);q=`${a1} + ${a2}`;a=a1+a2}else if(t===1){const a1=randInt(30,100),a2=randInt(10,30);q=`${a1} - ${a2}`;a=a1-a2}else if(t===2){const a1=randInt(3,12),a2=randInt(3,12);q=`${a1} √ó ${a2}`;a=a1*a2}else{const d=randInt(2,10),qt=randInt(2,12);q=`${d*qt} √∑ ${d}`;a=qt}}
  else if(lv<=15){const t=randInt(0,4);if(t===0){const a1=randInt(12,25),a2=randInt(5,15);q=`${a1} √ó ${a2}`;a=a1*a2}else if(t===1){const b=randInt(2,9),ad=randInt(1,20);q=`${b}¬≤ + ${ad}`;a=b*b+ad}else if(t===2){const a1=randInt(10,30),a2=randInt(2,8),a3=randInt(5,20);q=`${a1} √ó ${a2} - ${a3}`;a=a1*a2-a3}else if(t===3){const a1=randInt(100,300),a2=randInt(50,200);q=`${a1} + ${a2}`;a=a1+a2}else{const n=randInt(2,12);q=`${n}¬≤`;a=n*n}}
  else if(lv<=20){const t=randInt(0,4);if(t===0){const a1=randInt(15,40),a2=randInt(3,12),a3=randInt(10,50);q=`${a1} √ó ${a2} + ${a3}`;a=a1*a2+a3}else if(t===1){const pf=[4,9,16,25,36,49,64,81,100,121,144],i=randInt(0,pf.length-1),ad=randInt(5,30);q=`‚àö${pf[i]} + ${ad}`;a=Math.sqrt(pf[i])+ad}else if(t===2){const b=randInt(2,6);q=`${b}¬≥`;a=b**3}else if(t===3){const a1=randInt(20,50),a2=randInt(3,9),a3=randInt(2,6);q=`(${a1} + ${a2}) √ó ${a3}`;a=(a1+a2)*a3}else{const a1=randInt(100,500),a2=randInt(50,300);q=`${a1} - ${a2}`;a=a1-a2}}
  else{const t=randInt(0,5);if(t===0){const a1=randInt(25,60),a2=randInt(10,30),a3=randInt(5,15),a4=randInt(2,8);q=`(${a1}√ó${a2})-(${a3}√ó${a4})`;a=a1*a2-a3*a4}else if(t===1){const b=randInt(2,5),c=randInt(2,4),ad=randInt(10,50);q=`${b}^${c} + ${ad}`;a=b**c+ad}else if(t===2){const pf=[16,25,36,49,64,81,100,121,144,169,196],i=randInt(0,pf.length-1),m=randInt(3,9);q=`‚àö${pf[i]} √ó ${m}`;a=Math.sqrt(pf[i])*m}else if(t===3){const a1=randInt(50,150),a2=randInt(20,80),a3=randInt(10,50),m=randInt(2,5);q=`(${a1}+${a2})√ó${m}-${a3}`;a=(a1+a2)*m-a3}else if(t===4){const a1=randInt(3,12),a2=randInt(3,12),a3=randInt(3,12);q=`${a1}√ó${a2}√ó${a3}`;a=a1*a2*a3}else{const d=randInt(3,12),qt=randInt(10,25),ad=randInt(20,80);q=`(${d*qt}√∑${d})+${ad}`;a=qt+ad}}
  a=Math.round(a);
  // Ensure answer is at least 1 (need at least 1 target)
  if(a<1)a=undefined;
  }while((a===lastAnswer||a===undefined)&&attempts<20);
  // Update last answer tracker
  lastAnswer=a;
  let cx=1;if(q.includes('√ó'))cx+=.5;if(q.includes('√∑'))cx+=.5;if(q.includes('¬≤')||q.includes('¬≥'))cx+=.4;if(q.includes('‚àö'))cx+=.6;if(q.includes('^'))cx+=.7;cx+=(q.match(/[+\-√ó√∑]/g)||[]).length*.3;if(q.includes('('))cx+=.4;const ns=q.match(/\d+/g)||[];if(Math.max(...ns.map(Number))>100)cx+=.5;if(Math.max(...ns.map(Number))>500)cx+=.5;
  problemDifficultyMult=Math.max(1,Math.min(3,cx*.8));
  const ch=new Set([a]),rng=Math.max(5,Math.abs(a)*.3);let at=0;while(ch.size<4&&at<100){let w=a+randInt(-Math.ceil(rng),Math.ceil(rng));if(w!==a&&w>=0)ch.add(Math.round(w));at++}while(ch.size<4)ch.add(a+ch.size*3);

  // ‚îÄ‚îÄ PAR TIME ‚Äî expected time for a skilled player ‚îÄ‚îÄ
  // Used purely for scoring: beat par = bonus, exceed par = penalty
  const lvSkill=lerp(1,.7,(lv-1)/24); // skilled players get faster at higher levels
  const parTime=Math.max(3,Math.round(cx*3.5*lvSkill)); // seconds

  return{question:q+' = ?',answer:a,choices:shuffle([...ch]),parTime};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME FLOW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function nextRound(){
  currentRound++;if(currentRound>totalRounds){showFinalResults();return}
  roundHits=0;roundMisses=0;roundMathCorrect=false;mathElapsed=0;mathAnswered=false;
  roundAccuracyScores=[];roundHitTimes=[];roundFlickScores=[];hitFeedbacks=[];
  lastHitTime=0;firstBloodTime=0;firstBloodAwarded=false;mathConfidenceRatio=0;
  bullseyeChain=0;maxBullseyeChain=0;roundBullseyeBonus=0;roundMaxCombo=comboCount;
  totalClicks=0;totalCursorDist=0;hitPositions=[];lastShotWasMiss=false;roundRecoveries=0;clickTimestamps=[];mouseTrail=[];roundComboPoints=0;problemDifficultyMult=1;capModifier=1;
  startMathPhase();
}

function startMathPhase(){
  showScreen('mathScreen');
  $('hudRound').textContent=`${currentRound}/${totalRounds}`;$('hudLevel').textContent=level;
  $('hudCombo').textContent=comboCount;$('hudCombo').style.color=comboCount>=5?'var(--pink)':comboCount>=3?'var(--green)':'var(--cyan)';
  $('hudScore').textContent=score;
  
  const p=generateProblem(level);
  correctAnswer=p.answer;expectedTime=p.parTime;mathElapsed=0;
  
  $('mathQuestion').textContent=p.question;
  $('timerText').textContent='0.0';$('timerText').style.color='var(--green)';
  
  const pb=$('pressureBadge');pb.textContent=problemDifficultyMult.toFixed(1)+'x PRESSURE';
  const pc=problemDifficultyMult>=2.5?'var(--red)':problemDifficultyMult>=1.8?'var(--orange)':problemDifficultyMult>=1.3?'var(--yellow)':'var(--cyan)';
  pb.style.color=pc;pb.style.borderColor=pc;
  
  // Ring starts empty, fills up as time passes
  const ring=$('timerRingFill');
  const circ=2*Math.PI*70;
  ring.style.strokeDashoffset=circ.toString(); // fully empty
  ring.style.stroke='var(--green)';
  
  // Show all answers immediately
  const grid=$('answersGrid');grid.innerHTML='';
  p.choices.forEach(c=>{const btn=document.createElement('button');btn.className='answer-btn';btn.textContent=c;btn.addEventListener('click',()=>handleAnswer(c,btn));grid.appendChild(btn)});
  
  // ‚îÄ‚îÄ COUNT-UP STOPWATCH ‚Äî no time limit ‚îÄ‚îÄ
  mathStartTime=performance.now();
  clearInterval(timerInterval);
  
  timerInterval=setInterval(()=>{
    if(mathAnswered)return;
    mathElapsed=(performance.now()-mathStartTime)/1000;
    $('timerText').textContent=mathElapsed.toFixed(1);
    
    // Ring fills up: at par time = full ring, can exceed
    const fillPct=Math.min(1,mathElapsed/expectedTime);
    ring.style.strokeDashoffset=((1-fillPct)*circ).toString();
    
    // Color shifts based on how close to / past par time
    const ratio=mathElapsed/expectedTime;
    if(ratio<0.5){ring.style.stroke='var(--green)';$('timerText').style.color='var(--green)'}
    else if(ratio<0.8){ring.style.stroke='var(--cyan)';$('timerText').style.color='var(--cyan)'}
    else if(ratio<1.0){ring.style.stroke='var(--yellow)';$('timerText').style.color='var(--yellow)'}
    else if(ratio<1.5){ring.style.stroke='var(--orange)';$('timerText').style.color='var(--orange)'}
    else{ring.style.stroke='var(--red)';$('timerText').style.color='var(--red)'}
  },50);
}

function handleAnswer(choice,btn){
  if(mathAnswered)return;
  mathAnswered=true;clearInterval(timerInterval);
  mathElapsed=(performance.now()-mathStartTime)/1000;
  
  // Confidence = how fast vs par time (faster = higher)
  const speedRatio=mathElapsed/expectedTime;
  mathConfidenceRatio=Math.max(0,Math.min(1,1-((speedRatio-0.3)/1.4)));
  
  if(choice===correctAnswer){
    btn.classList.add('correct');roundMathCorrect=true;
    
    // ‚îÄ‚îÄ TARGET COUNT = ANSWER, with player cap ‚îÄ‚îÄ
    const rawTargets=Math.max(1,correctAnswer); // answer IS the target count
    if(rawTargets<=targetCap){
      // Answer fits within cap: spawn exact amount, no modifier
      roundTargetCount=rawTargets;
      capModifier=1;
    }else{
      // Answer exceeds cap: spawn cap amount, targets get harder
      roundTargetCount=targetCap;
      // capModifier scales proportionally: answer=100, cap=30 -> ratio=3.33
      // But we clamp it so targets stay humanly hittable
      // Modifier range: 1.0 (no change) to 2.5 (maximum hardness)
      const overflowRatio=rawTargets/targetCap; // how many times over the cap
      capModifier=Math.min(2.5,1+(overflowRatio-1)*0.4); // gentle curve, maxes at 2.5x
    }
    
    if(speedRatio>1.5){clutchOpportunities++}
    comboCount++;setTimeout(()=>startShootingPhase(),700);
  }else{
    btn.classList.add('wrong');document.querySelectorAll('.answer-btn').forEach(b=>{if(+b.textContent===correctAnswer)b.classList.add('correct')});
    roundMathCorrect=false;roundTargetCount=0;capModifier=1;comboCount=0;showWrongOverlay('Correct answer: '+correctAnswer);
  }
}
function showWrongOverlay(m){$('wrongOverlaySub').textContent=m;$('wrongOverlay').classList.add('visible');setTimeout(()=>{$('wrongOverlay').classList.remove('visible');showRoundResult();if(demoMode){aiResultTimeout=setTimeout(()=>{if(demoMode)demoNextStep()},2500)}},2000)}

function startShootingPhase(){
  showScreen('shootScreen');canvas=$('shootCanvas');ctx=canvas.getContext('2d');resizeCanvas();
  roundHits=0;roundMisses=0;targets=[];particles=[];hitFeedbacks=[];shootingActive=false;targetsRemaining=roundTargetCount;
  roundAccuracyScores=[];roundHitTimes=[];roundFlickScores=[];lastHitTime=0;firstBloodAwarded=false;firstBloodTime=0;
  bullseyeChain=0;maxBullseyeChain=0;roundBullseyeBonus=0;roundMaxCombo=comboCount;
  totalClicks=0;totalCursorDist=0;hitPositions=[];lastShotWasMiss=false;roundRecoveries=0;clickTimestamps=[];mouseTrail=[];roundComboPoints=0;
  $('shootTargetsLeft').textContent=targetsRemaining;$('shootHits').textContent='0';$('shootMisses').textContent='0';
  $('shootAccuracy').textContent='‚Äî';$('shootSpeed').textContent='‚Äî';$('shootCombo').textContent=comboCount;
  $('comboDisplay').classList.remove('visible');
  // Show cap modifier in HUD if targets were capped
  if(capModifier>1){$('capModHud').style.display='';$('shootCapMod').textContent=capModifier.toFixed(1)+'x';$('shootCapMod').style.color=capModifier>=2?'var(--red)':capModifier>=1.5?'var(--orange)':'var(--yellow)'}
  else{$('capModHud').style.display='none'}
  aiX=canvas.width/2;aiY=canvas.height/2; // reset AI cursor
  showCenterMsg('3','var(--cyan)');
  setTimeout(()=>{showCenterMsg('2','var(--yellow)');
  setTimeout(()=>{showCenterMsg('1','var(--orange)');
  setTimeout(()=>{showCenterMsg('FIRE!','var(--red)');setTimeout(()=>$('shootCenterMsg').classList.remove('visible'),500);
    shootingActive=true;shootPhaseStartTime=performance.now();lastHitTime=performance.now();lastMouseX=mouseX;lastMouseY=mouseY;
    spawnTargets();startShootLoop();
    if(demoMode)startAIShooting();
  },700)},700)},700);
}
function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight}
window.addEventListener('resize',()=>{if(canvas)resizeCanvas()});
function showCenterMsg(t,c){const e=$('shootCenterMsg');e.textContent=t;e.style.color=c;e.style.textShadow=`0 0 30px ${c}`;e.classList.add('visible')}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TARGETS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
class Target{
  constructor(x,y,r,s,p,pd){this.x=x;this.y=y;this.prevX=x;this.prevY=y;this.baseX=x;this.baseY=y;this.radius=r;this.speed=s;this.pattern=p;this.pd=pd;this.alive=true;this.spawnTime=performance.now();this.phase=Math.random()*Math.PI*2;this.opacity=0;this.fadeIn=true}
  update(dt,now){if(!this.alive)return;this.prevX=this.x;this.prevY=this.y;if(this.fadeIn){this.opacity=Math.min(1,this.opacity+dt*4);if(this.opacity>=1)this.fadeIn=false}
    const t=(now-this.spawnTime)/1000,s=this.speed;
    switch(this.pattern){
      case'linear':this.x=this.baseX+Math.sin(t*s+this.phase)*this.pd.ampX;break;
      case'circle':this.x=this.baseX+Math.cos(t*s+this.phase)*this.pd.r;this.y=this.baseY+Math.sin(t*s+this.phase)*this.pd.r;break;
      case'figure8':this.x=this.baseX+Math.sin(t*s+this.phase)*this.pd.aX;this.y=this.baseY+Math.sin(t*s*2+this.phase)*this.pd.aY;break;
      case'zigzag':{const p=2/s,tp=((t+this.phase)%p)/p;this.x=this.baseX+(tp<.5?lerp(-1,1,tp*2):lerp(1,-1,(tp-.5)*2))*this.pd.aX;this.y=this.baseY+Math.sin(t*s*1.5)*this.pd.aY;break}
      case'teleport':if(Math.random()<this.pd.tc*dt){this.baseX=clamp(this.baseX+(Math.random()-.5)*this.pd.td,this.radius+50,canvas.width-this.radius-50);this.baseY=clamp(this.baseY+(Math.random()-.5)*this.pd.td,this.radius+80,canvas.height-this.radius-50)}this.x=this.baseX+Math.sin(t*s*3)*15;this.y=this.baseY+Math.cos(t*s*2.5)*12;break;
      case'spiral':{const st=t*s,sr=this.pd.bR+Math.sin(st*.5)*this.pd.aR;this.x=this.baseX+Math.cos(st+this.phase)*sr;this.y=this.baseY+Math.sin(st+this.phase)*sr;break}
      case'chaos':this.x=this.baseX+Math.sin(t*s+this.phase)*this.pd.a1+Math.cos(t*s*1.7+this.phase*.5)*this.pd.a2;this.y=this.baseY+Math.cos(t*s*1.3+this.phase)*this.pd.a3+Math.sin(t*s*2.1+this.phase*1.3)*this.pd.a4;break;
      case'dash':{const cy=(t*s)%4;if(cy>=1&&cy<1.3){const dp=(cy-1)/.3;this.x=this.baseX+dp*this.pd.dX;this.y=this.baseY+dp*this.pd.dY}else if(cy>=1.3&&cy<2.3){this.x=this.baseX+this.pd.dX;this.y=this.baseY+this.pd.dY}else if(cy>=2.3&&cy<2.6){const dp=(cy-2.3)/.3;this.x=this.baseX+(1-dp)*this.pd.dX;this.y=this.baseY+(1-dp)*this.pd.dY}break}
    }
    this.x=clamp(this.x,this.radius+10,canvas.width-this.radius-10);this.y=clamp(this.y,this.radius+70,canvas.height-this.radius-10);
  }
  draw(c){if(!this.alive)return;c.save();c.globalAlpha=this.opacity;const g=c.createRadialGradient(this.x,this.y,this.radius*.3,this.x,this.y,this.radius*1.5);g.addColorStop(0,'rgba(255,45,149,.3)');g.addColorStop(1,'rgba(255,45,149,0)');c.fillStyle=g;c.beginPath();c.arc(this.x,this.y,this.radius*1.5,0,Math.PI*2);c.fill();c.fillStyle='rgba(255,45,149,.15)';c.strokeStyle='rgba(255,45,149,.8)';c.lineWidth=2;c.beginPath();c.arc(this.x,this.y,this.radius,0,Math.PI*2);c.fill();c.stroke();c.strokeStyle='rgba(255,255,255,.3)';c.lineWidth=1;c.beginPath();c.arc(this.x,this.y,this.radius*.65,0,Math.PI*2);c.stroke();c.strokeStyle='rgba(255,255,255,.5)';c.beginPath();c.arc(this.x,this.y,this.radius*.3,0,Math.PI*2);c.stroke();c.fillStyle='#ff2d95';c.beginPath();c.arc(this.x,this.y,this.radius*.12,0,Math.PI*2);c.fill();c.restore()}
  hitTest(mx,my){
    // Base forgiveness: 15% buffer so clicks on the visible outer ring register
    const baseForgive=1.15;
    // Speed forgiveness: faster targets get more buffer (up to 30% extra)
    const dx=this.x-this.prevX,dy=this.y-this.prevY;
    const spd=Math.sqrt(dx*dx+dy*dy);
    const spdForgive=Math.min(0.3,spd*0.02);
    const effectiveR=this.radius*(baseForgive+spdForgive);
    // Check current position
    const d1=Math.sqrt((mx-this.x)**2+(my-this.y)**2);
    if(d1<=effectiveR)return true;
    // Motion compensation: also check against previous frame position
    // (player clicked where the target was visually rendered)
    if(spd>2){const d2=Math.sqrt((mx-this.prevX)**2+(my-this.prevY)**2);if(d2<=effectiveR)return true;
    // Check midpoint between prev and current for very fast movement
    if(spd>8){const midX=(this.x+this.prevX)/2,midY=(this.y+this.prevY)/2;const d3=Math.sqrt((mx-midX)**2+(my-midY)**2);if(d3<=effectiveR)return true}}
    return false;
  }
}
function spawnTargets(){
  targets=[];
  const c=roundTargetCount,t=(level-1)/24;
  // ‚îÄ‚îÄ BASE VALUES (from difficulty level) ‚îÄ‚îÄ
  const baseR=lerp(45,14,t),rv=lerp(5,4,t),baseS=lerp(.8,4.5,t);
  
  // ‚îÄ‚îÄ CAP MODIFIER: targets get harder when answer exceeds cap ‚îÄ‚îÄ
  // capModifier ranges from 1.0 (no change) to 2.5 (max hardness)
  // Radius shrinks: divide by modifier (but never below 12px for human playability)
  // Speed increases: multiply by modifier (but never above 2.5x base)
  // Patterns shift toward harder types
  const cm=capModifier;
  const adjR=Math.max(12,baseR/Math.sqrt(cm)); // sqrt so it doesn't shrink too aggressively
  const adjS=baseS*Math.min(2.5,1+(cm-1)*0.6); // speed scales, capped at 2.5x
  
  // Use harder patterns if cap modifier is high
  let pats;
  if(cm>=2.0) pats=['chaos','teleport','dash','spiral','zigzag'];
  else if(cm>=1.5) pats=getPatterns(Math.min(25,level+5)); // shift patterns up ~5 levels
  else pats=getPatterns(level);
  
  // Use a harder pattern data level when capped
  const patLv=Math.min(25,level+Math.round((cm-1)*8)); // shift pattern intensity
  
  for(let i=0;i<c;i++){
    const r=adjR+(Math.random()-.5)*rv*2;
    const finalR=Math.max(12,Math.round(r)); // absolute minimum 12px radius
    const m=finalR+80;
    const x=randFloat(m,canvas.width-m),y=randFloat(m+60,canvas.height-m);
    const s=adjS*randFloat(.7,1.3);
    const pn=pats[i%pats.length];
    targets.push(new Target(x,y,finalR,s,pn,getPatData(pn,patLv)));
  }
}
function getPatterns(l){return l<=2?['linear']:l<=4?['linear','circle']:l<=7?['linear','circle','figure8']:l<=10?['circle','figure8','zigzag']:l<=13?['figure8','zigzag','spiral']:l<=16?['zigzag','spiral','teleport']:l<=19?['spiral','teleport','chaos','figure8']:l<=22?['teleport','chaos','dash','spiral']:['chaos','teleport','dash','spiral','chaos']}
function getPatData(p,lv){const t=(lv-1)/24,a=lerp(60,200,t);switch(p){case'linear':return{ampX:a};case'circle':return{r:a*.6};case'figure8':return{aX:a,aY:a*.5};case'zigzag':return{aX:a,aY:a*.3};case'teleport':return{tc:lerp(.3,1.5,t),td:lerp(100,300,t)};case'spiral':return{bR:a*.4,aR:a*.3};case'chaos':return{a1:randFloat(30,a*.7),a2:randFloat(20,a*.5),a3:randFloat(25,a*.6),a4:randFloat(15,a*.4)};case'dash':return{dX:(Math.random()-.5)*a*1.5,dY:(Math.random()-.5)*a*.8};default:return{}}}

class Particle{constructor(x,y,c){this.x=x;this.y=y;const a=Math.random()*Math.PI*2,s=randFloat(80,300);this.vx=Math.cos(a)*s;this.vy=Math.sin(a)*s;this.life=1;this.decay=randFloat(1.5,3.5);this.size=randFloat(2,5);this.color=c}update(d){this.x+=this.vx*d;this.y+=this.vy*d;this.vy+=200*d;this.life-=this.decay*d}draw(c){if(this.life<=0)return;c.globalAlpha=this.life;c.fillStyle=this.color;c.fillRect(this.x-this.size/2,this.y-this.size/2,this.size,this.size)}}
function spawnHit(x,y){const c=['#ff2d95','#ff6b9d','#ffb3d1','#fff','#ff003c'];for(let i=0;i<20;i++)particles.push(new Particle(x,y,c[randInt(0,c.length-1)]))}
function spawnMiss(x,y){for(let i=0;i<5;i++)particles.push(new Particle(x,y,'rgba(255,255,255,.3)'))}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CROSSHAIR DRAWING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawCross(c,x,y,isAI){
  c.save();const col=isAI?'rgba(255,215,0,.9)':'rgba(0,240,255,.8)';
  c.strokeStyle=col;c.lineWidth=isAI?2:1.5;c.beginPath();c.arc(x,y,isAI?22:18,0,Math.PI*2);c.stroke();
  const g=6,l=14;c.beginPath();c.moveTo(x-l,y);c.lineTo(x-g,y);c.moveTo(x+g,y);c.lineTo(x+l,y);c.moveTo(x,y-l);c.lineTo(x,y-g);c.moveTo(x,y+g);c.lineTo(x,y+l);c.stroke();
  c.fillStyle=col;c.beginPath();c.arc(x,y,2,0,Math.PI*2);c.fill();
  if(isAI){c.font='bold 10px Orbitron,sans-serif';c.fillStyle='rgba(255,215,0,.7)';c.textAlign='center';c.fillText('AI',x,y-26)}
  c.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MOUSE (PLAYER MODE) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('mousemove',e=>{mouseX=e.clientX;mouseY=e.clientY;mouseTrail.push({x:e.clientX,y:e.clientY,t:performance.now()});if(mouseTrail.length>50)mouseTrail.shift();if(shootingActive&&!demoMode){totalCursorDist+=Math.sqrt((e.clientX-lastMouseX)**2+(e.clientY-lastMouseY)**2);lastMouseX=e.clientX;lastMouseY=e.clientY}});
document.addEventListener('click',e=>{
  if(!shootingActive||demoMode)return;
  const mx=e.clientX,my=e.clientY,now=performance.now();
  const fl=document.createElement('div');fl.className='muzzle-flash';fl.style.left=mx+'px';fl.style.top=my+'px';document.body.appendChild(fl);setTimeout(()=>fl.remove(),200);
  totalClicks++;clickTimestamps.push(now);
  mouseTrail.push({x:mx,y:my,t:now});
  let hit=false;
  for(let i=targets.length-1;i>=0;i--){const tg=targets[i];if(tg.alive&&tg.hitTest(mx,my)){
    tg.alive=false;roundHits++;targetsRemaining--;hit=true;
    const d1=Math.sqrt((mx-tg.x)**2+(my-tg.y)**2),d2=Math.sqrt((mx-tg.prevX)**2+(my-tg.prevY)**2),d3=Math.sqrt((mx-(tg.x+tg.prevX)/2)**2+(my-(tg.y+tg.prevY)/2)**2),dist=Math.min(d1,d2,d3);
    const precPct=Math.round(Math.max(0,(1-dist/tg.radius))*100);roundAccuracyScores.push(precPct);
    const tsl=now-lastHitTime;roundHitTimes.push(tsl);lastHitTime=now;
    const trail=mouseTrail.filter(p=>now-p.t<80);let fpx=0;if(trail.length>=2){const f=trail[0],l=trail[trail.length-1],fd=Math.sqrt((l.x-f.x)**2+(l.y-f.y)**2),ft=(l.t-f.t)/1000;if(ft>0)fpx=fd/ft}roundFlickScores.push(fpx);
    if(!firstBloodAwarded){firstBloodTime=now-shootPhaseStartTime;firstBloodAwarded=true}
    comboCount++;if(comboCount>maxCombo)maxCombo=comboCount;if(comboCount>roundMaxCombo)roundMaxCombo=comboCount;
    const cMult=Math.min(3,1+Math.floor(comboCount/2)*.5);roundComboPoints+=Math.round(50*(cMult-1));
    if(precPct>=85){bullseyeChain++;if(bullseyeChain>maxBullseyeChain)maxBullseyeChain=bullseyeChain;roundBullseyeBonus+=20*Math.pow(2,Math.min(bullseyeChain-1,7))}else bullseyeChain=0;
    if(lastShotWasMiss&&precPct>=80&&tsl<=400)roundRecoveries++;lastShotWasMiss=false;
    if(roundMisses>0&&precPct>=90){clutchShotCount++;clutchOpportunities++}
    hitPositions.push({x:tg.x,y:tg.y});
    let fl2,fc;if(precPct>=95){fl2='PERFECT!';fc='#00f0ff'}else if(precPct>=80){fl2='GREAT!';fc='#39ff14'}else if(precPct>=60){fl2='GOOD';fc='#ffe600'}else if(precPct>=35){fl2='OK';fc='#ff6b00'}else{fl2='HIT';fc='#ff2d95'}
    let extra=[];if(comboCount>=3)extra.push(comboCount+'x');if(fpx>=1500)extra.push('INHUMAN');else if(fpx>=800)extra.push('‚ö°');if(bullseyeChain>=3)extra.push('üéØ√ó'+bullseyeChain);
    hitFeedbacks.push({x:tg.x,y:tg.y-tg.radius-10,label:fl2+' '+precPct+'%',sub:Math.round(tsl)+'ms'+(extra.length?' '+extra.join(' '):''),color:fc,life:1.8,vy:-55});
    spawnHit(tg.x,tg.y);updateShootHUD();
    if(comboCount>=3){const cd=$('comboDisplay');cd.textContent=comboCount+'x COMBO';cd.style.color=comboCount>=7?'var(--pink)':comboCount>=5?'var(--green)':'var(--cyan)';cd.classList.add('visible');clearTimeout(cd._to);cd._to=setTimeout(()=>cd.classList.remove('visible'),1500)}
    if(targetsRemaining<=0){shootingActive=false;setTimeout(()=>{cancelAnimationFrame(animFrameId);showRoundResult()},500)}
    break;
  }}
  if(!hit){roundMisses++;comboCount=0;bullseyeChain=0;lastShotWasMiss=true;$('shootMisses').textContent=roundMisses;$('shootCombo').textContent='0';$('comboDisplay').classList.remove('visible');spawnMiss(mx,my)}
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER LOOP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lastFrame=0;
function startShootLoop(){lastFrame=performance.now();if(animFrameId)cancelAnimationFrame(animFrameId);shootLoop()}
function shootLoop(){if(!shootingActive&&targetsRemaining<=0){drawFrame(0);return}animFrameId=requestAnimationFrame(shootLoop);const now=performance.now(),dt=Math.min((now-lastFrame)/1000,.05);lastFrame=now;drawFrame(dt,now)}
function drawFrame(dt,now){
  ctx.clearRect(0,0,canvas.width,canvas.height);ctx.strokeStyle='rgba(0,240,255,.04)';ctx.lineWidth=1;
  for(let x=0;x<canvas.width;x+=80){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke()}
  for(let y=0;y<canvas.height;y+=80){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke()}
  for(const t of targets){t.update(dt,now||performance.now());t.draw(ctx)}
  for(let i=particles.length-1;i>=0;i--){particles[i].update(dt);if(particles[i].life<=0)particles.splice(i,1);else particles[i].draw(ctx)}
  for(let i=hitFeedbacks.length-1;i>=0;i--){const f=hitFeedbacks[i];f.y+=f.vy*dt;f.life-=dt;if(f.life<=0){hitFeedbacks.splice(i,1);continue}ctx.save();ctx.globalAlpha=Math.min(1,f.life*2);ctx.fillStyle=f.color;ctx.font='bold 15px Orbitron,sans-serif';ctx.textAlign='center';ctx.shadowColor=f.color;ctx.shadowBlur=10;ctx.fillText(f.label,f.x,f.y);ctx.font='10px "Share Tech Mono",monospace';ctx.fillStyle='rgba(255,255,255,.5)';ctx.shadowBlur=0;ctx.fillText(f.sub,f.x,f.y+16);ctx.restore()}
  ctx.globalAlpha=1;
  if(shootingActive){if(demoMode)drawCross(ctx,aiX,aiY,true);else drawCross(ctx,mouseX,mouseY,false)}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ROUND SCORING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcRoundScore(){
  const S={},h=roundHits,m=roundMisses,tc=roundTargetCount;
  S.math=roundMathCorrect?100:0;
  
  // ‚îÄ‚îÄ MATH SPEED BONUS (replaces old time-left bonus) ‚îÄ‚îÄ
  // Compare elapsed time to par time: fast = big bonus, slow = penalty
  const speedRatio=expectedTime>0?mathElapsed/expectedTime:2;
  S.mathTime=mathElapsed.toFixed(1);S.parTime=expectedTime;
  if(!roundMathCorrect){S.timeBonus=-50;S.timeRank='WRONG';S.timeColor='var(--red)'}
  else if(speedRatio<=0.3){S.timeBonus=250;S.timeRank='INSTANT';S.timeColor='var(--pink)'}
  else if(speedRatio<=0.5){S.timeBonus=180;S.timeRank='LIGHTNING';S.timeColor='var(--pink)'}
  else if(speedRatio<=0.75){S.timeBonus=120;S.timeRank='FAST';S.timeColor='var(--green)'}
  else if(speedRatio<=1.0){S.timeBonus=60;S.timeRank='ON PACE';S.timeColor='var(--cyan)'}
  else if(speedRatio<=1.5){S.timeBonus=20;S.timeRank='SLOW';S.timeColor='var(--yellow)'}
  else if(speedRatio<=2.0){S.timeBonus=-20;S.timeRank='SLUGGISH';S.timeColor='var(--orange)'}
  else{S.timeBonus=-60;S.timeRank='CRAWLING';S.timeColor='var(--red)'}
  
  S.hitPts=h*50;
  const cMult=Math.min(3,1+Math.floor(roundMaxCombo/2)*.5);S.streakMult=cMult;S.streakBonus=roundComboPoints;
  S.streakRank=roundMaxCombo>=5?'ON FIRE':roundMaxCombo>=3?'HOT':roundMaxCombo>=1?'WARM':'COLD';S.streakColor=roundMaxCombo>=5?'var(--pink)':roundMaxCombo>=3?'var(--green)':roundMaxCombo>=1?'var(--cyan)':'var(--red)';
  const af=roundFlickScores.length?roundFlickScores.reduce((a,b)=>a+b,0)/roundFlickScores.length:0;
  S.flickAvg=Math.round(af);S.flickBonus=af>=1500?h*40:af>=800?h*25:af>=200?h*10:0;S.flickPenalty=af<100&&h>0?-20:0;
  S.flickRank=af>=1500?'INHUMAN':af>=800?'LIGHTNING':af>=200?'FLICK':af>=50?'SNIPE':'STATIONARY';S.flickColor=af>=1500?'var(--pink)':af>=800?'var(--green)':af>=200?'var(--yellow)':af>=50?'var(--orange)':'var(--red)';
  S.fbMs=firstBloodAwarded?Math.round(firstBloodTime):0;S.fbBonus=S.fbMs<=200?350:S.fbMs<=500?100:S.fbMs<=1000?40:S.fbMs<=2000?0:-25;
  S.fbRank=S.fbMs<=200?'REFLEX GOD':S.fbMs<=500?'FIRST BLOOD':S.fbMs<=1000?'ALERT':S.fbMs<=2000?'SLOW':'ASLEEP';S.fbColor=S.fbMs<=200?'var(--pink)':S.fbMs<=500?'var(--green)':S.fbMs<=1000?'var(--yellow)':S.fbMs<=2000?'var(--orange)':'var(--red)';
  if(!firstBloodAwarded){S.fbBonus=-50;S.fbRank='NO HITS';S.fbColor='var(--red)'}
  S.confPct=Math.round(mathConfidenceRatio*100);S.confMult=mathConfidenceRatio>=.9?1.5:mathConfidenceRatio>=.7?1.3:mathConfidenceRatio>=.5?1.15:mathConfidenceRatio>=.25?1:.85;
  S.confRank=mathConfidenceRatio>=.9?'GENIUS':mathConfidenceRatio>=.7?'CONFIDENT':mathConfidenceRatio>=.5?'STEADY':mathConfidenceRatio>=.25?'SLOW':'STUMPED';S.confColor=mathConfidenceRatio>=.9?'var(--pink)':mathConfidenceRatio>=.7?'var(--green)':mathConfidenceRatio>=.5?'var(--yellow)':mathConfidenceRatio>=.25?'var(--orange)':'var(--red)';
  if(!roundMathCorrect){S.confMult=.5;S.confRank='WRONG';S.confColor='var(--red)'}
  S.bullMax=maxBullseyeChain;S.bullBonus=roundBullseyeBonus;if(maxBullseyeChain>=tc&&tc>0)S.bullBonus+=500;
  S.bullRank=maxBullseyeChain>=5?'DIAMOND EYE':maxBullseyeChain>=3?'SHARPSHOOTER':maxBullseyeChain>=1?'FOCUSED':'NONE';S.bullColor=maxBullseyeChain>=5?'var(--pink)':maxBullseyeChain>=3?'var(--green)':maxBullseyeChain>=1?'var(--yellow)':'var(--red)';
  const er=totalClicks>0?h/totalClicks:0;S.effPct=Math.round(er*100);S.effBonus=Math.round(300*er);if(er<.4&&totalClicks>0)S.effBonus=Math.max(-50,S.effBonus-100);
  S.effRank=er>=1?'SURGICAL':er>=.8?'PRECISE':er>=.6?'DECENT':er>=.4?'SLOPPY':'SPRAY & PRAY';S.effColor=er>=1?'var(--pink)':er>=.8?'var(--green)':er>=.6?'var(--yellow)':er>=.4?'var(--orange)':'var(--red)';
  let od=0;for(let i=1;i<hitPositions.length;i++){const a=hitPositions[i-1],b=hitPositions[i];od+=Math.sqrt((b.x-a.x)**2+(b.y-a.y)**2)}
  const pe=totalCursorDist>0&&od>0?Math.min(1,od/totalCursorDist):0;S.pathPct=Math.round(pe*100);S.pathBonus=pe>=.9?200:pe>=.7?100:pe>=.5?50:pe>=.3?10:h>0?-30:0;
  S.pathRank=pe>=.9?'LASER PATH':pe>=.7?'CLEAN ROUTE':pe>=.5?'ADEQUATE':pe>=.3?'WANDERER':'LOST';S.pathColor=pe>=.9?'var(--pink)':pe>=.7?'var(--green)':pe>=.5?'var(--yellow)':pe>=.3?'var(--orange)':'var(--red)';
  S.pressMult=problemDifficultyMult;S.pressColor=problemDifficultyMult>=2.5?'var(--red)':problemDifficultyMult>=1.8?'var(--orange)':problemDifficultyMult>=1.3?'var(--yellow)':'var(--cyan)';
  S.recCount=roundRecoveries;
  if(m===0){S.recBonus=50;S.recRank='CLEAN';S.recColor='var(--green)'}else if(roundRecoveries>=m){S.recBonus=roundRecoveries*35;S.recRank='FULL RECOVERY';S.recColor='var(--green)'}else if(roundRecoveries>0){S.recBonus=roundRecoveries*25;S.recRank='PARTIAL';S.recColor='var(--yellow)'}else{S.recBonus=-m*15;S.recRank='NO RECOVERY';S.recColor='var(--red)'}
  const avgHD=roundHitTimes.length?roundHitTimes.reduce((a,b)=>a+b,0)/roundHitTimes.length:9999;
  S.priorBonus=avgHD<400?h*15:avgHD<700?h*8:avgHD<1200?0:-h*5;S.priorRank=avgHD<400?'TACTICAL':avgHD<700?'AWARE':avgHD<1200?'RANDOM':'LOST';S.priorColor=avgHD<400?'var(--green)':avgHD<700?'var(--yellow)':avgHD<1200?'var(--orange)':'var(--red)';
  if(clickTimestamps.length>=3){const gaps=[];for(let i=1;i<clickTimestamps.length;i++)gaps.push(clickTimestamps[i]-clickTimestamps[i-1]);const mn=gaps.reduce((a,b)=>a+b,0)/gaps.length;const sd=Math.sqrt(gaps.reduce((a,b)=>a+(b-mn)**2,0)/gaps.length);S.hbStd=Math.round(sd);S.hbBonus=sd<100?150:sd<200?80:sd<300?40:sd<500?0:-30;S.hbRank=sd<100?'METRONOME':sd<200?'STEADY':sd<300?'COMPOSED':sd<500?'ERRATIC':'PANICKED';S.hbColor=sd<100?'var(--pink)':sd<200?'var(--green)':sd<300?'var(--yellow)':sd<500?'var(--orange)':'var(--red)'}else{S.hbStd=0;S.hbBonus=0;S.hbRank='‚Äî';S.hbColor='var(--cyan)'}
  const ap=roundAccuracyScores.length?Math.round(roundAccuracyScores.reduce((a,b)=>a+b,0)/roundAccuracyScores.length):0;
  const as2=roundHitTimes.length?Math.round(roundHitTimes.reduce((a,b)=>a+b,0)/roundHitTimes.length):0;
  let pB=roundAccuracyScores.reduce((s,p)=>s+Math.round(p*.5),0);if(ap<30&&h>0)pB-=50;
  let sB=0;for(const t of roundHitTimes){sB+=t<=300?30:t<=500?25:t<=800?15:t<=1200?5:0}if(as2>2000&&h>0)sB-=30;
  S.avgPrec=ap;S.avgSpd=as2;S.precBonus=pB;S.spdBonus=sB;
  S.precRank=ap>=90?'DEAD CENTER':ap>=70?'SHARP':ap>=50?'FAIR':ap>=30?'LOOSE':'WILD';S.precColor=ap>=90?'var(--pink)':ap>=70?'var(--green)':ap>=50?'var(--yellow)':ap>=30?'var(--orange)':'var(--red)';
  S.spdRank=as2<=300?'BLAZING':as2<=500?'FAST':as2<=800?'MODERATE':as2<=1200?'SLOW':'SLUGGISH';S.spdColor=as2&&as2<=300?'var(--pink)':as2<=500?'var(--green)':as2<=800?'var(--yellow)':as2<=1200?'var(--orange)':'var(--red)';
  // ‚îÄ‚îÄ CAP MODIFIER: bonus multiplier when targets were harder due to cap ‚îÄ‚îÄ
  S.capMod=capModifier;
  S.capColor=capModifier>=2?'var(--red)':capModifier>=1.5?'var(--orange)':capModifier>=1.2?'var(--yellow)':'var(--green)';
  S.capRank=capModifier>=2?'BRUTAL':capModifier>=1.5?'INTENSE':capModifier>=1.2?'BOOSTED':'STANDARD';
  
  let raw=S.math+S.timeBonus+S.hitPts+S.precBonus+S.spdBonus+S.streakBonus+S.flickBonus+(S.flickPenalty||0)+S.fbBonus+S.bullBonus+S.effBonus+S.pathBonus+S.recBonus+S.hbBonus+S.priorBonus;
  raw=Math.round(raw*S.confMult*S.pressMult*S.capMod);S.total=Math.max(0,raw);return S;
}
function sig(n){return n>=0?'+'+n:''+n}

function showRoundResult(){
  showScreen('roundResultScreen');const S=calcRoundScore();score+=S.total;
  roundHistory.push({round:currentRound,mathCorrect:roundMathCorrect,S,hits:roundHits,misses:roundMisses,targetCount:roundTargetCount,maxCombo:roundMaxCombo});
  $('roundResultTitle').textContent=`ROUND ${currentRound} ‚Äî ${S.total} PTS`;
  const g=$('roundStatsGrid');g.innerHTML='';
  [{l:'Math',v:roundMathCorrect?'‚úì':'‚úó',c:roundMathCorrect?'var(--green)':'var(--red)',s:''},{l:'Answer',v:correctAnswer,c:'var(--cyan)',s:roundTargetCount<correctAnswer?correctAnswer+' targets ‚Üí '+roundTargetCount+' (capped)':correctAnswer+' targets'},{l:'Solve Time',v:S.mathTime+'s',c:S.timeColor,s:S.timeRank+' '+sig(S.timeBonus)+' (par '+S.parTime+'s)'},{l:'Confidence',v:S.confPct+'%',c:S.confColor,s:S.confRank+' √ó'+S.confMult.toFixed(1)},{l:'Pressure',v:S.pressMult.toFixed(1)+'x',c:S.pressColor,s:'Diff multiplier'},{l:'Cap Mod',v:S.capMod.toFixed(1)+'x',c:S.capColor,s:S.capRank+(S.capMod>1?' (√ó'+S.capMod.toFixed(1)+' score)':'')},{l:'Targets',v:roundHits+'/'+roundTargetCount,c:roundHits===roundTargetCount?'var(--green)':'var(--yellow)',s:''},{l:'Precision',v:S.avgPrec+'%',c:S.precColor,s:S.precRank+' '+sig(S.precBonus)},{l:'Speed',v:S.avgSpd?S.avgSpd+'ms':'‚Äî',c:S.spdColor,s:S.spdRank+' '+sig(S.spdBonus)},{l:'Combo',v:roundMaxCombo+'x',c:S.streakColor,s:S.streakRank+' '+sig(S.streakBonus)},{l:'Flick',v:S.flickAvg+'px/s',c:S.flickColor,s:S.flickRank+' '+sig(S.flickBonus+(S.flickPenalty||0))},{l:'1st Blood',v:S.fbMs?S.fbMs+'ms':'‚Äî',c:S.fbColor,s:S.fbRank+' '+sig(S.fbBonus)},{l:'Bullseye',v:S.bullMax+'x',c:S.bullColor,s:S.bullRank+' '+sig(S.bullBonus)},{l:'Efficiency',v:S.effPct+'%',c:S.effColor,s:S.effRank+' '+sig(S.effBonus)},{l:'Heartbeat',v:S.hbStd?'œÉ'+S.hbStd+'ms':'‚Äî',c:S.hbColor,s:S.hbRank+' '+sig(S.hbBonus)},{l:'Recovery',v:roundMisses===0?'CLEAN':S.recCount+'/'+roundMisses,c:S.recColor,s:S.recRank+' '+sig(S.recBonus)}].forEach(c=>{const d=document.createElement('div');d.className='stat-card';d.innerHTML=`<div class="stat-card-label">${c.l}</div><div class="stat-card-value" style="color:${c.c}">${c.v}</div>${c.s?`<div class="stat-card-sub" style="color:${c.c}">${c.s}</div>`:''}`;g.appendChild(d)});
  $('nextRoundBtn').textContent=currentRound>=totalRounds?'VIEW RESULTS':'NEXT ROUND';
}

function showFinalResults(){
  showScreen('finalScreen');
  // Populate match info
  if(demoMode){
    $('finalMatchInfo').textContent='AI DEMO ‚Äî Levels 1, 5, 10, 15, 20, 25';$('finalMatchInfo').style.color='var(--pink)';
  }else{
    const lc=getLevelColor(level);const desc=getLevelDesc(level).split('‚Ä¢')[0].trim();
    $('finalMatchInfo').innerHTML='Level <span style="color:'+lc+';font-family:Orbitron,sans-serif;font-weight:700">'+level+'</span> ‚Äî '+desc+' ‚Äî '+totalRounds+' Rounds';$('finalMatchInfo').style.color='rgba(255,255,255,.5)';
  }
  let tH=0,tM=0,tT=0,mC=0,allP=[],allS=[],allF=[],allE=[],allPa=[],allHB=[],bC=0,bBC=0,bFB=Infinity;
  roundHistory.forEach(r=>{const s=r.S;tH+=r.hits;tM+=r.misses;tT+=r.targetCount;if(r.mathCorrect)mC++;if(s.avgPrec>0&&r.hits>0)for(let i=0;i<r.hits;i++)allP.push(s.avgPrec);if(s.avgSpd>0&&r.hits>0)for(let i=0;i<r.hits;i++)allS.push(s.avgSpd);if(s.flickAvg>0)allF.push(s.flickAvg);allE.push(s.effPct);allPa.push(s.pathPct);if(s.hbStd>0)allHB.push(s.hbStd);if(r.maxCombo>bC)bC=r.maxCombo;if(s.bullMax>bBC)bBC=s.bullMax;if(s.fbMs>0&&s.fbMs<bFB)bFB=s.fbMs});if(bFB===Infinity)bFB=0;
  const tSh=tH+tM,hR=tSh>0?Math.round(tH/tSh*100):0,aP=allP.length?Math.round(allP.reduce((a,b)=>a+b,0)/allP.length):0,aS=allS.length?Math.round(allS.reduce((a,b)=>a+b,0)/allS.length):0,aF=allF.length?Math.round(allF.reduce((a,b)=>a+b,0)/allF.length):0,aE=allE.length?Math.round(allE.reduce((a,b)=>a+b,0)/allE.length):0,aPa=allPa.length?Math.round(allPa.reduce((a,b)=>a+b,0)/allPa.length):0,aHB=allHB.length?Math.round(allHB.reduce((a,b)=>a+b,0)/allHB.length):0;
  const cR=clutchOpportunities>0?Math.round((clutchMathCount+clutchShotCount)/clutchOpportunities*100):0;let cB=cR>=80?200:cR>=50?80:cR>=25?30:clutchOpportunities>0?-30:0;score+=cB;
  const cRk=cR>=80?'ICE VEINS':cR>=50?'CLUTCH':cR>=25?'TRIES':clutchOpportunities>0?'CHOKES':'NONE',cCl=cR>=80?'var(--pink)':cR>=50?'var(--green)':cR>=25?'var(--yellow)':clutchOpportunities>0?'var(--red)':'var(--cyan)';
  const half=Math.floor(roundHistory.length/2);let eM=1,eRk='‚Äî',eCl='var(--cyan)';
  if(half>=2){const f=roundHistory.slice(0,half),s2=roundHistory.slice(half);const a1=f.reduce((s,r)=>s+r.S.total,0)/f.length,a2=s2.reduce((s,r)=>s+r.S.total,0)/s2.length;const imp=a2/(a1||1);if(imp>=1.2){eM=1.4;eRk='IRONMAN';eCl='var(--pink)'}else if(imp>=1.05){eM=1.2;eRk='ENDURING';eCl='var(--green)'}else if(imp>=.95){eM=1;eRk='STEADY';eCl='var(--yellow)'}else if(imp>=.8){eM=.9;eRk='FATIGUED';eCl='var(--orange)'}else{eM=.75;eRk='COLLAPSED';eCl='var(--red)'}}
  score=Math.round(score*eM);
  const pb=getPersonalBest();let gD=0,gRk='1ST RUN',gCl='var(--green)';
  if(pb){gD=score-pb.score;if(gD>0){gRk='NEW RECORD!';gCl='var(--pink)';score+=500;setPersonalBest({score})}else if(gD===0){gRk='TIED';gCl='var(--yellow)'}else{gRk='BELOW BEST';gCl='var(--red)'}}else setPersonalBest({score});
  const mPct=mC/totalRounds,hPct=tT>0?tH/tT:0,pN=aP/100,sN=aS>0?Math.max(0,1-aS/2000):0,cN=Math.min(1,bC/10),eN=aE/100,edN=eM>=1.2?1:eM>=1?.7:eM>=.9?.5:.2,clN=cR/100;
  const mastery=Math.round(mPct*150+hPct*150+pN*200+sN*150+cN*100+eN*100+edN*100+clN*50);
  const mG=mastery>=950?'S+':mastery>=850?'S':mastery>=750?'A':mastery>=600?'B':mastery>=400?'C':mastery>=200?'D':'F';
  $('finalScoreBig').textContent=score.toLocaleString();const mf=$('masteryFill');mf.style.width=Math.min(100,mastery/10)+'%';mf.style.background=mastery>=800?'linear-gradient(90deg,var(--cyan),var(--pink))':mastery>=600?'linear-gradient(90deg,var(--green),var(--cyan))':mastery>=400?'var(--yellow)':'var(--red)';$('masteryLabel').textContent=`MASTERY: ${mastery}/1000 ‚Äî GRADE: ${mG}`;
  const mg=$('finalMetricsGrid');mg.innerHTML='';
  [{t:'Hit Rate',v:hR+'%',c:hR>=90?'var(--pink)':hR>=70?'var(--green)':hR>=50?'var(--yellow)':'var(--red)',r:hR>=90?'LETHAL':hR>=70?'ACCURATE':hR>=50?'FAIR':'POOR'},{t:'Math',v:mC+'/'+totalRounds,c:mPct>=.9?'var(--pink)':mPct>=.7?'var(--green)':mPct>=.5?'var(--yellow)':'var(--red)',r:mPct>=.9?'GENIUS':mPct>=.7?'SHARP':mPct>=.5?'OKAY':'WEAK'},{t:'Precision',v:aP+'%',c:aP>=90?'var(--pink)':aP>=70?'var(--green)':aP>=50?'var(--yellow)':'var(--red)',r:aP>=90?'DEAD CENTER':aP>=70?'SHARP':aP>=50?'FAIR':'WILD'},{t:'Avg Speed',v:aS?aS+'ms':'‚Äî',c:aS&&aS<=300?'var(--pink)':aS<=500?'var(--green)':aS<=800?'var(--yellow)':'var(--red)',r:aS<=300?'BLAZING':aS<=500?'FAST':aS<=800?'MODERATE':'SLOW'},{t:'Best Combo',v:bC+'x',c:bC>=10?'var(--pink)':bC>=5?'var(--green)':bC>=3?'var(--yellow)':'var(--red)',r:bC>=10?'LEGENDARY':bC>=5?'ON FIRE':bC>=3?'HOT':'COLD'},{t:'Avg Flick',v:aF+'px/s',c:aF>=1500?'var(--pink)':aF>=800?'var(--green)':aF>=200?'var(--yellow)':'var(--orange)',r:aF>=1500?'INHUMAN':aF>=800?'LIGHTNING':aF>=200?'FLICK':'SNIPE'},{t:'Best 1st Blood',v:bFB?bFB+'ms':'‚Äî',c:bFB&&bFB<=200?'var(--pink)':bFB<=500?'var(--green)':bFB<=1000?'var(--yellow)':'var(--red)',r:bFB<=200?'REFLEX GOD':bFB<=500?'QUICK DRAW':bFB<=1000?'ALERT':'SLOW'},{t:'Bullseye',v:bBC+'x',c:bBC>=5?'var(--pink)':bBC>=3?'var(--green)':bBC>=1?'var(--yellow)':'var(--red)',r:bBC>=5?'DIAMOND EYE':bBC>=3?'SHARPSHOOTER':bBC>=1?'FOCUSED':'NONE'},{t:'Efficiency',v:aE+'%',c:aE>=95?'var(--pink)':aE>=80?'var(--green)':aE>=60?'var(--yellow)':'var(--red)',r:aE>=95?'SURGICAL':aE>=80?'PRECISE':aE>=60?'DECENT':'SLOPPY'},{t:'Path Eff',v:aPa+'%',c:aPa>=90?'var(--pink)':aPa>=70?'var(--green)':aPa>=50?'var(--yellow)':'var(--red)',r:aPa>=90?'LASER':aPa>=70?'CLEAN':aPa>=50?'OK':'WANDER'},{t:'Heartbeat',v:aHB?'œÉ'+aHB+'ms':'‚Äî',c:aHB&&aHB<100?'var(--pink)':aHB<200?'var(--green)':aHB<300?'var(--yellow)':'var(--red)',r:aHB<100?'METRONOME':aHB<200?'STEADY':aHB<300?'OK':'ERRATIC'},{t:'Endurance',v:'√ó'+eM.toFixed(2),c:eCl,r:eRk},{t:'Clutch',v:cR+'%',c:cCl,r:cRk},{t:'Ghost',v:pb&&gD!==undefined?(gD>=0?'+':'')+gD:'1ST',c:gCl,r:gRk},{t:'Mastery',v:mG,c:mastery>=850?'var(--cyan)':mastery>=600?'var(--green)':mastery>=400?'var(--yellow)':'var(--red)',r:mastery+'/1000'}].forEach(m=>{const d=document.createElement('div');d.className='fm-card';d.innerHTML=`<div class="fm-title">${m.t}</div><div class="fm-value" style="color:${m.c}">${m.v}</div><div class="fm-rank" style="color:${m.c}">${m.r}</div>`;mg.appendChild(d)});
  const tb=$('breakdownBody');tb.innerHTML='';roundHistory.forEach(r=>{const s=r.S,tr=document.createElement('tr');tr.innerHTML=`<td>${r.round}</td><td style="color:${r.mathCorrect?'var(--green)':'var(--red)'}">${r.mathCorrect?'‚úì':'‚úó'}</td><td>${r.mathCorrect?r.hits+'/'+r.targetCount:'‚Äî'}</td><td style="color:${s.precColor}">${s.avgPrec}%</td><td style="color:${s.spdColor}">${s.avgSpd||'‚Äî'}</td><td style="color:${s.streakColor}">${r.maxCombo}x</td><td style="color:${s.flickColor}">${s.flickRank}</td><td style="color:${s.effColor}">${s.effPct}%</td><td style="color:${r.misses>0?'var(--red)':'var(--green)'}">${r.misses}</td><td style="color:var(--cyan)">${s.total}</td>`;tb.appendChild(tr)});
  if(demoMode){$('demoBanner').classList.remove('visible');demoMode=false;demoActive=false}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UTILITIES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function randFloat(a,b){return Math.random()*(b-a)+a}
function lerp(a,b,t){return a+(b-a)*Math.max(0,Math.min(1,t))}
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=randInt(0,i);[a[i],a[j]]=[a[j],a[i]]}return a}
document.addEventListener('contextmenu',e=>{if(shootingActive)e.preventDefault()});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SAVE SCORE SCREENSHOT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
$('saveScoreBtn').addEventListener('click',saveScoreScreenshot);
function saveScoreScreenshot(){
  const btn=$('saveScoreBtn');
  const origText=btn.textContent;
  btn.textContent='SAVING...';btn.style.pointerEvents='none';
  
  // Hide buttons and exit btn during capture
  const btnsDiv=document.querySelector('.final-buttons');
  const exitB=$('exitBtn');
  btnsDiv.style.display='none';exitB.style.display='none';
  
  const el=$('finalScreen');
  // Temporarily make finalScreen fill content naturally for capture
  const origStyles={position:el.style.position,overflow:el.style.overflow,height:el.style.height};
  el.style.position='relative';el.style.overflow='visible';el.style.height='auto';
  
  // Use canvas to render
  const W=960,pad=40;
  const c=document.createElement('canvas');const ctx=c.getContext('2d');
  
  // Resolve CSS variables
  const cs=getComputedStyle(document.documentElement);
  function resolveColor(col){
    if(!col)return'#ffffff';
    const m=col.match(/var\(--(\w+)\)/);
    if(m)return cs.getPropertyValue('--'+m[1]).trim();
    return col;
  }
  
  // Gather data from the DOM
  const title=$('finalScreen').querySelector('.final-title').textContent;
  const scoreBig=$('finalScoreBig').textContent;
  const masteryText=$('masteryLabel').textContent;
  const masteryFillW=parseFloat($('masteryFill').style.width)||0;
  const masteryBg=$('masteryFill').style.background||'var(--cyan)';
  
  // Metric cards
  const cards=[...document.querySelectorAll('#finalMetricsGrid .fm-card')].map(cd=>({
    t:cd.querySelector('.fm-title').textContent,
    v:cd.querySelector('.fm-value').textContent,
    vc:cd.querySelector('.fm-value').style.color,
    r:cd.querySelector('.fm-rank').textContent,
    rc:cd.querySelector('.fm-rank').style.color
  }));
  
  // Round breakdown rows
  const rows=[...document.querySelectorAll('#breakdownBody tr')].map(tr=>{
    const tds=[...tr.querySelectorAll('td')];
    return tds.map(td=>({text:td.textContent,color:td.style.color||'rgba(255,255,255,.7)'}));
  });
  const headers=[...document.querySelectorAll('.breakdown-table thead th')].map(th=>th.textContent);
  
  // Calculate dimensions
  const cardW=108,cardH=70,cardGap=8,cardsPerRow=Math.min(5,Math.floor((W-pad*2+cardGap)/(cardW+cardGap)));
  const cardRows=Math.ceil(cards.length/cardsPerRow);
  const rowH=22,headerH=24;
  
  let H=pad+50+80+40+20+30+(cardRows*(cardH+cardGap))+30+headerH+(rows.length*rowH)+pad+40;
  
  c.width=W;c.height=H;
  
  // Background
  ctx.fillStyle='#0a0a1a';ctx.fillRect(0,0,W,H);
  // Grid overlay
  ctx.strokeStyle='rgba(0,240,255,.03)';ctx.lineWidth=1;
  for(let x=0;x<W;x+=60){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke()}
  for(let y=0;y<H;y+=60){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke()}
  // Subtle glow
  const grd=ctx.createRadialGradient(W*.3,H*.3,0,W*.3,H*.3,W*.6);
  grd.addColorStop(0,'rgba(0,240,255,.04)');grd.addColorStop(1,'transparent');
  ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);
  
  let y=pad;
  
  // Title
  ctx.font='900 28px Orbitron,sans-serif';ctx.textAlign='center';
  const tGrd=ctx.createLinearGradient(W*.3,y,W*.7,y);
  tGrd.addColorStop(0,'#00f0ff');tGrd.addColorStop(1,'#39ff14');
  ctx.fillStyle=tGrd;ctx.fillText(title,W/2,y+28);
  y+=50;
  
  // Big score
  ctx.font='900 64px Orbitron,sans-serif';ctx.fillStyle='#ffffff';
  ctx.shadowColor='rgba(0,240,255,.4)';ctx.shadowBlur=30;
  ctx.fillText(scoreBig,W/2,y+58);
  ctx.shadowBlur=0;
  y+=70;
  
  // "TOTAL SCORE" label
  ctx.font='13px "Share Tech Mono",monospace';ctx.fillStyle='rgba(255,255,255,.4)';ctx.letterSpacing='4px';
  ctx.fillText('TOTAL SCORE',W/2,y+13);
  y+=30;
  
  // Mastery bar
  const barW=400,barH=10,barX=(W-barW)/2;
  ctx.fillStyle='rgba(255,255,255,.06)';
  ctx.beginPath();ctx.roundRect(barX,y,barW,barH,5);ctx.fill();
  // Fill
  const fillW=barW*(masteryFillW/100);
  if(fillW>0){
    let barGrd;
    if(masteryBg.includes('pink')){barGrd=ctx.createLinearGradient(barX,0,barX+fillW,0);barGrd.addColorStop(0,'#00f0ff');barGrd.addColorStop(1,'#ff2d95')}
    else if(masteryBg.includes('green')){barGrd=ctx.createLinearGradient(barX,0,barX+fillW,0);barGrd.addColorStop(0,'#39ff14');barGrd.addColorStop(1,'#00f0ff')}
    else if(masteryBg.includes('yellow')){barGrd='#ffe600'}
    else{barGrd='#ff003c'}
    ctx.fillStyle=barGrd;
    ctx.beginPath();ctx.roundRect(barX,y,fillW,barH,5);ctx.fill();
  }
  y+=barH+6;
  ctx.font='11px "Share Tech Mono",monospace';ctx.fillStyle='rgba(255,255,255,.4)';
  ctx.fillText(masteryText,W/2,y+11);
  y+=26;
  
  // Metric cards
  const gridW=cardsPerRow*(cardW+cardGap)-cardGap;
  const gridX=(W-gridW)/2;
  cards.forEach((cd,i)=>{
    const col=i%cardsPerRow,row=Math.floor(i/cardsPerRow);
    const cx=gridX+col*(cardW+cardGap),cy=y+row*(cardH+cardGap);
    // Card bg
    ctx.fillStyle='rgba(10,10,30,.92)';ctx.strokeStyle='rgba(255,255,255,.06)';ctx.lineWidth=1;
    ctx.beginPath();ctx.roundRect(cx,cy,cardW,cardH,8);ctx.fill();ctx.stroke();
    // Title
    ctx.font='8px "Share Tech Mono",monospace';ctx.fillStyle='rgba(255,255,255,.3)';ctx.textAlign='center';
    ctx.fillText(cd.t.toUpperCase(),cx+cardW/2,cy+14);
    // Value
    ctx.font='900 18px Orbitron,sans-serif';ctx.fillStyle=resolveColor(cd.vc);
    ctx.fillText(cd.v,cx+cardW/2,cy+36);
    // Rank
    ctx.font='9px "Share Tech Mono",monospace';ctx.fillStyle=resolveColor(cd.rc);
    ctx.fillText(cd.r,cx+cardW/2,cy+50);
  });
  y+=cardRows*(cardH+cardGap)+20;
  
  // Breakdown title
  ctx.font='12px "Share Tech Mono",monospace';ctx.fillStyle='rgba(255,255,255,.35)';ctx.textAlign='center';
  ctx.fillText('ROUND BREAKDOWN',W/2,y+12);
  y+=24;
  
  // Table headers
  const colW=(W-pad*2)/headers.length;
  const tableX=pad;
  ctx.font='9px "Share Tech Mono",monospace';ctx.fillStyle='rgba(255,255,255,.3)';
  headers.forEach((h,i)=>{ctx.textAlign='center';ctx.fillText(h.toUpperCase(),tableX+i*colW+colW/2,y+10)});
  ctx.strokeStyle='rgba(255,255,255,.08)';ctx.beginPath();ctx.moveTo(tableX,y+headerH-4);ctx.lineTo(W-pad,y+headerH-4);ctx.stroke();
  y+=headerH;
  
  // Table rows
  rows.forEach(row=>{
    row.forEach((cell,i)=>{
      ctx.font='600 13px Rajdhani,sans-serif';
      ctx.fillStyle=resolveColor(cell.color);ctx.textAlign='center';
      ctx.fillText(cell.text,tableX+i*colW+colW/2,y+15);
    });
    ctx.strokeStyle='rgba(255,255,255,.04)';ctx.beginPath();ctx.moveTo(tableX,y+rowH-2);ctx.lineTo(W-pad,y+rowH-2);ctx.stroke();
    y+=rowH;
  });
  
  // Footer watermark
  y+=16;
  ctx.font='10px "Share Tech Mono",monospace';ctx.fillStyle='rgba(255,255,255,.2)';ctx.textAlign='center';
  ctx.fillText('MATH AIM ‚Äî SOLVE & SHOOT',W/2,y+10);
  
  // Download
  c.toBlob(blob=>{
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download='MATH_AIM_Score_'+Date.now()+'.png';
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
    // Restore
    btnsDiv.style.display='';exitB.style.display='';
    el.style.position=origStyles.position;el.style.overflow=origStyles.overflow;el.style.height=origStyles.height;
    btn.textContent='‚úì SAVED';btn.style.color='var(--green)';btn.style.borderColor='var(--green)';
    setTimeout(()=>{btn.textContent=origText;btn.style.color='';btn.style.borderColor='';btn.style.pointerEvents=''},2000);
  },'image/png');
}
</script>
</body>
</html>
