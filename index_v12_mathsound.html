<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MATH AIM — Solve & Shoot</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{--cyan:#00f0ff;--pink:#ff2d95;--green:#39ff14;--yellow:#ffe600;--orange:#ff6b00;--red:#ff003c;--purple:#9b30ff;--deepPurple:#6a0dad;--bg:#060612;--panel:rgba(10,10,30,0.92);--border:rgba(0,240,255,0.3)}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:'Rajdhani',sans-serif;color:#e0e8ff;cursor:default;user-select:none;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 30%,rgba(155,48,255,.15) 0%,transparent 50%),radial-gradient(ellipse at 80% 20%,rgba(0,240,255,.12) 0%,transparent 45%),radial-gradient(ellipse at 50% 90%,rgba(106,13,173,.12) 0%,transparent 50%),radial-gradient(ellipse at 15% 80%,rgba(0,240,255,.08) 0%,transparent 40%);z-index:0;pointer-events:none}
body::after{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(155,48,255,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,240,255,.04) 1px,transparent 1px);background-size:60px 60px;z-index:0;pointer-events:none}
.screen{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;z-index:10;overflow-y:auto;padding:10px 10px}
.screen.active{display:flex}
.screen::before,.screen::after{content:'';flex:1 1 0px;min-height:0}
.exit-btn{position:fixed;top:14px;right:20px;z-index:200;font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:3px;text-transform:uppercase;padding:8px 16px;background:rgba(155,48,255,.04);border:1px solid rgba(155,48,255,.2);color:rgba(155,48,255,.5);border-radius:4px;cursor:pointer;transition:all .2s;display:none}.exit-btn:hover{background:rgba(255,0,60,.1);border-color:var(--red);color:var(--red)}.exit-btn.visible{display:block}
#menuScreen{gap:8px}
.game-title{font-family:'Orbitron',sans-serif;font-size:clamp(32px,6vw,56px);font-weight:900;letter-spacing:8px;text-align:center;background:linear-gradient(135deg,var(--purple),var(--cyan),var(--purple),var(--cyan));background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:gradShift 6s ease infinite;filter:drop-shadow(0 0 40px rgba(155,48,255,.6)) drop-shadow(0 0 20px rgba(0,240,255,.5));line-height:1}
.game-subtitle{font-family:'Share Tech Mono',monospace;font-size:clamp(10px,1.3vw,13px);color:rgba(155,48,255,.8);letter-spacing:7px;text-transform:uppercase;margin-top:-2px;text-shadow:0 0 10px rgba(155,48,255,.4)}
@keyframes gradShift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.title-row{display:flex;align-items:center;justify-content:center;gap:8px}
.title-center{display:flex;flex-direction:column;align-items:center}
.title-numeral{height:clamp(40px,6vw,60px);width:auto;opacity:.4;filter:drop-shadow(0 0 8px rgba(0,240,255,.3))}
.title-numeral-left{transform:scaleX(-1)}
.menu-divider{width:clamp(280px,80vw,480px);height:1px;background:linear-gradient(90deg,transparent,rgba(155,48,255,.6),rgba(0,240,255,.7),rgba(155,48,255,.6),transparent);margin:2px 0;flex-shrink:0}
.ff-ornament{display:flex;align-items:center;gap:8px;margin:0}
.ff-ornament::before,.ff-ornament::after{content:'';width:clamp(60px,15vw,120px);height:1px;background:linear-gradient(90deg,transparent,rgba(155,48,255,.7))}
.ff-ornament::after{background:linear-gradient(90deg,rgba(155,48,255,.7),transparent)}
.ff-diamond{width:8px;height:8px;background:linear-gradient(135deg,var(--purple),var(--cyan));transform:rotate(45deg);box-shadow:0 0 12px rgba(155,48,255,.7),0 0 24px rgba(0,240,255,.3);flex-shrink:0}
.version-badge{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:rgba(155,48,255,.5);text-transform:uppercase;text-shadow:0 0 6px rgba(155,48,255,.3)}
.brand-bar{display:flex;flex-direction:column;align-items:center;gap:1px;margin-top:2px;position:relative}
.brand-name{font-family:'Orbitron',sans-serif;font-size:clamp(18px,3.5vw,28px);font-weight:900;letter-spacing:10px;text-transform:uppercase;background:linear-gradient(135deg,var(--purple),var(--cyan),var(--purple),var(--cyan));background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:gradShift 6s ease infinite;filter:drop-shadow(0 0 20px rgba(155,48,255,.6)) drop-shadow(0 0 10px rgba(0,240,255,.4))}
.brand-sub{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(155,48,255,.6);letter-spacing:5px;text-transform:uppercase;text-shadow:0 0 8px rgba(155,48,255,.3)}
.brand-logo{width:clamp(200px,50vw,380px);height:auto;filter:drop-shadow(0 0 12px rgba(155,48,255,.3)) drop-shadow(0 0 25px rgba(0,240,255,.15));margin-top:2px}
.level-select-container{display:flex;flex-direction:column;align-items:center;gap:2px}
.level-label{font-family:'Share Tech Mono',monospace;font-size:13px;color:rgba(155,48,255,.7);letter-spacing:4px;text-transform:uppercase}
.level-display{font-family:'Orbitron',sans-serif;font-size:30px;font-weight:900;color:var(--cyan);text-shadow:0 0 20px rgba(0,240,255,.4),0 0 40px rgba(155,48,255,.2);text-align:center;transition:color .3s,text-shadow .3s;line-height:1}
.level-task{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(0,240,255,.6);letter-spacing:3px;text-transform:uppercase;margin-top:-2px;transition:color .3s}
.level-slider-row{display:flex;align-items:center;gap:10px}
.level-slider{-webkit-appearance:none;appearance:none;width:clamp(200px,35vw,380px);height:5px;background:linear-gradient(90deg,var(--cyan),var(--purple),var(--pink));border-radius:3px;outline:none;cursor:pointer}
.level-slider::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;background:linear-gradient(135deg,var(--purple),var(--cyan));border-radius:50%;box-shadow:0 0 12px rgba(155,48,255,.6),0 0 24px rgba(0,240,255,.3);cursor:pointer}
.level-slider::-moz-range-thumb{width:22px;height:22px;background:linear-gradient(135deg,var(--purple),var(--cyan));border:none;border-radius:50%;box-shadow:0 0 12px rgba(155,48,255,.6),0 0 24px rgba(0,240,255,.3);cursor:pointer}
.slider-end-label{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(155,48,255,.5);letter-spacing:2px;text-transform:uppercase;min-width:40px}.slider-end-label:first-child{text-align:right}
.difficulty-desc{font-family:'Share Tech Mono',monospace;font-size:12px;min-height:16px;letter-spacing:1px;transition:color .3s}
.rounds-row{display:flex;align-items:center;gap:14px}
.rounds-label{font-family:'Share Tech Mono',monospace;font-size:14px;color:rgba(155,48,255,.55);letter-spacing:3px;text-transform:uppercase}
.rounds-btn{background:transparent;border:1px solid rgba(0,240,255,.3);color:var(--cyan);font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700;width:48px;height:48px;border-radius:8px;cursor:pointer;transition:all .2s}.rounds-btn:hover{background:rgba(0,240,255,.1)}.rounds-btn.selected{background:rgba(0,240,255,.15);border-color:var(--cyan);box-shadow:0 0 12px rgba(0,240,255,.3)}
.target-cap-container{display:flex;flex-direction:column;align-items:center;gap:2px;margin-top:0}
.cap-value{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;color:var(--yellow);text-shadow:0 0 15px rgba(255,230,0,.3);text-align:center;line-height:1}
.cap-slider{-webkit-appearance:none;appearance:none;width:clamp(180px,28vw,300px);height:5px;background:linear-gradient(90deg,var(--cyan),var(--purple));border-radius:3px;outline:none;cursor:pointer}
.cap-slider::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:linear-gradient(135deg,var(--purple),var(--cyan));border-radius:50%;box-shadow:0 0 10px rgba(155,48,255,.5);cursor:pointer}
.cap-slider::-moz-range-thumb{width:20px;height:20px;background:linear-gradient(135deg,var(--purple),var(--cyan));border:none;border-radius:50%;box-shadow:0 0 10px rgba(155,48,255,.5);cursor:pointer}
.cap-max-row{display:flex;align-items:center;gap:4px}
.cap-max-label{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(155,48,255,.45);letter-spacing:1px;text-transform:uppercase}
.cap-max-input{font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700;color:var(--yellow);background:rgba(155,48,255,.04);border:1px solid rgba(155,48,255,.15);border-radius:4px;padding:2px 6px;width:56px;text-align:center;outline:none;transition:all .2s;-moz-appearance:textfield}
.cap-max-input::-webkit-outer-spin-button,.cap-max-input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
.cap-max-input:focus{border-color:var(--purple);box-shadow:0 0 12px rgba(155,48,255,.15)}
.cap-desc{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(155,48,255,.4);letter-spacing:1px;text-align:center;max-width:360px}
.start-btn,.demo-btn{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;letter-spacing:5px;text-transform:uppercase;padding:12px 40px;background:linear-gradient(135deg,rgba(155,48,255,.08),rgba(0,240,255,.06));border:2px solid;border-image:linear-gradient(135deg,var(--purple),var(--cyan)) 1;color:var(--cyan);cursor:pointer;transition:all .3s;position:relative}
.start-btn:hover{background:linear-gradient(135deg,rgba(155,48,255,.2),rgba(0,240,255,.15));box-shadow:0 0 30px rgba(155,48,255,.25),0 0 60px rgba(0,240,255,.15),inset 0 0 20px rgba(155,48,255,.05);transform:translateY(-2px)}
.demo-btn{font-size:12px;padding:9px 26px;letter-spacing:3px;border-image:linear-gradient(135deg,var(--purple),var(--pink)) 1;color:var(--purple)}
.demo-btn:hover{background:linear-gradient(135deg,rgba(155,48,255,.15),rgba(255,45,149,.1));box-shadow:0 0 25px rgba(155,48,255,.2),0 0 50px rgba(255,45,149,.1);transform:translateY(-2px);color:var(--pink)}
.menu-buttons{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center;margin-top:4px}
#mathScreen{gap:0;padding:20px}
.math-hud{display:flex;justify-content:space-between;align-items:center;width:100%;max-width:900px;padding:0 20px;margin-bottom:16px}
.hud-item{display:flex;flex-direction:column;align-items:center;gap:2px}
.hud-label{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(155,48,255,.5);letter-spacing:3px;text-transform:uppercase}
.hud-value{font-family:'Orbitron',sans-serif;font-size:26px;font-weight:700;color:var(--cyan)}
.timer-ring-container{position:relative;width:140px;height:140px;margin:6px 0 12px}
.timer-ring{width:100%;height:100%;transform:rotate(-90deg)}
.timer-ring-bg{fill:none;stroke:rgba(255,255,255,.06);stroke-width:6}
.timer-ring-fill{fill:none;stroke:var(--green);stroke-width:6;stroke-linecap:round;stroke-dasharray:440;stroke-dashoffset:440;transition:stroke .5s;filter:drop-shadow(0 0 6px currentColor)}
.timer-text{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.timer-seconds{font-family:'Orbitron',sans-serif;font-size:38px;font-weight:900;color:var(--green);transition:color .5s}
.timer-label{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:rgba(155,48,255,.45);text-transform:uppercase;margin-top:-2px}
.pressure-badge{font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:2px;margin-top:4px;padding:4px 12px;border-radius:4px;border:1px solid}
.math-question-box{background:var(--panel);border:1px solid rgba(155,48,255,.2);border-radius:12px;padding:26px 44px;margin-bottom:16px;text-align:center;min-width:350px;max-width:700px;box-shadow:0 0 40px rgba(155,48,255,.05),0 0 20px rgba(0,240,255,.03)}
.math-question{font-family:'Share Tech Mono',monospace;font-size:clamp(24px,4vw,40px);color:#fff;letter-spacing:2px;line-height:1.4}
.answers-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;width:100%;max-width:500px}
.answer-btn{font-family:'Orbitron',sans-serif;font-size:22px;font-weight:700;padding:18px 24px;background:rgba(155,48,255,.03);border:2px solid rgba(155,48,255,.15);color:#c0c8e0;border-radius:8px;cursor:pointer;transition:all .2s}.answer-btn:hover{border-color:var(--cyan);color:var(--cyan);background:rgba(0,240,255,.06)}.answer-btn.correct{border-color:var(--green);color:var(--green);background:rgba(57,255,20,.1)}.answer-btn.wrong{border-color:var(--red);color:var(--red);background:rgba(255,0,60,.1)}
#shootScreen{cursor:crosshair;touch-action:none}
.shoot-canvas-container{position:fixed;inset:0;z-index:5}
#shootCanvas{width:100%;height:100%;display:block;touch-action:none}
.shoot-hud{position:fixed;top:0;left:0;right:0;display:flex;justify-content:center;align-items:center;gap:20px;flex-wrap:wrap;padding:10px 20px;background:linear-gradient(180deg,rgba(0,0,0,.75) 0%,transparent 100%);z-index:20;pointer-events:none}
.shoot-hud-item{font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:1px;color:rgba(200,180,255,.65)}.shoot-hud-item span{font-family:'Orbitron',sans-serif;font-weight:700;color:var(--cyan);font-size:16px}
.combo-display{position:fixed;top:60px;left:50%;transform:translateX(-50%);font-family:'Orbitron',sans-serif;font-size:28px;font-weight:900;z-index:25;pointer-events:none;opacity:0;transition:all .3s;text-shadow:0 0 20px currentColor}.combo-display.visible{opacity:1}
.shoot-center-msg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Orbitron',sans-serif;font-size:clamp(36px,6vw,72px);font-weight:900;letter-spacing:6px;z-index:25;pointer-events:none;opacity:0;transition:opacity .3s}.shoot-center-msg.visible{opacity:1}
#roundResultScreen{gap:12px;padding:20px;overflow-y:auto;justify-content:center;align-items:center}
.round-result-title{font-family:'Orbitron',sans-serif;font-size:24px;font-weight:900;letter-spacing:4px;color:var(--cyan);text-shadow:0 0 20px rgba(155,48,255,.3),0 0 10px rgba(0,240,255,.3);margin-bottom:8px;flex-shrink:0}
.round-stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;max-width:720px;width:100%;flex-shrink:0}
.stat-card{background:rgba(155,48,255,.04);border:1px solid rgba(155,48,255,.08);border-radius:10px;padding:8px 5px;text-align:center}
.stat-card-label{font-family:'Share Tech Mono',monospace;font-size:8px;color:rgba(155,48,255,.5);letter-spacing:2px;text-transform:uppercase;margin-bottom:2px}
.stat-card-value{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:900}
.stat-card-sub{font-family:'Share Tech Mono',monospace;font-size:7px;margin-top:1px;letter-spacing:1px}
.next-round-btn{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;letter-spacing:4px;padding:14px 44px;background:linear-gradient(135deg,rgba(155,48,255,.06),rgba(0,240,255,.04));border:2px solid;border-image:linear-gradient(135deg,var(--purple),var(--cyan)) 1;color:var(--cyan);cursor:pointer;transition:all .3s;margin-top:6px;flex-shrink:0}.next-round-btn:hover{background:rgba(0,240,255,.1);box-shadow:0 0 20px rgba(155,48,255,.2)}
#finalScreen{gap:10px;padding:20px;overflow-y:auto;justify-content:flex-start;padding-top:50px}
.final-title{font-family:'Orbitron',sans-serif;font-size:clamp(22px,4vw,36px);font-weight:900;letter-spacing:4px;background:linear-gradient(135deg,var(--purple),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 15px rgba(155,48,255,.3));flex-shrink:0}
.final-match-info{font-family:'Share Tech Mono',monospace;font-size:14px;letter-spacing:3px;text-transform:uppercase;color:rgba(155,48,255,.55);margin-top:-2px;flex-shrink:0}
.final-score-big{font-family:'Orbitron',sans-serif;font-size:clamp(48px,8vw,80px);font-weight:900;color:#fff;text-shadow:0 0 40px rgba(155,48,255,.3),0 0 80px rgba(0,240,255,.15)}
.final-score-label{font-family:'Share Tech Mono',monospace;font-size:13px;color:rgba(155,48,255,.5);letter-spacing:4px;margin-top:-6px}
.mastery-bar{width:100%;max-width:500px;margin:4px 0}.mastery-bar-bg{width:100%;height:10px;background:rgba(255,255,255,.06);border-radius:5px;overflow:hidden}.mastery-bar-fill{height:100%;border-radius:5px;transition:width 1s ease}
.mastery-label{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(155,48,255,.5);letter-spacing:2px;text-align:center;margin-top:4px}
.final-metrics-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;width:100%;max-width:860px}
.fm-card{background:rgba(155,48,255,.04);border:1px solid rgba(155,48,255,.08);border-radius:8px;padding:10px 4px;text-align:center}
.fm-title{font-family:'Share Tech Mono',monospace;font-size:8px;color:rgba(155,48,255,.5);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.fm-value{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700}
.fm-rank{font-family:'Share Tech Mono',monospace;font-size:9px;margin-top:2px;letter-spacing:1px}
.round-breakdown{width:100%;max-width:920px;margin-top:6px}
.breakdown-title{font-family:'Share Tech Mono',monospace;font-size:12px;color:rgba(155,48,255,.4);letter-spacing:4px;text-transform:uppercase;text-align:center;margin-bottom:6px}
.breakdown-table{width:100%;border-collapse:collapse}
.breakdown-table th{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(155,48,255,.45);letter-spacing:1px;text-transform:uppercase;padding:5px 3px;border-bottom:1px solid rgba(155,48,255,.12);text-align:center}
.breakdown-table td{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;text-align:center;padding:4px 3px;border-bottom:1px solid rgba(155,48,255,.06);color:rgba(200,190,255,.75)}
.play-again-btn{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700;letter-spacing:4px;padding:14px 44px;background:linear-gradient(135deg,rgba(155,48,255,.08),rgba(255,45,149,.05));border:2px solid;border-image:linear-gradient(135deg,var(--purple),var(--pink)) 1;color:var(--pink);cursor:pointer;transition:all .3s}.play-again-btn:hover{background:rgba(255,45,149,.1);box-shadow:0 0 25px rgba(155,48,255,.2)}
.save-score-btn{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700;letter-spacing:4px;padding:14px 44px;background:linear-gradient(135deg,rgba(155,48,255,.06),rgba(0,240,255,.04));border:2px solid;border-image:linear-gradient(135deg,var(--purple),var(--cyan)) 1;color:var(--cyan);cursor:pointer;transition:all .3s}.save-score-btn:hover{background:rgba(0,240,255,.1);box-shadow:0 0 20px rgba(0,240,255,.2)}
.final-buttons{display:flex;gap:16px;align-items:center;flex-wrap:wrap;justify-content:center;margin:10px 0 30px}
.wrong-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px;z-index:100;background:rgba(6,6,18,.9)}.wrong-overlay.visible{display:flex}
.wrong-overlay-title{font-family:'Orbitron',sans-serif;font-size:48px;font-weight:900;color:var(--red);text-shadow:0 0 30px rgba(255,0,60,.5);letter-spacing:6px}
.wrong-overlay-sub{font-family:'Share Tech Mono',monospace;font-size:18px;color:rgba(200,180,255,.55)}
.muzzle-flash{position:fixed;pointer-events:none;z-index:50;width:30px;height:30px;border-radius:50%;background:radial-gradient(circle,rgba(255,255,200,.9) 0%,rgba(255,200,50,.4) 40%,transparent 70%);transform:translate(-50%,-50%);animation:flashOut .15s ease-out forwards}
@keyframes flashOut{0%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-50%) scale(2)}}

/* DEMO BANNER */
.demo-banner{position:fixed;bottom:0;left:0;right:0;z-index:300;text-align:center;padding:8px;background:linear-gradient(90deg,rgba(255,45,149,.15),rgba(0,240,255,.15),rgba(255,45,149,.15));border-top:2px solid var(--pink);pointer-events:none;display:none}
.demo-banner.visible{display:block}
.demo-banner-text{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;letter-spacing:6px;color:var(--pink);text-shadow:0 0 15px rgba(255,45,149,.5)}
.demo-banner-sub{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(155,48,255,.55);letter-spacing:2px;margin-top:2px}

/* ═══════════════ SOUND TAB ═══════════════ */
.sound-master-row{display:flex;align-items:center;gap:12px;width:100%}
.sound-vol-row{display:flex;align-items:center;gap:10px;width:100%}
.sound-vol-label{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(155,48,255,.6);letter-spacing:2px;text-transform:uppercase;min-width:50px}
.sound-vol-slider{-webkit-appearance:none;appearance:none;flex:1;height:4px;background:linear-gradient(90deg,var(--cyan),var(--purple));border-radius:2px;outline:none;cursor:pointer}
.sound-vol-slider::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;background:linear-gradient(135deg,var(--purple),var(--cyan));border-radius:50%;box-shadow:0 0 8px rgba(155,48,255,.5);cursor:pointer}
.sound-vol-slider::-moz-range-thumb{width:16px;height:16px;background:linear-gradient(135deg,var(--purple),var(--cyan));border:none;border-radius:50%;box-shadow:0 0 8px rgba(155,48,255,.5);cursor:pointer}
.sound-vol-val{font-family:'Orbitron',sans-serif;font-size:12px;font-weight:700;color:var(--cyan);min-width:32px;text-align:right}
.sound-section-label{font-family:'Orbitron',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--cyan);margin-top:6px;align-self:flex-start}
.sound-section-label.miss-label{color:var(--pink)}
.sound-assign-row{display:flex;gap:8px;width:100%;margin:4px 0}
.sound-assign-btn{font-family:'Orbitron',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;padding:6px 12px;border-radius:4px;cursor:pointer;transition:all .25s;flex:1;text-align:center;text-transform:uppercase}
.sound-assign-btn.hit-assign{background:rgba(0,240,255,.04);border:1px solid rgba(0,240,255,.2);color:rgba(0,240,255,.5)}
.sound-assign-btn.hit-assign.active{background:rgba(0,240,255,.12);border-color:var(--cyan);color:var(--cyan);box-shadow:0 0 12px rgba(0,240,255,.2)}
.sound-assign-btn.miss-assign{background:rgba(255,45,149,.04);border:1px solid rgba(255,45,149,.2);color:rgba(255,45,149,.5)}
.sound-assign-btn.miss-assign.active{background:rgba(255,45,149,.12);border-color:var(--pink);color:var(--pink);box-shadow:0 0 12px rgba(255,45,149,.2)}
.sound-current-row{display:flex;gap:10px;width:100%;margin-top:6px}
.sound-current{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--cyan);padding:4px 8px;border:1px solid rgba(0,240,255,.2);border-radius:3px;flex:1;text-align:center;background:rgba(0,240,255,.04)}
.sound-current.miss-current{color:var(--pink);border-color:rgba(255,45,149,.2);background:rgba(255,45,149,.04)}
.sound-current-label{font-weight:700;letter-spacing:2px}
.sound-grid-wrapper{max-height:260px;overflow-y:auto;width:100%;border:1px solid rgba(155,48,255,.1);border-radius:4px;padding:6px 6px 14px;scrollbar-width:thin;scrollbar-color:rgba(155,48,255,.3) rgba(10,6,30,.4)}
.sound-grid-wrapper::-webkit-scrollbar{width:6px}
.sound-grid-wrapper::-webkit-scrollbar-track{background:rgba(10,6,30,.4);border-radius:3px}
.sound-grid-wrapper::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--purple),var(--cyan));border-radius:3px}
.sound-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;width:100%}
.sound-card{background:rgba(10,10,30,.6);border:1px solid rgba(155,48,255,.15);border-radius:4px;padding:8px 10px;cursor:pointer;transition:all .25s;display:flex;align-items:center;gap:8px}
.sound-card:hover{border-color:rgba(0,240,255,.4);box-shadow:0 0 12px rgba(0,240,255,.1)}
.sound-card.selected-hit{border-color:var(--cyan);box-shadow:0 0 15px rgba(0,240,255,.2);background:rgba(0,240,255,.05)}
.sound-card.selected-miss{border-color:var(--pink);box-shadow:0 0 15px rgba(255,45,149,.2);background:rgba(255,45,149,.05)}
.sound-card.selected-hit.selected-miss{border-image:linear-gradient(135deg,var(--cyan),var(--pink)) 1;box-shadow:0 0 15px rgba(155,48,255,.2);background:rgba(155,48,255,.05)}
.sound-card-icon{font-size:14px;flex-shrink:0;width:24px;text-align:center}
.sound-card-info{flex:1;min-width:0}
.sound-card-name{font-family:'Orbitron',sans-serif;font-size:8px;font-weight:700;letter-spacing:1px;color:rgba(200,190,255,.8);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sound-card-desc{font-family:'Share Tech Mono',monospace;font-size:7px;color:rgba(155,48,255,.45);letter-spacing:0.5px;margin-top:1px}
.sound-card-tags{display:flex;gap:3px;margin-top:2px}
.sound-tag{font-family:'Share Tech Mono',monospace;font-size:7px;padding:1px 4px;border-radius:2px;letter-spacing:1px}
.sound-tag.tag-hit{color:var(--cyan);background:rgba(0,240,255,.08);border:1px solid rgba(0,240,255,.2)}
.sound-tag.tag-miss{color:var(--pink);background:rgba(255,45,149,.08);border:1px solid rgba(255,45,149,.2)}
.sound-select-hint{font-family:'Share Tech Mono',monospace;font-size:8px;color:rgba(155,48,255,.35);letter-spacing:1px;text-align:center;margin-top:2px}

/* ═══════════════ RESPONSIVE ═══════════════ */
@media(max-width:1024px){
  .final-metrics-grid{grid-template-columns:repeat(5,1fr);gap:6px}
  .fm-value{font-size:16px}
  .round-breakdown{max-width:100%}
}
@media(max-width:768px){
  #menuScreen{gap:6px}
  .game-title{letter-spacing:4px}
  .start-btn{font-size:15px;padding:8px 32px;letter-spacing:4px}
  .demo-btn{font-size:11px;padding:7px 22px}
  .math-hud{padding:0 10px;gap:6px;margin-bottom:10px}
  .hud-value{font-size:20px}
  .hud-label{font-size:9px;letter-spacing:2px}
  .timer-ring-container{width:110px;height:110px;margin:4px 0 8px}
  .timer-seconds{font-size:30px}
  .math-question-box{padding:18px 20px;min-width:0;max-width:90vw}
  .math-question{font-size:clamp(20px,4vw,32px)}
  .answers-grid{gap:10px;max-width:90vw}
  .answer-btn{font-size:18px;padding:14px 16px}
  .shoot-hud{gap:10px;padding:8px 12px}
  .shoot-hud-item{font-size:11px}.shoot-hud-item span{font-size:14px}
  .combo-display{font-size:22px;top:50px}
  .round-result-title{font-size:20px;letter-spacing:3px}
  .round-stats-grid{grid-template-columns:repeat(3,1fr);gap:6px}
  .stat-card{padding:6px 3px}
  .next-round-btn{font-size:14px;padding:10px 32px}
  .final-metrics-grid{grid-template-columns:repeat(3,1fr);gap:6px}
  .fm-card{padding:8px 3px}
  .fm-value{font-size:15px}
  .final-score-big{font-size:clamp(40px,10vw,64px)}
  .final-buttons{gap:10px}
  .play-again-btn,.save-score-btn{font-size:14px;padding:10px 28px;letter-spacing:3px}
  .breakdown-table th,.breakdown-table td{padding:3px 2px;font-size:10px}
  .stressor-title{font-size:22px;letter-spacing:3px}
  .stressor-subtitle{font-size:11px;max-width:90vw}
  .stressor-question-text{font-size:18px;max-width:90vw}
  .stressor-input{font-size:18px;padding:12px 16px;max-width:90vw}
  .briefing-box{padding:20px;max-width:90vw}
  .briefing-text{font-size:16px}
  .engage-btn{font-size:16px;padding:12px 40px;letter-spacing:4px}
  .stressor-round-text{font-size:17px;max-width:90vw}
  .stressor-outcome-icon{font-size:56px}
  .stressor-outcome-title{font-size:24px;letter-spacing:4px}
  #outcomeBox{max-width:90vw}
  .wrong-overlay-title{font-size:36px}
  .wrong-overlay-sub{font-size:15px}
}
@media(max-width:480px){
  .screen{padding:8px 6px}
  #menuScreen{gap:4px}
  .game-title{letter-spacing:3px;font-size:clamp(24px,7vw,36px)}
  .game-subtitle{font-size:9px;letter-spacing:5px}
  .title-numeral{height:30px}
  .brand-logo{width:clamp(160px,45vw,260px)}
  .level-display{font-size:24px}
  .sound-grid{grid-template-columns:1fr}
  .sound-assign-row{flex-direction:column;gap:4px}
  .level-label{font-size:11px;letter-spacing:3px}
  .level-slider{width:clamp(150px,60vw,260px)}
  .cap-slider{width:clamp(140px,55vw,240px)}
  .cap-value{font-size:15px}
  .slider-end-label{font-size:9px;min-width:28px}
  .difficulty-desc{font-size:10px}
  .mode-selector{gap:8px}
  .mode-label{font-size:10px;letter-spacing:2px}
  .mode-btn{font-size:10px;padding:4px 10px;letter-spacing:1px}
  .mode-desc{font-size:9px}
  .tuning-row{grid-template-columns:50px 18px 48px 12px 18px 48px 40px;gap:2px}
  .tuning-label{font-size:9px;letter-spacing:1px}
  .tuning-input{font-size:10px;padding:1px 2px}
  .tuning-lv{font-size:8px}
  .tuning-mode-tag{font-size:7px;padding:1px 3px}
  .tuning-preview-canvas{height:120px}
  .tuning-preview-stats{font-size:8px}
  .stressor-toggle-label{font-size:10px;letter-spacing:2px}
  .toggle-switch{width:44px;height:24px}
  .toggle-knob{width:16px;height:16px;top:3px;left:3px}
  .toggle-switch.active .toggle-knob{left:23px}
  .cap-max-label{font-size:8px}
  .cap-max-input{font-size:10px;width:52px;padding:1px 4px}
  .cap-desc{font-size:9px;max-width:90vw}
  .start-btn{font-size:13px;padding:8px 26px;letter-spacing:3px}
  .demo-btn{font-size:10px;padding:6px 18px;letter-spacing:3px}
  .menu-buttons{gap:6px}
  .math-hud{padding:0 6px;gap:4px;margin-bottom:6px;flex-wrap:wrap}
  .hud-value{font-size:16px}
  .hud-label{font-size:8px;letter-spacing:1px}
  .timer-ring-container{width:90px;height:90px;margin:2px 0 6px}
  .timer-seconds{font-size:24px}
  .timer-label{font-size:8px}
  .pressure-badge{font-size:10px;padding:3px 8px}
  .math-question-box{padding:14px 14px;border-radius:8px}
  .answers-grid{grid-template-columns:1fr;max-width:260px;gap:8px}
  .answer-btn{font-size:16px;padding:12px 14px}
  .shoot-hud{gap:6px;padding:4px 6px}
  .shoot-hud-item{font-size:10px}.shoot-hud-item span{font-size:12px}
  .combo-display{font-size:18px;top:42px}
  .shoot-center-msg{font-size:clamp(28px,8vw,48px)}
  .round-result-title{font-size:16px;letter-spacing:2px}
  .round-stats-grid{grid-template-columns:repeat(2,1fr);gap:4px}
  .stat-card{padding:5px 2px;border-radius:6px}
  .stat-card-label{font-size:7px}
  .stat-card-value{font-size:13px}
  .stat-card-sub{font-size:6px}
  .next-round-btn{font-size:12px;padding:8px 24px;letter-spacing:3px}
  #finalScreen{padding-top:35px;gap:6px}
  .final-title{letter-spacing:3px}
  .final-match-info{font-size:11px;letter-spacing:2px}
  .final-score-big{font-size:clamp(36px,12vw,52px)}
  .final-score-label{font-size:11px}
  .mastery-bar{max-width:90vw}
  .mastery-label{font-size:10px}
  .final-metrics-grid{grid-template-columns:repeat(3,1fr);gap:4px}
  .fm-card{padding:6px 2px;border-radius:6px}
  .fm-title{font-size:7px}
  .fm-value{font-size:13px}
  .fm-rank{font-size:8px}
  .round-breakdown{max-width:100%}
  .breakdown-title{font-size:10px}
  .breakdown-table th{font-size:8px;padding:3px 1px}
  .breakdown-table td{font-size:10px;padding:3px 1px}
  .play-again-btn,.save-score-btn{font-size:12px;padding:8px 20px;letter-spacing:2px}
  .final-buttons{gap:8px;margin:6px 0 20px}
  #stressorQuestionScreen{gap:14px;padding:20px 10px}
  .stressor-title{font-size:18px;letter-spacing:2px}
  .stressor-subtitle{font-size:10px;letter-spacing:2px}
  .stressor-question-text{font-size:16px}
  .stressor-input{font-size:16px;padding:10px 12px}
  .stressor-submit-btn{font-size:13px;padding:10px 30px;letter-spacing:3px}
  #stressorBriefingScreen{gap:14px;padding:20px 10px}
  .briefing-box{padding:16px 12px;border-radius:8px}
  .briefing-label{font-size:10px;letter-spacing:3px;margin-bottom:8px}
  .briefing-text{font-size:14px}
  .briefing-ready{font-size:11px}
  .engage-btn{font-size:14px;padding:10px 32px;letter-spacing:3px}
  .stressor-round-text{font-size:15px;padding:0 12px}
  .stressor-round-label{font-size:10px;letter-spacing:3px}
  .stressor-engage-btn{font-size:13px;padding:10px 28px;letter-spacing:3px}
  .stressor-outcome-icon{font-size:44px;margin-bottom:6px}
  .stressor-outcome-title{font-size:18px;letter-spacing:3px;margin-bottom:12px}
  #outcomeBox{padding:16px 12px}
  .wrong-overlay-title{font-size:28px;letter-spacing:4px}
  .wrong-overlay-sub{font-size:14px}
  .demo-banner-text{font-size:11px;letter-spacing:4px}
  .demo-banner-sub{font-size:9px}
  .exit-btn{font-size:10px;padding:6px 12px;letter-spacing:2px;top:10px;right:10px}
}
@media(max-height:600px){
  #menuScreen{gap:2px}
  .screen{padding:6px 8px}
  .game-title{font-size:clamp(22px,5vw,32px)}
  .game-subtitle{font-size:8px;margin-top:-4px}
  .level-display{font-size:22px}
  .cap-value{font-size:14px}
  .start-btn{font-size:13px;padding:6px 24px}
  .demo-btn{font-size:10px;padding:5px 16px}
  .timer-ring-container{width:80px;height:80px;margin:2px 0 4px}
  .timer-seconds{font-size:22px}
  .math-question-box{padding:12px;margin-bottom:8px}
  .answers-grid{gap:6px}
  .answer-btn{padding:10px 12px;font-size:16px}
  .round-result-title{font-size:16px;margin-bottom:4px}
  .next-round-btn{padding:8px 24px;font-size:12px}
  .stressor-outcome-icon{font-size:36px;margin-bottom:4px}
  .stressor-outcome-title{font-size:16px;margin-bottom:8px}
  .tuning-preview-canvas{height:100px}
  .tuning-preview-stats{font-size:7px}
  .tuning-row{grid-template-columns:50px 18px 48px 12px 18px 48px 40px;gap:1px}
  .tuning-input{font-size:10px;padding:1px 2px}
  .tuning-label{font-size:8px}
  .tuning-lv{font-size:7px}
  .tuning-mode-tag{font-size:6px;padding:0 2px}
  .level-label{font-size:11px;letter-spacing:2px}
  .cap-max-label{font-size:8px}
  .cap-max-input{font-size:10px;width:48px;padding:1px 4px}
  .cap-desc{font-size:8px}
  .mode-btn{font-size:9px;padding:4px 8px}
  .mode-desc{font-size:8px}
  .stressor-toggle-label{font-size:9px}
}
@media(max-width:360px){
  .game-title{font-size:24px;letter-spacing:2px}
  .game-subtitle{font-size:9px;letter-spacing:4px}
  .title-numeral{height:24px}
  .brand-logo{width:clamp(140px,40vw,220px)}
  .level-slider{width:140px}
  .cap-slider{width:130px}
  .start-btn{font-size:13px;padding:8px 24px}
  .demo-btn{font-size:10px;padding:6px 16px}
  .final-metrics-grid{grid-template-columns:repeat(2,1fr)}
  .round-stats-grid{grid-template-columns:repeat(2,1fr)}
  .answers-grid{max-width:220px}
  .answer-btn{font-size:14px;padding:10px}
  .tuning-row{grid-template-columns:42px 16px 42px 10px 16px 42px 34px;gap:2px}
  .tuning-label{font-size:8px;letter-spacing:1px}
  .tuning-input{font-size:10px;padding:2px 2px}
  .tuning-lv{font-size:7px}
  .tuning-mode-tag{font-size:6px;padding:1px 2px;letter-spacing:0}
  .tuning-preview-canvas{height:110px}
}

/* STRESSOR MODE */
.stressor-toggle{display:flex;align-items:center;gap:10px;margin:0}
.stressor-toggle-label{font-family:'Share Tech Mono',monospace;font-size:12px;color:rgba(155,48,255,.6);letter-spacing:3px;text-transform:uppercase}
.toggle-switch{position:relative;width:52px;height:28px;background:rgba(155,48,255,.06);border:1px solid rgba(155,48,255,.2);border-radius:14px;cursor:pointer;transition:all .3s}
.toggle-switch.active{background:rgba(155,48,255,.2);border-color:var(--purple);box-shadow:0 0 12px rgba(155,48,255,.2)}
.toggle-knob{position:absolute;top:3px;left:3px;width:20px;height:20px;background:rgba(155,48,255,.4);border-radius:50%;transition:all .3s}
.toggle-switch.active .toggle-knob{left:27px;background:var(--purple);box-shadow:0 0 10px rgba(155,48,255,.5)}
#mathToggle.active{background:rgba(0,240,255,.2);border-color:var(--cyan)}
#mathToggle.active{background:rgba(0,240,255,.15);border-color:var(--cyan);box-shadow:0 0 12px rgba(0,240,255,.2)}
#mathToggle.active .toggle-knob{background:var(--cyan);box-shadow:0 0 10px rgba(0,240,255,.5)}
.stressor-hint{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,0,60,.4);letter-spacing:1px;margin-top:-2px;height:12px}

#stressorQuestionScreen{gap:20px;padding:30px}
.stressor-title{font-family:'Orbitron',sans-serif;font-size:28px;font-weight:900;letter-spacing:4px;color:var(--red);text-shadow:0 0 20px rgba(255,0,60,.4)}
.stressor-subtitle{font-family:'Share Tech Mono',monospace;font-size:13px;color:rgba(155,48,255,.5);letter-spacing:3px;text-transform:uppercase;max-width:500px;text-align:center}
.stressor-question-text{font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:600;color:rgba(255,255,255,.8);text-align:center;max-width:500px;line-height:1.5}
.stressor-input{font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:500;padding:14px 20px;width:100%;max-width:500px;background:rgba(255,255,255,.04);border:2px solid rgba(255,0,60,.3);border-radius:8px;color:#fff;outline:none;transition:border-color .3s}
.stressor-input:focus{border-color:var(--red)}
.stressor-input::placeholder{color:rgba(255,255,255,.2)}
.stressor-submit-btn{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;letter-spacing:4px;padding:14px 44px;background:transparent;border:2px solid var(--red);color:var(--red);border-radius:4px;cursor:pointer;transition:all .3s}
.stressor-submit-btn:hover{background:rgba(255,0,60,.1);box-shadow:0 0 20px rgba(255,0,60,.3)}
.stressor-submit-btn:disabled{opacity:.4;cursor:not-allowed}
.stressor-loading{font-family:'Share Tech Mono',monospace;font-size:14px;color:var(--red);letter-spacing:2px;animation:stressorPulse 1.5s ease infinite}
@keyframes stressorPulse{0%,100%{opacity:.4}50%{opacity:1}}

#stressorBriefingScreen{gap:20px;padding:30px}
.briefing-box{background:var(--panel);border:1px solid rgba(255,0,60,.3);border-radius:12px;padding:30px;max-width:600px;width:100%;text-align:center;box-shadow:0 0 40px rgba(255,0,60,.08)}
.briefing-label{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,0,60,.6);letter-spacing:5px;text-transform:uppercase;margin-bottom:12px}
.briefing-text{font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:500;color:rgba(255,255,255,.8);line-height:1.6}
.briefing-ready{font-family:'Share Tech Mono',monospace;font-size:13px;color:rgba(155,48,255,.45);letter-spacing:3px;margin-top:8px}
.engage-btn{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:900;letter-spacing:6px;padding:16px 60px;background:rgba(255,0,60,.1);border:2px solid var(--red);color:var(--red);border-radius:4px;cursor:pointer;transition:all .3s;text-shadow:0 0 10px rgba(255,0,60,.4)}
.engage-btn:hover{background:rgba(255,0,60,.2);box-shadow:0 0 30px rgba(255,0,60,.4);transform:translateY(-2px)}

.stressor-round-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px;z-index:100;background:rgba(10,10,26,.92)}.stressor-round-overlay.visible{display:flex}
.stressor-round-text{font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:500;color:rgba(255,255,255,.75);max-width:550px;text-align:center;line-height:1.6;padding:0 20px}
.stressor-round-label{font-family:'Share Tech Mono',monospace;font-size:11px;color:rgba(255,0,60,.5);letter-spacing:4px;text-transform:uppercase}
.stressor-engage-btn{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;letter-spacing:4px;padding:12px 40px;background:transparent;border:2px solid var(--red);color:var(--red);border-radius:4px;cursor:pointer;transition:all .3s}
.stressor-engage-btn:hover{background:rgba(255,0,60,.1);box-shadow:0 0 20px rgba(255,0,60,.3)}

.stressor-outcome-icon{font-size:72px;margin-bottom:10px}

/* ═══════════════ ACCORDION TABS ═══════════════ */
.menu-tab{width:clamp(300px,88vw,520px);border:1px solid rgba(155,48,255,.25);border-radius:4px;overflow:hidden;margin:0;transition:all .35s;background:rgba(10,6,30,.6);position:relative}
.menu-tab:hover{border-color:rgba(0,240,255,.4);box-shadow:0 0 20px rgba(0,240,255,.12),0 0 40px rgba(0,240,255,.05)}
.menu-tab::before{content:'';position:absolute;inset:0;border-radius:4px;background:linear-gradient(135deg,rgba(155,48,255,.03),rgba(0,240,255,.02));pointer-events:none;transition:opacity .3s;opacity:0}
.menu-tab.open::before{opacity:1}
.menu-tab.open{border-color:rgba(155,48,255,.5);box-shadow:0 0 25px rgba(155,48,255,.15),0 0 50px rgba(0,240,255,.06),inset 0 0 30px rgba(155,48,255,.05)}
.menu-tab-header{display:flex;align-items:center;justify-content:space-between;padding:11px 16px;cursor:pointer;background:linear-gradient(90deg,rgba(155,48,255,.04),transparent,rgba(0,240,255,.03));transition:all .3s;user-select:none;position:relative}
.menu-tab-header:hover{background:linear-gradient(90deg,rgba(0,240,255,.12),rgba(155,48,255,.08),rgba(0,240,255,.12));box-shadow:0 0 25px rgba(0,240,255,.2),inset 0 0 20px rgba(0,240,255,.05)}
.menu-tab-header:hover .menu-tab-title{color:var(--cyan);text-shadow:0 0 12px rgba(0,240,255,.5)}
.menu-tab-header:hover .menu-tab-arrow{color:var(--cyan);filter:drop-shadow(0 0 6px rgba(0,240,255,.6))}
.menu-tab.open .menu-tab-header{background:linear-gradient(90deg,rgba(155,48,255,.1),rgba(0,240,255,.04),rgba(155,48,255,.08));border-bottom:1px solid rgba(155,48,255,.15)}
.menu-tab-title{font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:rgba(155,48,255,.65);transition:all .3s}
.menu-tab.open .menu-tab-title{color:var(--cyan);text-shadow:0 0 15px rgba(0,240,255,.5)}
.menu-tab-arrow{font-size:10px;color:rgba(155,48,255,.6);transition:transform .3s,color .3s}
.menu-tab.open .menu-tab-arrow{transform:rotate(90deg);color:var(--cyan);filter:drop-shadow(0 0 6px rgba(0,240,255,.6))}
.menu-tab-summary{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(0,240,255,.6);letter-spacing:1px;margin-left:auto;margin-right:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px}
.menu-tab.open .menu-tab-summary{display:none}
.menu-tab-body{max-height:0;overflow:hidden;transition:max-height .35s ease,padding .25s ease;padding:0 16px;display:flex;flex-direction:column;align-items:center;gap:6px}
.menu-tab.open .menu-tab-body{max-height:1200px;padding:12px 16px 14px}
.menu-tab-body>*{opacity:0;transition:opacity .25s ease .1s}
.menu-tab.open .menu-tab-body>*{opacity:1}

.mode-selector{display:flex;align-items:center;gap:10px;margin:0}
.mode-label{font-family:'Share Tech Mono',monospace;font-size:12px;color:rgba(155,48,255,.6);letter-spacing:3px;text-transform:uppercase}
.mode-btn{background:rgba(155,48,255,.04);border:1px solid rgba(155,48,255,.25);color:rgba(155,48,255,.7);font-family:'Orbitron',sans-serif;font-size:12px;font-weight:700;padding:7px 16px;border-radius:4px;cursor:pointer;transition:all .2s;letter-spacing:2px}
.mode-btn:hover{background:rgba(155,48,255,.1);color:var(--purple);border-color:rgba(155,48,255,.4)}
.mode-btn.selected{background:linear-gradient(135deg,rgba(155,48,255,.15),rgba(0,240,255,.08));border-color:var(--cyan);color:var(--cyan);box-shadow:0 0 15px rgba(0,240,255,.2),0 0 30px rgba(155,48,255,.1)}
.mode-desc{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(0,240,255,.3);text-align:center;min-height:12px}
.tuning-section{display:flex;flex-direction:column;gap:2px;align-items:center}
.tuning-row{display:grid;grid-template-columns:62px 22px 58px 16px 22px 58px 48px;align-items:center;gap:4px}
.tuning-label{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(155,48,255,.45);letter-spacing:2px;text-transform:uppercase;text-align:right}
.tuning-unit{font-size:9px;color:rgba(0,240,255,.3)}
.tuning-lv{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(155,48,255,.3);letter-spacing:1px;text-align:center}
.tuning-arrow{font-family:'Share Tech Mono',monospace;font-size:12px;color:rgba(155,48,255,.2);text-align:center}
.tuning-input{font-family:'Orbitron',sans-serif;font-size:12px;font-weight:700;width:100%;text-align:center;background:rgba(155,48,255,.04);border:1px solid rgba(155,48,255,.15);border-radius:4px;padding:2px 3px;outline:none;-moz-appearance:textfield;transition:all .2s}
.tuning-input::-webkit-outer-spin-button,.tuning-input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
.tuning-input:focus{box-shadow:0 0 10px rgba(155,48,255,.15);border-color:rgba(155,48,255,.3)}
.tuning-green{color:var(--cyan);border-color:rgba(0,240,255,.2)}.tuning-green:focus{border-color:var(--cyan)}
.tuning-red{color:var(--pink);border-color:rgba(255,45,149,.2)}.tuning-red:focus{border-color:var(--pink)}
.tuning-mode-tag{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:1px;color:rgba(0,240,255,.5);border:1px solid rgba(0,240,255,.2);border-radius:3px;padding:1px 4px;text-align:center;white-space:nowrap}
.tuning-mode-reflex{color:rgba(255,230,0,.5);border-color:rgba(255,230,0,.2)}
.tuning-mode-both{color:rgba(155,48,255,.5);border-color:rgba(155,48,255,.2)}
.tuning-preview-wrap{display:flex;flex-direction:column;align-items:center;gap:1px;width:100%}
.tuning-preview-canvas{width:100%;height:180px;border:1px solid rgba(155,48,255,.15);border-radius:4px;background:rgba(0,0,0,.5);box-shadow:inset 0 0 20px rgba(155,48,255,.03)}
.tuning-preview-stats{font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(0,240,255,.35);letter-spacing:1px;text-align:center}
.reflex-timer-ring{position:absolute;pointer-events:none}
.reflex-timer-ring circle{fill:none;stroke-linecap:round;transition:stroke .15s}
.stressor-outcome-title{font-family:'Orbitron',sans-serif;font-size:32px;font-weight:900;letter-spacing:6px;margin-bottom:20px;text-shadow:0 0 20px currentColor}
#outcomeBox{max-width:650px;transition:border-color .5s}
.outcome-survived #outcomeBox{border-color:var(--green)}
.outcome-partial #outcomeBox{border-color:var(--yellow)}
.outcome-failed #outcomeBox{border-color:var(--red)}
</style>
</head>
<body>
<button class="exit-btn" id="exitBtn">✕ Menu</button>
<div class="demo-banner" id="demoBanner"><div class="demo-banner-text" id="demoBannerText">AI DEMO</div><div class="demo-banner-sub" id="demoBannerSub">Level 1 — Simple Arithmetic</div></div>

<div id="menuScreen" class="screen active">
  <div class="game-title">MATH AIM</div>
  <div class="game-subtitle">Solve & Shoot</div>
  <div class="ff-ornament"><div class="ff-diamond"></div></div>
  <div class="version-badge">Version III</div>
  <div class="level-select-container">
    <div class="level-label">Difficulty Level</div>
    <div class="level-display" id="levelDisplay">1</div>
    <div class="level-task" id="levelTask">+ −</div>
    <div class="level-slider-row"><span class="slider-end-label">Easy</span><input type="range" class="level-slider" id="levelSlider" min="1" max="25" value="1"><span class="slider-end-label">Hard</span></div>
    <div class="difficulty-desc" id="diffDesc" style="color:var(--cyan)">The first stirrings of Eyzaeth • Light emerges from the void</div>
  </div>

  <!-- TAB: AIM MODE -->
  <div class="menu-tab" id="tabAimMode">
    <div class="menu-tab-header" onclick="toggleTab('tabAimMode')">
      <span class="menu-tab-title">Aim Mode</span>
      <span class="menu-tab-summary" id="aimModeSummary">MOVING</span>
      <span class="menu-tab-arrow">▶</span>
    </div>
    <div class="menu-tab-body">
      <div class="mode-selector"><span class="mode-label">Type</span><button class="mode-btn selected" id="modeMoving" data-mode="moving">MOVING</button><button class="mode-btn" id="modeReflex" data-mode="reflex">REFLEX</button></div>
      <div class="mode-desc" id="modeDesc">Targets move in patterns — track and eliminate all targets</div>
    </div>
  </div>

  <!-- TAB: TARGET TUNING & PREVIEW -->
  <div class="menu-tab" id="tabTuning">
    <div class="menu-tab-header" onclick="toggleTab('tabTuning')">
      <span class="menu-tab-title">Target Tuning & Preview</span>
      <span class="menu-tab-summary" id="tuningSummary">Default</span>
      <span class="menu-tab-arrow">▶</span>
    </div>
    <div class="menu-tab-body">
      <div class="tuning-section">
        <div class="tuning-row">
          <span class="tuning-label">SIZE <span class="tuning-unit">px</span></span>
          <span class="tuning-lv">Lv1</span><input type="number" class="tuning-input tuning-green" id="sizeLv1" value="45" min="5" step="1">
          <span class="tuning-arrow">→</span>
          <span class="tuning-lv">Lv25</span><input type="number" class="tuning-input tuning-red" id="sizeLv25" value="14" min="5" step="1">
          <span class="tuning-mode-tag tuning-mode-both">BOTH</span>
        </div>
        <div class="tuning-row" id="speedRow">
          <span class="tuning-label" id="speedLabel">SPEED</span>
          <span class="tuning-lv">Lv1</span><input type="number" class="tuning-input tuning-green" id="speedLv1" value="0.8" min="0.1" step="0.1">
          <span class="tuning-arrow">→</span>
          <span class="tuning-lv">Lv25</span><input type="number" class="tuning-input tuning-red" id="speedLv25" value="4.5" min="0.1" step="0.1">
          <span class="tuning-mode-tag">MOVING</span>
        </div>
        <div class="tuning-row" id="reflexVisRow">
          <span class="tuning-label">VISIBLE <span class="tuning-unit">s</span></span>
          <span class="tuning-lv">Lv1</span><input type="number" class="tuning-input tuning-green" id="visLv1" value="3.0" min="0.1" step="0.05">
          <span class="tuning-arrow">→</span>
          <span class="tuning-lv">Lv25</span><input type="number" class="tuning-input tuning-red" id="visLv25" value="0.55" min="0.1" step="0.05">
          <span class="tuning-mode-tag tuning-mode-reflex">REFLEX</span>
        </div>
        <div class="tuning-row" id="reflexSpawnRow">
          <span class="tuning-label">SPAWN <span class="tuning-unit">s</span></span>
          <span class="tuning-lv">Lv1</span><input type="number" class="tuning-input tuning-green" id="spawnIntLv1" value="2.0" min="0.1" step="0.05">
          <span class="tuning-arrow">→</span>
          <span class="tuning-lv">Lv25</span><input type="number" class="tuning-input tuning-red" id="spawnIntLv25" value="0.35" min="0.1" step="0.05">
          <span class="tuning-mode-tag tuning-mode-reflex">REFLEX</span>
        </div>
      </div>
      <div class="tuning-preview-wrap">
        <canvas id="tuningPreview" class="tuning-preview-canvas"></canvas>
        <div class="tuning-preview-stats" id="previewStats"></div>
      </div>
    </div>
  </div>

  <!-- TAB: ROUNDS & TARGETS -->
  <div class="menu-tab" id="tabRounds">
    <div class="menu-tab-header" onclick="toggleTab('tabRounds')">
      <span class="menu-tab-title">Rounds & Targets</span>
      <span class="menu-tab-summary" id="roundsSummary">5 rds • cap 30</span>
      <span class="menu-tab-arrow">▶</span>
    </div>
    <div class="menu-tab-body">
      <div class="stressor-toggle"><span class="stressor-toggle-label">Math</span><div class="toggle-switch active" id="mathToggle"><div class="toggle-knob"></div></div></div>
      <div class="stressor-hint" id="mathHint" style="color:rgba(0,240,255,.35)">Target count = your math answer</div>
      <div id="targetCountSection" style="display:none">
        <div class="target-cap-container" style="margin-top:0">
          <div class="level-label">Targets Per Round</div>
          <div class="cap-value" id="targetCountValue" style="color:var(--green);text-shadow:0 0 15px rgba(57,255,20,.3)">10</div>
          <div class="level-slider-row"><span class="slider-end-label">1</span><input type="range" class="level-slider cap-slider" id="targetCountSlider" min="1" max="50" value="10" style="background:linear-gradient(90deg,var(--cyan),var(--purple))"><span class="slider-end-label" id="targetCountMaxLabel">50</span></div>
          <div class="cap-max-row"><span class="cap-max-label">Slider max:</span><input type="number" class="cap-max-input" id="targetCountMaxInput" value="50" min="1" style="color:var(--green);background:rgba(57,255,20,.06);border-color:rgba(57,255,20,.2)"></div>
        </div>
      </div>
      <div class="target-cap-container" style="margin-top:6px">
        <div class="level-label">Rounds</div>
        <div class="cap-value" id="roundsValue" style="color:var(--cyan);text-shadow:0 0 15px rgba(0,240,255,.3)">5</div>
        <div class="level-slider-row"><span class="slider-end-label">1</span><input type="range" class="level-slider cap-slider" id="roundsSlider" min="1" max="30" value="5" style="background:linear-gradient(90deg,var(--cyan),var(--purple))"><span class="slider-end-label" id="roundsMaxLabel">30</span></div>
        <div class="cap-max-row"><span class="cap-max-label">Slider max:</span><input type="number" class="cap-max-input" id="roundsMaxInput" value="30" min="1" style="color:var(--cyan);background:rgba(0,240,255,.06);border-color:rgba(0,240,255,.2)"></div>
      </div>
      <div class="target-cap-container" style="margin-top:6px" id="capSection">
        <div class="level-label">Max Targets Per Round</div>
        <div class="cap-value" id="capValue">30</div>
        <div class="level-slider-row"><span class="slider-end-label">1</span><input type="range" class="level-slider cap-slider" id="capSlider" min="1" max="50" value="30"><span class="slider-end-label" id="capMaxLabel">50</span></div>
        <div class="cap-max-row"><span class="cap-max-label">Slider max:</span><input type="number" class="cap-max-input" id="capMaxInput" value="50" min="1"></div>
        <div class="cap-desc" id="capDesc">If the math answer exceeds this cap, fewer targets spawn but they become harder to hit.</div>
      </div>
    </div>
  </div>

  <!-- TAB: STRESSOR MODE -->
  <div class="menu-tab" id="tabStressor">
    <div class="menu-tab-header" onclick="toggleTab('tabStressor')">
      <span class="menu-tab-title">Stressor Mode</span>
      <span class="menu-tab-summary" id="stressorSummary">OFF</span>
      <span class="menu-tab-arrow">▶</span>
    </div>
    <div class="menu-tab-body">
      <div class="stressor-toggle"><span class="stressor-toggle-label">Enable</span><div class="toggle-switch" id="stressorToggle"><div class="toggle-knob"></div></div></div>
      <div class="stressor-hint" id="stressorHint"></div>
      <div class="mode-desc" style="margin-top:4px;font-size:9px;color:rgba(155,48,255,.4)">Adds emotional stakes to sharpen focus under pressure</div>
    </div>
  </div>

  <!-- TAB: SOUND -->
  <div class="menu-tab" id="tabSound">
    <div class="menu-tab-header" onclick="toggleTab('tabSound')">
      <span class="menu-tab-title">Sound</span>
      <span class="menu-tab-summary" id="soundSummary">ON • 80%</span>
      <span class="menu-tab-arrow">▶</span>
    </div>
    <div class="menu-tab-body">
      <div class="sound-master-row">
        <div class="stressor-toggle"><span class="stressor-toggle-label">Sound</span><div class="toggle-switch active" id="soundToggle"><div class="toggle-knob"></div></div></div>
      </div>
      <div class="sound-vol-row" id="soundVolRow">
        <span class="sound-vol-label">Volume</span>
        <input type="range" class="sound-vol-slider" id="soundVolSlider" min="0" max="100" value="80">
        <span class="sound-vol-val" id="soundVolVal">80%</span>
      </div>
      <div class="sound-select-hint">Select a sound then assign it as your HIT or MISS sound</div>
      <div class="sound-assign-row">
        <button class="sound-assign-btn hit-assign active" id="assignHitBtn" onclick="setSoundAssignMode('hit')">Selecting: HIT ⚡</button>
        <button class="sound-assign-btn miss-assign" id="assignMissBtn" onclick="setSoundAssignMode('miss')">Selecting: MISS ✗</button>
      </div>
      <div class="sound-grid-wrapper">
        <div class="sound-grid" id="soundGrid"></div>
      </div>
      <div class="sound-current-row">
        <div class="sound-current"><span class="sound-current-label">HIT:</span> <span id="currentHitName">Plasma Burst</span></div>
        <div class="sound-current miss-current"><span class="sound-current-label">MISS:</span> <span id="currentMissName">Dull Thud</span></div>
      </div>
    </div>
  </div>

  <div class="menu-divider"></div>
  <div class="menu-buttons">
    <button class="start-btn" id="startBtn">START</button>
    <button class="demo-btn" id="demoBtn">WATCH DEMO</button>
  </div>
  <div class="menu-divider"></div>
  <div class="brand-bar">
    <div class="brand-sub">Created by</div>
    <div class="brand-name">JLTHAKAD</div>
  </div>
</div>

<div id="stressorQuestionScreen" class="screen">
  <div class="stressor-title">STRESSOR MODE</div>
  <div class="stressor-subtitle">Stress inoculation training — create emotional stakes to sharpen your focus under pressure</div>
  <div class="stressor-question-text" id="stressorQuestionText"></div>
  <input type="text" class="stressor-input" id="stressorInput" placeholder="Type your answer..." maxlength="200" autocomplete="off">
  <button class="stressor-submit-btn" id="stressorSubmitBtn">SUBMIT</button>
  <div class="stressor-loading" id="stressorLoading" style="display:none">GENERATING SCENARIO...</div>
</div>

<div id="stressorBriefingScreen" class="screen">
  <div class="stressor-title">MISSION BRIEFING</div>
  <div class="briefing-box">
    <div class="briefing-label">Your scenario</div>
    <div class="briefing-text" id="briefingText"></div>
  </div>
  <div class="briefing-ready">Are you ready to engage?</div>
  <button class="engage-btn" id="engageBtn">ENGAGE</button>
</div>

<div class="stressor-round-overlay" id="stressorRoundOverlay">
  <div class="stressor-round-label" id="stressorRoundLabel">ROUND 1 — STAY FOCUSED</div>
  <div class="stressor-round-text" id="stressorRoundText"></div>
  <button class="stressor-engage-btn" id="stressorRoundEngageBtn">READY</button>
</div>

<div id="stressorOutcomeScreen" class="screen">
  <div class="stressor-outcome-icon" id="outcomeIcon"></div>
  <div class="stressor-outcome-title" id="outcomeTitle">MISSION COMPLETE</div>
  <div class="briefing-box" id="outcomeBox">
    <div class="briefing-label" id="outcomeLabel">OUTCOME</div>
    <div class="briefing-text" id="outcomeText"></div>
  </div>
  <button class="engage-btn" id="outcomeContinueBtn" style="border-color:var(--cyan);color:var(--cyan)">VIEW RESULTS</button>
</div>

<div id="mathScreen" class="screen">
  <div class="math-hud"><div class="hud-item"><span class="hud-label">Round</span><span class="hud-value" id="hudRound">1/5</span></div><div class="hud-item"><span class="hud-label">Level</span><span class="hud-value" id="hudLevel">1</span></div><div class="hud-item"><span class="hud-label">Combo</span><span class="hud-value" id="hudCombo">0</span></div><div class="hud-item"><span class="hud-label">Score</span><span class="hud-value" id="hudScore">0</span></div></div>
  <div class="timer-ring-container"><svg class="timer-ring" viewBox="0 0 160 160"><circle class="timer-ring-bg" cx="80" cy="80" r="70"/><circle class="timer-ring-fill" id="timerRingFill" cx="80" cy="80" r="70"/></svg><div class="timer-text"><span class="timer-seconds" id="timerText">0.0</span><span class="timer-label">seconds</span></div></div>
  <div class="pressure-badge" id="pressureBadge" style="color:var(--cyan);border-color:var(--cyan)">1.0x PRESSURE</div>
  <div class="math-question-box"><div class="math-question" id="mathQuestion">12 + 7 = ?</div></div>
  <div class="answers-grid" id="answersGrid"></div>
</div>

<div id="shootScreen" class="screen">
  <div class="shoot-canvas-container"><canvas id="shootCanvas"></canvas></div>
  <div class="shoot-hud">
    <div class="shoot-hud-item">TARGETS: <span id="shootTargetsLeft">5</span></div>
    <div class="shoot-hud-item">HITS: <span id="shootHits">0</span></div>
    <div class="shoot-hud-item">PRECISION: <span id="shootAccuracy">—</span></div>
    <div class="shoot-hud-item">SPEED: <span id="shootSpeed">—</span></div>
    <div class="shoot-hud-item">COMBO: <span id="shootCombo">0</span></div>
    <div class="shoot-hud-item">MISSES: <span id="shootMisses">0</span></div>
    <div class="shoot-hud-item" id="capModHud" style="display:none">CAP MOD: <span id="shootCapMod">1.0x</span></div>
  </div>
  <div class="combo-display" id="comboDisplay"></div>
  <div class="shoot-center-msg" id="shootCenterMsg"></div>
</div>

<div id="roundResultScreen" class="screen">
  <div class="round-result-title" id="roundResultTitle">ROUND COMPLETE</div>
  <div class="round-stats-grid" id="roundStatsGrid"></div>
  <button class="next-round-btn" id="nextRoundBtn">NEXT ROUND</button>
</div>

<div id="finalScreen" class="screen">
  <div class="final-title">MATCH COMPLETE</div>
  <div class="final-match-info" id="finalMatchInfo"></div>
  <div class="final-score-big" id="finalScoreBig">0</div>
  <div class="final-score-label">TOTAL SCORE</div>
  <div class="mastery-bar"><div class="mastery-bar-bg"><div class="mastery-bar-fill" id="masteryFill"></div></div><div class="mastery-label" id="masteryLabel">MASTERY: 0 / 1000</div></div>
  <div class="final-metrics-grid" id="finalMetricsGrid"></div>
  <div class="round-breakdown"><div class="breakdown-title">Round Breakdown</div><table class="breakdown-table"><thead><tr><th>#</th><th>Math</th><th>Hits</th><th>Prec</th><th>Spd</th><th>Combo</th><th>Flick</th><th>Eff</th><th>Miss</th><th>Pts</th></tr></thead><tbody id="breakdownBody"></tbody></table></div>
  <div class="final-buttons"><button class="save-score-btn" id="saveScoreBtn">📸 SAVE SCORE</button><button class="play-again-btn" id="playAgainBtn">PLAY AGAIN</button></div>
</div>

<div class="wrong-overlay" id="wrongOverlay"><div class="wrong-overlay-title">WRONG!</div><div class="wrong-overlay-sub" id="wrongOverlaySub">The answer was 42</div></div>

<script>
const $=id=>document.getElementById(id);

// ═══════════════ CORE STATE ═══════════════
let level=1,totalRounds=5,currentRound=0,score=0,roundHistory=[],targetCap=30,lastAnswer=-1,gameMode='moving',mathEnabled=true,noMathTargetCount=10;
let tuneSizeLv1=45,tuneSizeLv25=14,tuneSpeedLv1=0.8,tuneSpeedLv25=4.5,tuneVisLv1=3.0,tuneVisLv25=0.55,tuneSpawnLv1=2.0,tuneSpawnLv25=0.35;
let correctAnswer=0,timerInterval=null,mathAnswered=false;
let mathStartTime=0,mathElapsed=0; // count-up stopwatch
let expectedTime=0; // baseline "par" time for the problem complexity
let roundMathCorrect=false,roundHits=0,roundMisses=0,roundTargetCount=0,problemDifficultyMult=1;
let capModifier=1; // how much harder targets become when capped
let canvas,ctx,targets=[],particles=[],hitFeedbacks=[],shootingActive=false,animFrameId=null,targetsRemaining=0;
let roundAccuracyScores=[],roundHitTimes=[],lastHitTime=0,shootPhaseStartTime=0;
let comboCount=0,maxCombo=0,roundMaxCombo=0,roundComboPoints=0;
let mouseTrail=[],roundFlickScores=[],firstBloodTime=0,firstBloodAwarded=false,mathConfidenceRatio=0;
let bullseyeChain=0,maxBullseyeChain=0,roundBullseyeBonus=0;
let totalClicks=0,totalCursorDist=0,hitPositions=[],lastMouseX=0,lastMouseY=0;
let lastShotWasMiss=false,roundRecoveries=0,clickTimestamps=[];
let clutchMathCount=0,clutchShotCount=0,clutchOpportunities=0;
let mouseX=0,mouseY=0;
let finalData=null; // stored for save screenshot

// ═══════════════ DEMO STATE ═══════════════
let demoMode=false,demoActive=false,demoSavedMode='moving',demoSavedMath=true,demoSavedTune={};

// ═══════════════ STRESSOR STATE ═══════════════
let stressorEnabled=false,stressorAnswer='',stressorScenario='',stressorCategory='',stressorDisplay='';
const DEMO_LEVELS=[1,5,10,15,20,25];
const DEMO_LEVEL_NAMES=['Simple Arithmetic','Basic Operations','Mixed Operations','Multi-Step Problems','Complex Math','Extreme Difficulty'];
let demoLevelIdx=0;
let aiX=0,aiY=0,aiTargetX=0,aiTargetY=0,aiMoving=false,aiAimTarget=null;
let aiMathTimeout=null,aiShootInterval=null,aiResultTimeout=null;

// AI skill parameters per demo level index (0-5)
const AI_SKILL=[
  {mathDelay:1500,aimSpeed:10,precRange:[88,99],missChance:.02,flickBase:400},
  {mathDelay:2000,aimSpeed:9,precRange:[82,96],missChance:.04,flickBase:600},
  {mathDelay:2500,aimSpeed:8,precRange:[76,93],missChance:.06,flickBase:800},
  {mathDelay:3000,aimSpeed:7,precRange:[70,90],missChance:.08,flickBase:1000},
  {mathDelay:3500,aimSpeed:6.5,precRange:[65,87],missChance:.10,flickBase:1200},
  {mathDelay:4000,aimSpeed:6,precRange:[60,84],missChance:.13,flickBase:1400},
];

function getPersonalBest(){try{return JSON.parse(localStorage.getItem('mathaim_pb_lv'+level+'_r'+totalRounds))||null}catch(e){return null}}
function setPersonalBest(d){try{localStorage.setItem('mathaim_pb_lv'+level+'_r'+totalRounds,JSON.stringify(d))}catch(e){}}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));$(id).classList.add('active');$('exitBtn').classList.toggle('visible',id!=='menuScreen');if(id==='menuScreen'&&typeof startPreview==='function')startPreview()}

function exitToMenu(){
  clearInterval(timerInterval);clearTimeout(aiMathTimeout);clearTimeout(aiResultTimeout);clearInterval(aiShootInterval);
  shootingActive=false;demoActive=false;reflexActive=false;
  if(reflexSpawnTimer){clearTimeout(reflexSpawnTimer);reflexSpawnTimer=null}
  if(demoMode){gameMode=demoSavedMode;mathEnabled=demoSavedMath;restoreTune()}demoMode=false;
  if(animFrameId)cancelAnimationFrame(animFrameId);
  $('wrongOverlay').classList.remove('visible');$('shootCenterMsg').classList.remove('visible');
  $('stressorRoundOverlay').classList.remove('visible');
  $('demoBanner').classList.remove('visible');showScreen('menuScreen');
}
$('exitBtn').addEventListener('click',exitToMenu);

// ═══════════════ MENU ═══════════════
const levelSlider=$('levelSlider'),levelDisplay=$('levelDisplay'),diffDesc=$('diffDesc');
function getLevelColor(l){return l<=5?'var(--cyan)':l<=10?'#7b68ee':l<=15?'var(--purple)':l<=20?'#cc44cc':'var(--pink)'}
function getLevelDesc(l){return l<=3?'The first stirrings of Eyzaeth • Light emerges from the void':l<=6?'Flame beings take shape • Diolozom begins to gather':l<=10?'The Dragon is born inside the Angel\'s chest • Balance is tested':l<=15?'The King Angel Dragon awakens • Diolozom flows through chaos':l<=20?'Lilith\'s free will unleashes disorder • Zarium fragments scatter':l<=23?'The Big Boom reverberates • Zarium cores race toward the Sun':'The Zarium Sun awaits its harvest • Only the King endures'}
function getLevelTask(l){return l<=3?'+ −':l<=6?'× + −':l<=10?'+ − × ÷':l<=15?'× ² multi-step':l<=20?'√ ³ ( ) chains':'√× ^n complex chains'}
levelSlider.addEventListener('input',()=>{level=+levelSlider.value;levelDisplay.textContent=level;const c=getLevelColor(level);levelDisplay.style.color=c;levelDisplay.style.textShadow=`0 0 20px ${c}`;diffDesc.textContent=getLevelDesc(level);diffDesc.style.color=c;$('levelTask').textContent=getLevelTask(level);$('levelTask').style.color=c});
const roundsSlider=$('roundsSlider'),roundsValue=$('roundsValue'),roundsMaxInput=$('roundsMaxInput'),roundsMaxLabel=$('roundsMaxLabel');
roundsSlider.addEventListener('input',()=>{totalRounds=+roundsSlider.value;roundsValue.textContent=totalRounds;updateTabSummaries()});
roundsMaxInput.addEventListener('input',()=>{let v=parseInt(roundsMaxInput.value)||1;if(v<1)v=1;roundsSlider.max=v;roundsMaxLabel.textContent=v;if(+roundsSlider.value>v){roundsSlider.value=v;totalRounds=v;roundsValue.textContent=v}});
roundsMaxInput.addEventListener('blur',()=>{let v=parseInt(roundsMaxInput.value)||1;if(v<1){v=1;roundsMaxInput.value=1}roundsSlider.max=v;roundsMaxLabel.textContent=v;if(+roundsSlider.value>v){roundsSlider.value=v;totalRounds=v;roundsValue.textContent=v}});
document.querySelectorAll('.mode-btn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.mode-btn').forEach(x=>x.classList.remove('selected'));b.classList.add('selected');gameMode=b.dataset.mode;$('modeDesc').textContent=gameMode==='moving'?'Targets move in patterns \u2014 track and eliminate all targets':'Targets flash on screen \u2014 click before they vanish';updateTabSummaries()}));
// ═══════════════ ACCORDION TABS ═══════════════
function toggleTab(id){const el=$(id);if(!el)return;const wasOpen=el.classList.contains('open');document.querySelectorAll('.menu-tab').forEach(t=>t.classList.remove('open'));if(!wasOpen){el.classList.add('open');if(id==='tabTuning'){setTimeout(()=>{resizePreview();resetPreview()},80);setTimeout(resizePreview,400)}}}
function updateTabSummaries(){
  $('aimModeSummary').textContent=gameMode.toUpperCase();
  const isDefault=tuneSizeLv1===45&&tuneSizeLv25===14&&tuneSpeedLv1===0.8&&tuneSpeedLv25===4.5&&tuneVisLv1===3.0&&tuneVisLv25===0.55&&tuneSpawnLv1===2.0&&tuneSpawnLv25===0.35;
  $('tuningSummary').textContent=isDefault?'Default':'Custom';
  const mathStr=mathEnabled?'Math ON':'Math OFF';
  const rds=totalRounds+' rds';
  const cap=mathEnabled?' \u2022 cap '+targetCap:'';
  $('roundsSummary').textContent=rds+' \u2022 '+mathStr+cap;
  $('stressorSummary').textContent=stressorEnabled?'ON':'OFF';
}
updateTabSummaries();
// ═══════════════ SPEED / SIZE TUNING ═══════════════
function restoreTune(){const t=demoSavedTune;tuneSizeLv1=t.s1;tuneSizeLv25=t.s25;tuneSpeedLv1=t.sp1;tuneSpeedLv25=t.sp25;tuneVisLv1=t.v1;tuneVisLv25=t.v25;tuneSpawnLv1=t.si1;tuneSpawnLv25=t.si25}
function readTuning(){
  tuneSizeLv1=Math.max(5,parseFloat($('sizeLv1').value)||45);
  tuneSizeLv25=Math.max(5,parseFloat($('sizeLv25').value)||14);
  tuneSpeedLv1=Math.max(0.1,parseFloat($('speedLv1').value)||0.8);
  tuneSpeedLv25=Math.max(0.1,parseFloat($('speedLv25').value)||4.5);
  tuneVisLv1=Math.max(0.1,parseFloat($('visLv1').value)||3.0);
  tuneVisLv25=Math.max(0.1,parseFloat($('visLv25').value)||0.55);
  tuneSpawnLv1=Math.max(0.1,parseFloat($('spawnIntLv1').value)||2.0);
  tuneSpawnLv25=Math.max(0.1,parseFloat($('spawnIntLv25').value)||0.35);
}
// ═══════════════ LIVE TUNING PREVIEW ═══════════════
const prevCvs=$('tuningPreview'),prevCtx=prevCvs.getContext('2d');
let prevAnim=null,prevTgts=[],prevLastT=0,prevNextSpawn=0;

function resizePreview(){
  const rect=prevCvs.getBoundingClientRect();
  prevCvs.width=rect.width*devicePixelRatio;
  prevCvs.height=rect.height*devicePixelRatio;
  prevCtx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
resizePreview();
window.addEventListener('resize',resizePreview);

function updatePreviewStats(){
  const t=(level-1)/24;
  const sz=lerp(tuneSizeLv1,tuneSizeLv25,t).toFixed(1);
  const spd=lerp(tuneSpeedLv1,tuneSpeedLv25,t).toFixed(1);
  const vis=Math.max(0.15,lerp(tuneVisLv1,tuneVisLv25,t)).toFixed(2);
  const spn=Math.max(0.1,lerp(tuneSpawnLv1,tuneSpawnLv25,t)).toFixed(2);
  const pats=getPatterns(level);
  if(gameMode==='moving') $('previewStats').textContent='Lv'+level+' — r:'+sz+'px  spd:'+spd+'  active: '+pats.join(', ');
  else $('previewStats').textContent='Lv'+level+' — r:'+sz+'px  vis:'+vis+'s  gap:'+spn+'s';
}

// Preview scale: proportionally shrink from a 1200x800 reference game canvas
function prevSc(){const w=prevCvs.width/devicePixelRatio,h=prevCvs.height/devicePixelRatio;return Math.min(w/1200,h/800)}

// Plain-object target with same fields as real Target constructor
function mkPrevTgt(x,y,r,s,pat,pd,lifespan){
  const now=performance.now();
  return{x,y,prevX:x,prevY:y,baseX:x,baseY:y,radius:r,speed:s,pattern:pat,pd,
    alive:true,spawnTime:now,phase:Math.random()*Math.PI*2,
    opacity:0,fadeIn:true,
    lifespan:lifespan||0,expiresAt:lifespan?(now+lifespan*1000):0,
    expired:false,fadeOut:false};
}

// ── Exact same update logic as Target.update() ──
function prevUpdateTgt(tgt,dt,now,W,H){
  if(!tgt.alive)return;
  tgt.prevX=tgt.x;tgt.prevY=tgt.y;
  if(tgt.fadeIn){tgt.opacity=Math.min(1,tgt.opacity+dt*6);if(tgt.opacity>=1)tgt.fadeIn=false}
  if(tgt.fadeOut){tgt.opacity=Math.max(0,tgt.opacity-dt*5);if(tgt.opacity<=0){tgt.alive=false;tgt.expired=true}return}
  if(tgt.lifespan>0&&now>=tgt.expiresAt&&!tgt.fadeOut){tgt.fadeOut=true;return}
  if(tgt.pattern==='reflex'){
    const pulse=Math.sin((now-tgt.spawnTime)/1000*3)*2;
    tgt.x=tgt.baseX+pulse;tgt.y=tgt.baseY+pulse*0.5;
    tgt.x=clamp(tgt.x,tgt.radius+4,W-tgt.radius-4);
    tgt.y=clamp(tgt.y,tgt.radius+4,H-tgt.radius-4);
    return;
  }
  const t=(now-tgt.spawnTime)/1000,s=tgt.speed,pd=tgt.pd;
  switch(tgt.pattern){
    case'linear':tgt.x=tgt.baseX+Math.sin(t*s+tgt.phase)*pd.ampX;break;
    case'circle':tgt.x=tgt.baseX+Math.cos(t*s+tgt.phase)*pd.r;tgt.y=tgt.baseY+Math.sin(t*s+tgt.phase)*pd.r;break;
    case'figure8':tgt.x=tgt.baseX+Math.sin(t*s+tgt.phase)*pd.aX;tgt.y=tgt.baseY+Math.sin(t*s*2+tgt.phase)*pd.aY;break;
    case'zigzag':{const p=2/s,tp=((t+tgt.phase)%p)/p;tgt.x=tgt.baseX+(tp<.5?lerp(-1,1,tp*2):lerp(1,-1,(tp-.5)*2))*pd.aX;tgt.y=tgt.baseY+Math.sin(t*s*1.5)*pd.aY;break}
    case'teleport':if(Math.random()<pd.tc*dt){tgt.baseX=clamp(tgt.baseX+(Math.random()-.5)*pd.td,tgt.radius+20,W-tgt.radius-20);tgt.baseY=clamp(tgt.baseY+(Math.random()-.5)*pd.td,tgt.radius+20,H-tgt.radius-20)}tgt.x=tgt.baseX+Math.sin(t*s*3)*15;tgt.y=tgt.baseY+Math.cos(t*s*2.5)*12;break;
    case'spiral':{const st=t*s,sr=pd.bR+Math.sin(st*.5)*pd.aR;tgt.x=tgt.baseX+Math.cos(st+tgt.phase)*sr;tgt.y=tgt.baseY+Math.sin(st+tgt.phase)*sr;break}
    case'chaos':tgt.x=tgt.baseX+Math.sin(t*s+tgt.phase)*pd.a1+Math.cos(t*s*1.7+tgt.phase*.5)*pd.a2;tgt.y=tgt.baseY+Math.cos(t*s*1.3+tgt.phase)*pd.a3+Math.sin(t*s*2.1+tgt.phase*1.3)*pd.a4;break;
    case'dash':{const cy=(t*s)%4;if(cy>=1&&cy<1.3){const dp=(cy-1)/.3;tgt.x=tgt.baseX+dp*pd.dX;tgt.y=tgt.baseY+dp*pd.dY}else if(cy>=1.3&&cy<2.3){tgt.x=tgt.baseX+pd.dX;tgt.y=tgt.baseY+pd.dY}else if(cy>=2.3&&cy<2.6){const dp=(cy-2.3)/.3;tgt.x=tgt.baseX+(1-dp)*pd.dX;tgt.y=tgt.baseY+(1-dp)*pd.dY}break}
  }
  tgt.x=clamp(tgt.x,tgt.radius+4,W-tgt.radius-4);
  tgt.y=clamp(tgt.y,tgt.radius+4,H-tgt.radius-4);
}

// ── Exact same draw logic as Target.draw() ──
function prevDrawTgt(tgt,c){
  if(!tgt.alive||tgt.opacity<=0)return;
  const r=tgt.radius;
  c.save();c.globalAlpha=tgt.opacity;
  const g=c.createRadialGradient(tgt.x,tgt.y,r*.3,tgt.x,tgt.y,r*1.5);
  g.addColorStop(0,'rgba(255,45,149,.3)');g.addColorStop(1,'rgba(255,45,149,0)');
  c.fillStyle=g;c.beginPath();c.arc(tgt.x,tgt.y,r*1.5,0,Math.PI*2);c.fill();
  c.fillStyle='rgba(255,45,149,.15)';c.strokeStyle='rgba(255,45,149,.8)';c.lineWidth=2;
  c.beginPath();c.arc(tgt.x,tgt.y,r,0,Math.PI*2);c.fill();c.stroke();
  c.strokeStyle='rgba(255,255,255,.3)';c.lineWidth=1;
  c.beginPath();c.arc(tgt.x,tgt.y,r*.65,0,Math.PI*2);c.stroke();
  c.strokeStyle='rgba(255,255,255,.5)';
  c.beginPath();c.arc(tgt.x,tgt.y,r*.3,0,Math.PI*2);c.stroke();
  c.fillStyle='#ff2d95';c.beginPath();c.arc(tgt.x,tgt.y,r*.12,0,Math.PI*2);c.fill();
  // Countdown ring (reflex)
  if(tgt.lifespan>0&&!tgt.fadeOut){
    const now=performance.now();const elapsed=(now-tgt.spawnTime)/1000;
    const remain=Math.max(0,1-elapsed/tgt.lifespan);
    const ringR=r+8;const startA=-Math.PI/2;const endA=startA+remain*Math.PI*2;
    const rc=remain>0.6?'rgba(0,240,255,.8)':remain>0.3?'rgba(255,230,0,.9)':'rgba(255,0,60,.9)';
    c.strokeStyle=rc;c.lineWidth=3;c.beginPath();c.arc(tgt.x,tgt.y,ringR,startA,endA);c.stroke();
    c.lineWidth=1;c.strokeStyle='rgba(255,255,255,.08)';c.beginPath();c.arc(tgt.x,tgt.y,ringR,0,Math.PI*2);c.stroke();
  }
  c.restore();
}

function spawnPrevMoving(pat,idx,total){
  const w=prevCvs.width/devicePixelRatio,h=prevCvs.height/devicePixelRatio;
  const t=(level-1)/24,sc=prevSc();
  const r=Math.max(4,lerp(tuneSizeLv1,tuneSizeLv25,t)*sc);
  const s=lerp(tuneSpeedLv1,tuneSpeedLv25,t);
  const pd=getPatData(pat,level);
  const spd={};for(const k in pd)spd[k]=typeof pd[k]==='number'?pd[k]*sc:pd[k];
  // Spread targets in 4×2 grid
  const cols=4,rows=2;
  const col=idx%cols,row=Math.floor(idx/cols);
  const cellW=w/cols,cellH=h/rows;
  const x=cellW*(col+0.5);
  const y=cellH*(row+0.5);
  return mkPrevTgt(x,y,r,s,pat,spd);
}

function spawnPrevReflex(){
  const w=prevCvs.width/devicePixelRatio,h=prevCvs.height/devicePixelRatio;
  const t=(level-1)/24,sc=prevSc();
  const r=Math.max(4,lerp(tuneSizeLv1,tuneSizeLv25,t)*sc);
  const life=Math.max(0.15,lerp(tuneVisLv1,tuneVisLv25,t));
  const m=r+10;
  const x=m+Math.random()*(w-m*2);
  const y=m+Math.random()*(h-m*2);
  return mkPrevTgt(x,y,r,0,'reflex',{},life);
}

function resetPreview(){
  prevTgts=[];prevLastT=performance.now();
  if(gameMode==='moving'){
    const allPats=['linear','circle','figure8','zigzag','spiral','teleport','chaos','dash'];
    allPats.forEach((pat,i)=>prevTgts.push(spawnPrevMoving(pat,i,allPats.length)));
  }else{
    prevTgts.push(spawnPrevReflex());
    prevNextSpawn=performance.now()+Math.max(0.1,lerp(tuneSpawnLv1,tuneSpawnLv25,(level-1)/24))*1000;
  }
}

function drawPreviewFrame(now){
  const w=prevCvs.width/devicePixelRatio,h=prevCvs.height/devicePixelRatio;
  const c=prevCtx;
  c.clearRect(0,0,w,h);
  const dt=Math.min(0.05,(now-prevLastT)/1000);
  prevLastT=now;

  if(gameMode==='moving'){
    const activePats=getPatterns(level);
    for(const tgt of prevTgts){
      prevUpdateTgt(tgt,dt,now,w,h);
      const active=activePats.includes(tgt.pattern);
      if(!active){const origOp=tgt.opacity;tgt.opacity*=0.2;prevDrawTgt(tgt,c);tgt.opacity=origOp}
      else{prevDrawTgt(tgt,c)}
    }
    prevTgts=prevTgts.filter(t=>t.alive);
    // If any died (shouldn't for moving, but safety), respawn full set
    if(prevTgts.length===0){const allPats=['linear','circle','figure8','zigzag','spiral','teleport','chaos','dash'];allPats.forEach((p,i)=>prevTgts.push(spawnPrevMoving(p,i,allPats.length)))}
    // Draw pattern labels under each target; dim inactive ones
    c.font='8px Share Tech Mono';c.textAlign='center';
    for(const tgt of prevTgts){
      const active=activePats.includes(tgt.pattern);
      if(!active){c.globalAlpha=0.25}
      c.fillStyle=active?'rgba(57,255,20,.4)':'rgba(255,255,255,.15)';
      c.fillText(tgt.pattern,tgt.x,tgt.y+tgt.radius+12);
      c.globalAlpha=1;
    }
  }else{
    for(const tgt of prevTgts){prevUpdateTgt(tgt,dt,now,w,h);prevDrawTgt(tgt,c)}
    prevTgts=prevTgts.filter(t=>t.alive);
    // Spawn on interval
    if(now>=prevNextSpawn){
      prevTgts.push(spawnPrevReflex());
      const gap=Math.max(0.1,lerp(tuneSpawnLv1,tuneSpawnLv25,(level-1)/24));
      prevNextSpawn=now+gap*1000;
      if(prevTgts.length>3)prevTgts.shift();
    }
    // Spawn countdown
    const remain=Math.max(0,(prevNextSpawn-now)/1000);
    c.fillStyle='rgba(255,255,255,.1)';c.font='9px Share Tech Mono';c.textAlign='right';
    c.fillText('next: '+remain.toFixed(1)+'s',w-6,12);
  }
  // Scale label
  const sc=prevSc();
  if(sc<0.95){c.fillStyle='rgba(255,255,255,.12)';c.font='8px Share Tech Mono';c.textAlign='right';c.fillText(Math.round(sc*100)+'% scale',w-6,h-4)}
}

function previewLoop(now){
  if(!$('menuScreen').classList.contains('active')){prevAnim=null;return}
  drawPreviewFrame(now);
  prevAnim=requestAnimationFrame(previewLoop);
}
function startPreview(){resetPreview();updatePreviewStats();if(!prevAnim)prevAnim=requestAnimationFrame(previewLoop)}

// Wire events
function onTuningChange(){readTuning();resetPreview();updatePreviewStats();updateTabSummaries()}
document.querySelectorAll('.tuning-input').forEach(inp=>{
  inp.addEventListener('input',onTuningChange);
  inp.addEventListener('change',onTuningChange);
});
levelSlider.addEventListener('input',()=>{resetPreview();updatePreviewStats()});
document.querySelectorAll('.mode-btn').forEach(b=>b.addEventListener('click',()=>{setTimeout(()=>{resetPreview();updatePreviewStats()},10)}));

startPreview();
// ═══════════════ MATH TOGGLE ═══════════════
const mathToggle=$('mathToggle');
function updateMathUI(){
  mathToggle.classList.toggle('active',mathEnabled);
  $('mathHint').textContent=mathEnabled?'Target count = your math answer':'Aim training only — no math questions';
  $('mathHint').style.color=mathEnabled?'rgba(0,240,255,.35)':'rgba(255,230,0,.4)';
  $('targetCountSection').style.display=mathEnabled?'none':'';
  // Hide cap section when math is off (cap only applies to math-derived target counts)
  capSlider.closest('.target-cap-container').style.display=mathEnabled?'':'none';
}
mathToggle.addEventListener('click',()=>{mathEnabled=!mathEnabled;updateMathUI();updateTabSummaries()});
const tcsSlider=$('targetCountSlider'),tcsValue=$('targetCountValue'),tcsMaxInput=$('targetCountMaxInput'),tcsMaxLabel=$('targetCountMaxLabel');
tcsSlider.addEventListener('input',()=>{noMathTargetCount=+tcsSlider.value;tcsValue.textContent=noMathTargetCount});
tcsMaxInput.addEventListener('input',()=>{let v=parseInt(tcsMaxInput.value)||1;if(v<1)v=1;tcsSlider.max=v;tcsMaxLabel.textContent=v;if(+tcsSlider.value>v){tcsSlider.value=v;noMathTargetCount=v;tcsValue.textContent=v}});
tcsMaxInput.addEventListener('blur',()=>{let v=parseInt(tcsMaxInput.value)||1;if(v<1){v=1;tcsMaxInput.value=1}tcsSlider.max=v;tcsMaxLabel.textContent=v;if(+tcsSlider.value>v){tcsSlider.value=v;noMathTargetCount=v;tcsValue.textContent=v}});
const capSlider=$('capSlider'),capValue=$('capValue'),capMaxInput=$('capMaxInput'),capMaxLabel=$('capMaxLabel');
capSlider.addEventListener('input',()=>{targetCap=+capSlider.value;capValue.textContent=targetCap;updateTabSummaries()});
capMaxInput.addEventListener('input',()=>{let v=parseInt(capMaxInput.value)||1;if(v<1)v=1;capSlider.max=v;capMaxLabel.textContent=v;if(+capSlider.value>v){capSlider.value=v;targetCap=v;capValue.textContent=v}});
capMaxInput.addEventListener('blur',()=>{let v=parseInt(capMaxInput.value)||1;if(v<1){v=1;capMaxInput.value=1}capSlider.max=v;capMaxLabel.textContent=v;if(+capSlider.value>v){capSlider.value=v;targetCap=v;capValue.textContent=v}});
$('startBtn').addEventListener('click',()=>{demoMode=false;level=+levelSlider.value;targetCap=Math.max(1,+capSlider.value);lastAnswer=-1;currentRound=0;score=0;roundHistory=[];comboCount=0;maxCombo=0;clutchMathCount=0;clutchShotCount=0;clutchOpportunities=0;
  if(stressorEnabled){startStressorFlow()}else{nextRound()}
});
$('nextRoundBtn').addEventListener('click',()=>{if(demoMode)demoNextStep();else nextRound()});
$('playAgainBtn').addEventListener('click',()=>{demoMode=false;$('demoBanner').classList.remove('visible');showScreen('menuScreen')});

// ═══════════════ STRESSOR TOGGLE ═══════════════
const stressorToggle=$('stressorToggle');
stressorToggle.addEventListener('click',()=>{stressorEnabled=!stressorEnabled;stressorToggle.classList.toggle('active',stressorEnabled);$('stressorHint').textContent=stressorEnabled?'Adds emotional stakes to sharpen focus under pressure':'';updateTabSummaries()});

// ═══════════════ STRESSOR QUESTION POOL ═══════════════
const STRESSOR_QUESTIONS=[
  'What is the most important thing in your life right now?',
  'Who would you put yourself in danger to protect?',
  'What would you fight to defend if it was threatened?',
  'What is one thing you could never afford to lose?',
  'What drives you to keep pushing when everything feels impossible?',
  'Who is counting on you to succeed?',
  'What responsibility do you carry that you refuse to fail at?',
  'What would you sacrifice everything to keep safe?'
];

// ═══════════════ STRESSOR SCENARIO ENGINE ═══════════════
const STRESSOR_KEYWORDS={
  person:['mom','dad','mother','father','wife','husband','partner','girlfriend','boyfriend','brother','sister','son','daughter','friend','family','grandma','grandpa','grandmother','grandfather','fiancé','fiancee','spouse','parent','parents','best friend','loved one','significant other'],
  pet:['dog','cat','pet','puppy','kitten','animal'],
  career:['job','career','business','company','work','promotion','degree','school','education','grades','college','university','profession','startup'],
  home:['home','house','apartment','property','neighborhood','community'],
  health:['health','life','survival','wellbeing','fitness','strength','recovery'],
  financial:['money','savings','finances','income','rent','debt','investment','retirement','financial'],
  dream:['dream','goal','ambition','passion','purpose','future','legacy','freedom'],
  team:['team','squad','crew','unit','group','organization','coworkers','colleagues','platoon']
};
function detectCategory(answer){const low=answer.toLowerCase();for(const[cat,words]of Object.entries(STRESSOR_KEYWORDS)){for(const w of words){if(low.includes(w))return{category:cat,matched:w}}}return{category:'general',matched:answer}}
const SCENARIOS={
  person:[
    (a)=>`${a} is trapped behind a collapsing structure. Emergency teams are overwhelmed and you are the only one close enough to act. Every target you hit clears debris from the exit path. Every miss lets the walls close in.`,
    (a)=>`An armed threat has ${a} pinned down. They cannot move until you neutralize every target between you and them. Your accuracy determines whether you reach them in time.`,
    (a)=>`${a} is stranded in hostile territory with no way out. You are providing cover from a distance. Each target you eliminate removes a threat from their escape path.`
  ],
  pet:[(a)=>`Your ${a} is trapped in a burning structure. The fire suppression system requires precision shots to activate barriers against the flames. Every hit holds back the fire. Every miss lets it advance.`],
  career:[(a)=>`Everything you have built with your ${a} is on the line. A critical system failure is cascading through your operation. Each target is a node you must restore. Miss one and the failure spreads.`],
  home:[(a)=>`A devastating threat is bearing down on your ${a}. The defense system requires manual target acquisition to activate protective barriers. Each hit raises a shield. Each miss leaves a section exposed.`],
  health:[(a)=>`Your ${a} is failing. A critical system needs precise calibration that only you can perform. Each target you hit restores a vital function. Each miss delays recovery.`],
  financial:[(a)=>`Your ${a} is under attack. A hostile system is draining everything you have built. Each target you destroy blocks a breach. Each miss lets another drain open.`],
  dream:[(a)=>`The path to your ${a} is closing. Obstacles are materializing between you and the future you have been building. Each target you destroy removes a barrier. Each miss lets the path narrow.`],
  team:[(a)=>`Your ${a} is pinned down and outnumbered. Communications are cut. You are the only one in position to provide supporting fire. Each target you eliminate removes a direct threat.`],
  general:[(a)=>`Everything connected to "${a}" is under siege. A relentless threat is closing in and the only defense is your ability to eliminate every target with precision.`]
};

// ═══════════════ COMPOSITIONAL MESSAGE ENGINE ═══════════════
// Messages = opener + subject + closer, assembled from large pools.
// 8 openers × 15 subjects × 8 closers = 960 unique combinations per perf tier per category.
// Guaranteed no repeats across any number of rounds via usedStressorMsgs set.
const MSG_PARTS={
  person:{
    openers_first:['The mission has begun.','This is real. Right now.','No one else is coming.','The clock started the moment they called for help.','You are the only one who answered.','Everything depends on what you do next.','There is no backup plan.','The situation just escalated.'],
    openers_great:['Your precision is making the difference.','Every shot you landed mattered.','The path is clearing because of you.','Your accuracy spoke louder than words.','That last round bought precious time.','Your performance is keeping hope alive.','You proved you can handle this.','Momentum is on your side.'],
    openers_decent:['Progress is being made but not fast enough.','Some of your shots landed but not enough of them.','The situation is not getting worse but it is not getting better either.','You are moving in the right direction but too slowly.','There is room for improvement and no room for complacency.','Your performance was acceptable but acceptable is not enough right now.','Half measures will not save anyone.','You showed flashes of skill but inconsistency is dangerous.'],
    openers_poor:['That was not good enough.','Your mistakes just made things worse.','The situation deteriorated because of your performance.','What just happened cannot happen again.','You failed that round and the consequences are real.','Every miss you made had a cost.','That round was a disaster and there is no sugarcoating it.','The margin for error just got thinner because of you.'],
    subjects:(a)=>[`${a} is counting on you and you alone.`,`${a} can hear every shot you fire.`,`${a} is holding on by sheer willpower.`,`${a} does not know if you are coming.`,`${a} is trapped and the walls are shifting.`,`${a} is running out of time.`,`The debris between you and ${a} is still thick.`,`${a} is calling your name.`,`The path to ${a} gets narrower every second.`,`${a} is fighting to stay conscious.`,`${a} has no idea how close you are.`,`Every second ${a} waits feels like an hour.`,`${a} is depending on someone they cannot even see.`,`The gap between you and ${a} is still dangerous.`,`${a} needs you to be better than your last attempt.`],
    closers_great:['Keep this standard.','Do not let up now.','Maintain this level of precision.','Stay locked in and finish this.','This is the pace that saves them.','Channel this focus into every round.','You know what peak performance feels like now.','Do not get comfortable. Stay sharp.'],
    closers_decent:['Tighten your aim this round.','You need to be sharper.','Step it up or the window closes.','Focus harder than you did last time.','This round needs to be better.','Show more precision than that.','The clock does not care about your excuses.','Prove you can do better.'],
    closers_poor:['Get it together. Now.','Do not fail again.','This has to change immediately.','Redeem yourself this round.','There may not be another chance after this.','Whatever that was, leave it behind. Be better.','The cost of another failure is unthinkable.','Fix this or live with the consequences.']
  },
  pet:{
    openers_first:['The alarm just sounded.','Smoke is already visible.','You can hear them in there.','The flames are spreading fast.','There is no time to hesitate.','The structure is compromised and your pet is inside.','First responders are not here yet. You are.','The fire suppression system is your only tool.'],
    openers_great:['The fire is being held back because of your accuracy.','Barriers are activating cleanly.','Your precision is creating a safe corridor.','The flames retreated where your shots landed.','Your shots are making a visible difference.','Temperature dropping in the safe zones you activated.','The fire cannot advance where you aimed true.','Your accuracy is the only thing between the fire and your pet.'],
    openers_decent:['Some barriers activated but gaps remain.','The fire slowed but did not stop.','Partial coverage is not enough.','You held some ground but lost other sections.','The safe corridor has holes in it.','Mixed results. The fire is probing for weakness.','Your pet needs more coverage than that.','The flames found openings where your shots missed.'],
    openers_poor:['The fire just surged past your failed barriers.','A new section ignited because you missed.','The heat spiked dangerously.','Your pet yelped. The fire got closer.','Smoke is thickening where you failed to activate suppression.','The corridor you were building just collapsed.','Flames reached a critical area because of your misses.','Your pet is more scared now than before you started.'],
    subjects:(a)=>[`Your ${a} is huddled in the shrinking safe zone.`,`Your ${a} does not understand what is happening.`,`Your ${a} is counting on instinct alone.`,`The fear in your ${a} is palpable.`,`Your ${a} is trying to find a way out.`,`The temperature around your ${a} is still rising.`,`Your ${a} trusts you even now.`,`Your ${a} has nowhere left to go.`,`Smoke is getting closer to your ${a}.`,`Your ${a} is panting from the heat.`,`The safe zone around your ${a} is fragile.`,`Your ${a} needs the corridor opened now.`,`Every second of heat exposure puts your ${a} at greater risk.`,`Your ${a} is alone and afraid.`,`The barrier protecting your ${a} is the one you build with your shots.`],
    closers_great:['Keep the barriers strong.','Do not let a single flame through.','Maintain this pace and they make it out.','Your accuracy is their lifeline.','One more round like that and the corridor is clear.','Stay precise. Their survival depends on it.','This is working. Do not change a thing.','The fire respects precision. Keep proving it.'],
    closers_decent:['Close the gaps this round.','More precision, fewer misses.','Every barrier you miss is a hole the fire exploits.','Your pet deserves better aim than that.','Sharpen up or the fire wins.','This is not the time for average performance.','Hit every target or the corridor fails.','The fire does not give second chances.'],
    closers_poor:['Fix this before it is too late.','Your pet is running out of time because of you.','Another round like that and the fire wins.','Do better or lose them.','The flames do not care about your excuses.','This is on you. Make it right.','No more missed shots. Not one.','Your next round determines whether the fire or you wins.']
  },
  career:{
    openers_first:['The cascade has started.','Warning lights are flashing across every system.','The failure is spreading faster than predicted.','Every node that goes dark drags others with it.','The first sector just went offline.','Automated recovery failed. It is all manual now.','Your entire infrastructure is at stake.','The clock is ticking on total system failure.'],
    openers_great:['Nodes are coming back online thanks to your precision.','The cascade is slowing because of your accuracy.','System stability is improving measurably.','Your performance is reversing the damage.','Recovery metrics are trending positive.','Critical pathways are being restored.','The bleeding stopped where your shots landed.','Your precision just saved an entire sector.'],
    openers_decent:['Some nodes restored but the cascade continues in other sectors.','Partial recovery is not enough to stop the spread.','The system is still unstable despite your efforts.','You stopped some bleeding but new failures are emerging.','Progress is fragile and could reverse at any moment.','Your efforts helped but the deficit is still growing.','The cascade slowed but did not stop.','Inconsistent performance means inconsistent recovery.'],
    openers_poor:['Critical systems just went offline because of your misses.','The cascade accelerated. Your failures made it worse.','An entire sector collapsed because you could not hit your targets.','Recovery setback. The damage from your misses compounded.','The failure spread to systems that were stable before your round.','Your missed targets let the corruption deeper into the core.','That round actively made the situation worse.','Everything you failed to hit is now a bigger problem.'],
    subjects:(a)=>[`Your ${a} is hemorrhaging functionality.`,`The foundation of your ${a} is being tested.`,`Everything you invested in your ${a} hangs in the balance.`,`Your ${a} does not fix itself.`,`Years of work on your ${a} could disappear in minutes.`,`Your ${a} needs surgical precision right now.`,`The people depending on your ${a} are watching.`,`Your ${a} has never been this close to total failure.`,`Every node in your ${a} that dies takes others with it.`,`Your ${a} was built to last but not without maintenance.`,`The integrity of your ${a} is compromised.`,`Your ${a} is fighting back but it needs your help.`,`Stakeholders are watching your ${a} crumble in real time.`,`Your ${a} is only as strong as your weakest round.`,`The reputation of your ${a} is on the line.`],
    closers_great:['Maintain this precision and recovery is certain.','The system responds to accuracy. Keep providing it.','You are proving you deserve what you built.','Do not let up. Finish the restoration.','One more clean round and stability is within reach.','Your performance is the only variable that matters.','Keep executing at this level.','The cascade cannot survive this level of precision.'],
    closers_decent:['The system needs better from you.','Partial recovery is a slow death. Be more precise.','Sharpen your aim or watch it all crumble.','Your career does not accept half measures.','Deliver more this round or the cascade wins.','Inconsistency is not a strategy.','Step up or step aside.','Every missed target is a missed opportunity to save what you built.'],
    closers_poor:['Get it together or lose everything.','Your career cannot survive another round like that.','Whatever is holding you back, drop it now.','This is the price of failure. Pay attention.','Another round of misses and recovery becomes impossible.','You built something worth saving. Act like it.','The system is dying because of you. Fix it.','There is no one else coming to save your work.']
  },
  home:{
    openers_first:['The threat just appeared on the horizon.','Your defense system is armed and waiting for your input.','The perimeter alarm is blaring.','Nothing stands between the threat and your home except you.','The automated defenses failed. Manual override is your only option.','Your home has never been in this much danger.','The threat is closing in faster than expected.','Every window and wall is vulnerable without your barriers.'],
    openers_great:['The barrier grid is holding strong thanks to your accuracy.','Your shots activated shields in every critical zone.','The threat is being repelled where your defenses are active.','Your precision turned your home into a fortress.','Not a single section was breached where you aimed true.','Your defensive grid is solid and the threat knows it.','Every barrier you activated is doing its job.','Your accuracy is the wall the threat cannot get past.'],
    openers_decent:['Gaps in the barrier are letting the threat probe for weaknesses.','Some shields activated but coverage is incomplete.','The threat found openings where your shots missed.','Partial coverage means partial protection.','Your home is defended in some zones but exposed in others.','The barrier has weak points because of your inconsistency.','Some walls held. Others did not.','The threat is testing every gap your misses created.'],
    openers_poor:['The threat punched through where you failed to activate barriers.','A section of your home just took direct damage.','Your misses left critical areas completely exposed.','The threat breached your perimeter because of your failures.','Structural damage in sectors you failed to shield.','Everything behind your missed barriers is vulnerable.','The threat exploited every gap from your poor aim.','Your home is taking damage that could have been prevented.'],
    subjects:(a)=>[`Your ${a} contains everything that matters to you.`,`The people inside your ${a} are trusting your aim.`,`Your ${a} was not built to withstand this alone.`,`Memories inside your ${a} cannot be replaced.`,`Your ${a} is more than walls. It is your life.`,`Every room of your ${a} is a section you need to protect.`,`The safety of your ${a} is measured in barrier coverage.`,`Your ${a} has no backup defense system.`,`The foundations of your ${a} are shaking.`,`Your ${a} survived storms before but never one like this.`,`What you keep inside your ${a} defines who you are.`,`The threat does not care about the value of your ${a}.`,`Your ${a} is the only shelter anyone has right now.`,`Losing sections of your ${a} means losing parts of your life.`,`Your ${a} can be rebuilt but not if the core is destroyed.`],
    closers_great:['Keep the barriers sealed.','Not one gap. Not one breach.','Your home stands because of your aim.','Maintain this and the threat fails.','The wall you built with precision is unbreakable.','Stay focused. Total coverage is the only acceptable outcome.','Your defense grid needs to stay at this level.','The threat retreats from precision. Keep providing it.'],
    closers_decent:['Seal the gaps this round.','Your home needs full coverage, not partial.','Every opening is an invitation to destruction.','Be precise or watch sections fall.','Half-defended is half-destroyed.','Raise your standard or lower your walls.','This round needs to close every opening.','Your home cannot survive with inconsistent shielding.'],
    closers_poor:['Your home is taking damage because of you.','Fix the breaches or lose everything inside.','Another round like that and the threat wins.','Everything inside those walls is depending on you.','Your failures have real consequences. Look at the damage.','Protect what matters or watch it be destroyed.','The threat does not give grace periods.','This is not a drill. Your home is being destroyed.']
  },
  health:{
    openers_first:['The monitors are alarming.','Vital signs are dropping as you read this.','The window for intervention is narrow.','Automated systems cannot handle this. Only manual calibration works.','The first critical function just started failing.','Time is the enemy now.','Every second without precision calibration makes recovery harder.','The system needs you operating at peak performance.'],
    openers_great:['Vitals are stabilizing because of your precision.','The calibration is holding. Functions are returning.','Your accuracy is directly reflected in the recovery metrics.','Critical pathways are reopening thanks to your shots.','The system is responding positively to your precision.','Recovery is accelerating because of your performance.','Your last round restored functions that were almost lost.','Life signs are improving measurably because of you.'],
    openers_decent:['Some functions restored but others are still declining.','Partial calibration is keeping things alive but not improving them.','The system is treading water because of your mixed results.','Stability is fragile and your inconsistency is not helping.','Some metrics improved while others worsened.','You stopped the freefall but recovery is stalled.','The system needs consistent precision, not sporadic.','Your efforts are keeping things alive but not healing them.'],
    openers_poor:['A critical function flatlined because of your misses.','Your failures caused a cascade of secondary failures.','The system took a severe hit from your inaccuracy.','Recovery was set back significantly by your round.','Functions that were stabilizing destabilized because of you.','Your misses introduced new complications.','The window for full recovery just got smaller.','What was salvageable is now critical because of your performance.'],
    subjects:(a)=>[`Your ${a} does not have infinite resilience.`,`Every function of your ${a} depends on precise calibration.`,`Your ${a} is fighting but it cannot fight alone.`,`The fragility of your ${a} is apparent with every missed shot.`,`Your ${a} has systems that will not restart if they fail completely.`,`The balance keeping your ${a} functional is delicate.`,`Your ${a} needs sustained precision, not bursts of effort.`,`Recovery of your ${a} is measured in the accuracy of your hands.`,`Your ${a} is more resilient than you think but not invincible.`,`Each calibration point you hit restores something irreplaceable.`,`The systems governing your ${a} do not tolerate errors well.`,`Your ${a} is at a crossroads between recovery and decline.`,`What happens to your ${a} next is entirely in your hands.`,`Your ${a} has been through worse but never without help.`,`The margin between recovery and permanent damage is razor thin.`],
    closers_great:['Maintain this calibration standard.','Your precision is the medicine.','Keep the readings moving in the right direction.','Consistency at this level means full recovery.','Do not deviate from this pace.','You are proving that recovery is possible.','Stay at this level and stability is assured.','The system trusts your hands now.'],
    closers_decent:['More precision is needed for real recovery.','Treading water is not healing.','Aim for restoration, not maintenance.','Your calibration needs to improve this round.','Partial effort means partial recovery.','Be more precise or accept a worse outcome.','The system needs better from you.','Good enough is not good enough for survival.'],
    closers_poor:['Fix this before permanent damage sets in.','Your inaccuracy is actively causing harm.','Another round like that and recovery becomes impossible.','The system cannot absorb more of your failures.','Precision is not optional. It is survival.','Every miss has a physiological cost.','There is a point of no return and you are approaching it.','Do better. There is no alternative.']
  },
  financial:{
    openers_first:['The breach alerts just started firing.','Your accounts are being drained in real time.','The attack is automated and relentless.','Security protocols failed. Manual intervention is your only option.','Every second you delay, more is lost.','The hostile system found a way in.','Your financial infrastructure is under siege.','The drains opened simultaneously across multiple accounts.'],
    openers_great:['Breaches are being sealed. Your precision is saving your assets.','The attack is faltering against your accuracy.','Drains blocked. Your financial position is stabilizing.','Your shots are directly converting to saved resources.','The hostile system is retreating from the sectors you secured.','Your precision created a firewall the attack cannot penetrate.','Recovery of stolen assets has begun thanks to your accuracy.','The bleeding stopped where your aim was true.'],
    openers_decent:['Some breaches sealed but new ones are opening.','The attack adapted around your partial defenses.','You slowed the drain but did not stop it.','Financial losses are continuing despite your efforts.','Inconsistent defense means inconsistent protection.','The hostile system is finding gaps in your coverage.','Some accounts secured, others still hemorrhaging.','Your performance bought time but did not solve the problem.'],
    openers_poor:['A major breach opened because you missed.','The attack intensified after exploiting your failures.','Significant assets were lost during your last round.','Your misses directly translated to financial losses.','The hostile system gained ground because of your inaccuracy.','Accounts that were stable are now compromised because of you.','Your failures opened attack vectors that did not exist before.','The drain accelerated after your poor performance.'],
    subjects:(a)=>[`Your ${a} represents years of sacrifice.`,`People depend on your ${a} being secure.`,`Your ${a} is the foundation of everything you have planned.`,`Losing your ${a} means starting from zero.`,`Your ${a} does not regenerate on its own.`,`The attack does not care how hard you worked for your ${a}.`,`Your ${a} is being tested by something that does not sleep.`,`Every resource in your ${a} has a purpose you cannot afford to lose.`,`Your ${a} is more vulnerable than you ever imagined.`,`The security of your ${a} is only as strong as your aim.`,`Your ${a} was supposed to be your safety net.`,`What drains from your ${a} does not come back easily.`,`Your ${a} is under the most sustained attack it has ever faced.`,`The people who depend on your ${a} do not know it is under attack.`,`Your ${a} will not survive sustained incompetence.`],
    closers_great:['Keep every breach sealed.','Your precision is the best firewall.','Maintain this defense and the attack fails.','Not one drain gets through. That is the standard.','The attack breaks against consistent accuracy.','Stay at this level and everything is recovered.','Your financial future depends on maintaining this pace.','Block everything. Leave nothing open.'],
    closers_decent:['Seal every breach this round.','Partial defense is partial loss.','Your assets need complete coverage.','More precision or more losses. Choose.','The attack exploits every gap.','Step up your defense this round.','What you lose from missed shots does not come back.','Financial security requires consistent accuracy.'],
    closers_poor:['Stop the bleeding or lose everything.','Your failures are being measured in lost assets.','Another round like that and recovery is off the table.','Whatever you have left depends on the next round.','The attack thanks you for every miss.','Get precise or get wiped out.','Your financial future is dying because of you.','There is nothing left to lose if you do not change now.']
  },
  dream:{
    openers_first:['The first barriers just materialized.','The path you have been building toward is under attack.','Obstacles are rising between you and everything you wanted.','The door you have been working toward just started closing.','Your future is being walled off in real time.','The path does not stay open by itself.','Everything you have been working toward is suddenly at risk.','The obstacles do not care how long you have been dreaming.'],
    openers_great:['The path is widening because of your precision.','Barriers are falling and your future is getting clearer.','Your accuracy is carving the path forward.','Obstacles crumbled under your precise fire.','The door opened wider after your last round.','Your shots are building momentum toward your goal.','The path you cleared is holding because of your precision.','Your future got brighter with every target you hit.'],
    openers_decent:['Some barriers fell but new ones replaced them.','The path opened slightly but it is still too narrow.','Progress is being made but it is not enough.','You pushed forward but the obstacles pushed back.','The door cracked open but it is not wide enough yet.','Partial barrier removal means partial path forward.','Your efforts moved the needle but not far enough.','The path is no wider than your precision allows.'],
    openers_poor:['New barriers rose where you failed to destroy them.','The path just narrowed significantly because of your misses.','The door closed further after your poor performance.','Your failures are literally building walls between you and your future.','Obstacles multiplied in the zones you missed.','The gap to your goal just widened.','Your inaccuracy strengthened the very barriers you need to destroy.','Everything you failed to hit became a bigger obstacle.'],
    subjects:(a)=>[`Your ${a} is still possible but the window is shrinking.`,`Everything you sacrificed for your ${a} led to this moment.`,`Your ${a} does not wait for people who hesitate.`,`The distance between you and your ${a} is measured in precision.`,`Your ${a} was never guaranteed. It was always earned.`,`Other people gave up on their version of your ${a}. You did not.`,`Your ${a} is testing whether you deserve to reach it.`,`The obstacles between you and your ${a} are not random. They are a test.`,`Your ${a} is watching how you perform under pressure.`,`Every barrier you fail to destroy is another year between you and your ${a}.`,`Your ${a} rewards action, not intention.`,`The universe does not owe you your ${a}. You owe it to yourself.`,`Your ${a} is closer than it was before but still not close enough.`,`What separates you from your ${a} is discipline under pressure.`,`Your ${a} demands the version of you that does not miss.`],
    closers_great:['Keep clearing the path.','Your precision is opening the future.','Do not slow down. The goal is in sight.','This is the performance that changes your life.','Maintain this and nothing can stop you.','Your aim is your ambition made physical.','The path stays open as long as your accuracy does.','One more round like that and you are through.'],
    closers_decent:['Clear more barriers this round.','The path needs to be wider.','Your dream needs better aim than that.','Ambition without precision is just wishing.','Do not let inconsistency steal your future.','Push harder this round.','Almost is not the same as through.','The path demands more from you.'],
    closers_poor:['Your dream is dying because of your misses.','Act like your future depends on it. Because it does.','Another failure and the door shuts permanently.','Everything you worked for is disappearing because of you.','Your inaction is an action. And it is the wrong one.','Break through or be walled off forever.','The obstacles do not feel sorry for you.','Your future has a deadline and you are wasting it.']
  },
  team:{
    openers_first:['Your team just came under fire.','Communications went dark. They cannot call for help.','Multiple threats closing on your team from all sides.','Your team has no cover without your suppressing fire.','The situation just went from bad to critical.','Hostiles have your team surrounded.','Your team is pinned and you are the only asset in position.','The extraction window opens only if you clear the threats.'],
    openers_great:['Threats are dropping. Your team is advancing because of you.','Your covering fire is creating a safe corridor.','Your accuracy just saved your team from an ambush.','The threat count is decreasing because of your precision.','Your team is moving freely in the zones you cleared.','Your shots are the reason your team is still alive.','The perimeter you cleared is holding strong.','Your team knows someone has their back.'],
    openers_decent:['Some threats neutralized but your team is still taking fire.','Partial coverage is leaving flanks exposed.','Your team is moving but under constant pressure from gaps you left.','The threats you missed are regrouping.','Your suppressing fire has holes in it.','Your team appreciates the effort but needs more results.','Some zones cleared but others are still hot.','Inconsistent cover fire means inconsistent safety.'],
    openers_poor:['A threat got through your fire and hit someone.','Your team is worse off because of your missed shots.','The perimeter collapsed where your shots failed to land.','Your team is taking casualties because of your inaccuracy.','Threats you missed flanked your team.','Your poor performance just put everyone at greater risk.','Someone on your team is hurt because you missed.','The extraction route just closed because of threats you failed to eliminate.'],
    subjects:(a)=>[`Your ${a} did not choose this situation but they chose to trust you.`,`Every member of your ${a} is depending on your aim.`,`Your ${a} cannot retreat without your covering fire.`,`The morale of your ${a} rises and falls with your accuracy.`,`Your ${a} has held their ground despite everything.`,`Your ${a} is not just colleagues. They are your responsibility.`,`The lives of your ${a} are directly tied to your precision.`,`Your ${a} is fighting with everything they have.`,`Your ${a} needs you at your best. Not your average.`,`The bond with your ${a} is tested in moments like this.`,`Your ${a} would do the same for you. Do not let them down.`,`Every person in your ${a} has someone waiting for them to come home.`,`Your ${a} trusts your ability even when you doubt it.`,`The survival of your ${a} is in your hands. Literally.`,`Your ${a} has no other option but you right now.`],
    closers_great:['Keep providing clean cover.','Your team is moving because of your accuracy.','Maintain this and everyone makes it out.','Not one threat gets through. That is the mission.','Your precision is the difference between life and death.','Stay on target. Your team is counting on it.','This is what reliable cover fire looks like.','One more clean round and extraction is possible.'],
    closers_decent:['Your team needs tighter cover this round.','Close the gaps in your suppressing fire.','More threats need to fall this round.','Your team cannot advance through zones you leave hot.','Better cover fire means faster extraction.','Raise your accuracy or your team stays pinned.','Inconsistent cover gets people hurt.','Your team needs results, not effort.'],
    closers_poor:['Your team is in danger because of you.','Hit your targets or your team does not make it.','Another round like that costs lives.','Your team cannot survive your failures.','Get accurate or get people killed.','There is no room for the performance you just showed.','Fix your aim. Their lives depend on it.','You owe your team better than what you just gave them.']
  },
  general:{
    openers_first:['The threat materialized without warning.','Everything you value is now under direct attack.','The defense grid is armed. Only your shots activate it.','The assault has begun and there is no one else to stop it.','Your most important priority is in the crosshairs.','The first wave is approaching fast.','You are the last line of defense.','The attack is real and it is happening now.'],
    openers_great:['The threat is retreating where your shots landed.','Your precision is making a visible difference.','The defense grid is holding strong because of you.','Your accuracy turned the tide.','The assault faltered against your precision.','Ground was gained because of your performance.','Your shots are the reason the line is holding.','The threat respects accuracy and yours is undeniable.'],
    openers_decent:['The line is holding in some places and failing in others.','Your mixed performance created a mixed defense.','Some ground held but other areas were lost.','The threat adapted to your inconsistency.','Partial defense is an incomplete answer.','Your efforts slowed the threat but did not stop it.','The defense has gaps that correspond to your misses.','Average performance means average protection.'],
    openers_poor:['The threat surged forward through your failures.','Ground was lost directly because of your misses.','The defense line collapsed where your shots failed.','Your inaccuracy invited the threat deeper.','What you failed to defend is now compromised.','The assault intensified because it sensed weakness in your aim.','Your failures have tangible consequences and they just arrived.','The threat grew stronger from your incompetence.'],
    subjects:(a)=>[`"${a}" is more than a word. It is everything.`,`The thing you called "${a}" is being tested right now.`,`"${a}" does not defend itself.`,`What "${a}" means to you is measured by what you do next.`,`"${a}" has never been this vulnerable.`,`The importance of "${a}" is only real if you fight for it.`,`Everything "${a}" represents hangs in the balance.`,`"${a}" is under the most severe threat it has ever faced.`,`The future of "${a}" depends entirely on your precision.`,`"${a}" needs the version of you that does not miss.`,`People would understand if you failed. But "${a}" would not survive it.`,`What "${a}" becomes after this is up to you.`,`"${a}" is worth more than your comfort zone.`,`The value of "${a}" is proven in moments exactly like this one.`,`"${a}" asks for nothing except your best.`],
    closers_great:['Keep the line. Do not yield an inch.','Your precision is the shield.','Maintain this standard.','The threat breaks against this level of accuracy.','Stay locked in. Victory is earned through consistency.','Do not let excellence become complacency.','One more round at this level and the threat fails.','You are proving what matters to you.'],
    closers_decent:['Raise the standard this round.','Good enough is not enough for what is at stake.','Sharpen your aim or accept the consequences.','More precision, fewer excuses.','The threat does not grade on a curve.','Step up or watch what matters fall.','This round needs to be your best.','Average aim means average outcomes.'],
    closers_poor:['This is on you. All of it.','Fix your aim or lose what matters most.','Another round like that and it is over.','The cost of failure is real and growing.','Whatever held you back, abandon it now.','Your performance is destroying what you said you valued.','There are no more chances after this kind of failure.','Prove your words with your aim or they mean nothing.']
  }
};

let usedStressorMsgs=new Set();
function pickRandom(arr){return arr[Math.floor(Math.random()*arr.length)]}

function getPerfTier(prevRound){
  if(!prevRound)return 'first';
  const s=prevRound.S;const prec=s.avgPrec||0;const misses=prevRound.misses||0;const hits=prevRound.hits||0;
  const total=hits+misses;const hitRate=total>0?hits/total:0;
  if(!prevRound.mathCorrect)return 'poor';
  if(prec<40||hitRate<0.6)return 'poor';
  if(prec>=70&&hitRate>=0.8)return 'great';
  return 'decent';
}

function generateRoundMessage(cat,display,roundNum,totalRoundsN,prevRound){
  const parts=MSG_PARTS[cat]||MSG_PARTS.general;
  const perf=roundNum===1?'first':getPerfTier(prevRound);
  
  // Pick pools based on performance tier
  const openerPool=perf==='first'?parts.openers_first:perf==='great'?parts.openers_great:perf==='decent'?parts.openers_decent:parts.openers_poor;
  const subjectPool=parts.subjects(display);
  const closerPool=perf==='poor'?parts.closers_poor:perf==='decent'?parts.closers_decent:parts.closers_great;
  
  // Try to build a unique message (8×15×8 = 960 combos per tier)
  for(let attempt=0;attempt<80;attempt++){
    const opener=openerPool[Math.floor(Math.random()*openerPool.length)];
    const subject=subjectPool[Math.floor(Math.random()*subjectPool.length)];
    const closer=closerPool[Math.floor(Math.random()*closerPool.length)];
    const msg=opener+' '+subject+' '+closer;
    if(!usedStressorMsgs.has(msg)){
      usedStressorMsgs.add(msg);
      return msg;
    }
  }
  // Absolute fallback after 80 attempts: append round number to force uniqueness
  const msg=pickRandom(openerPool)+' '+pickRandom(subjectPool)+' '+pickRandom(closerPool);
  const unique=msg+' Round '+roundNum+' of '+totalRoundsN+'.';
  usedStressorMsgs.add(unique);
  return unique;
}

// ═══════════════ STRESSOR OUTCOMES ═══════════════
const OUTCOMES={
  person:{
    survived:(a)=>`${a} is safe. You cleared the path. When the dust settled and ${a} stepped out into the light, it was because of every precise shot you made. Your accuracy under pressure is the reason ${a} is alive right now. Remember this feeling. You earned it.`,
    partial:(a)=>`${a} survived, but barely. The path you cleared had gaps. ${a} made it out injured, bruised from debris that your missed shots failed to clear. They are alive because you did enough. But enough left scars. You can do better. You know that now.`,
    failed:(a)=>`${a} did not make it. The path collapsed before you could clear it. The debris your missed shots left standing sealed the exit. You had the opportunity and the tools. What you lacked was the precision. ${a} needed you to be better than you were.`
  },
  pet:{
    survived:(a)=>`Your ${a} is safe. The barriers held. When the fire crews finally arrived, your ${a} was in the protected corridor you built with every accurate shot. Not a single burn. Not a single scar. Your precision saved them completely.`,
    partial:(a)=>`Your ${a} survived but suffered smoke exposure because of gaps in your barrier coverage. Recovery is likely, but the coughing and fear in your ${a}'s eyes is a reminder that your missed shots had real consequences.`,
    failed:(a)=>`Your ${a} did not make it out. The fire consumed the sections your missed barriers failed to protect. The corridor never opened fully because your shots were not accurate enough. Your ${a} trusted you. That trust deserved better aim.`
  },
  career:{
    survived:(a)=>`Your ${a} is fully restored. Every node is back online. The cascade was stopped cold by your precision, and the systems you rebuilt are stronger than before. Your performance under pressure proved your worth beyond any doubt.`,
    partial:(a)=>`Your ${a} survived but with permanent damage. Some sectors could not be restored because your inconsistent performance let the cascade reach them. You saved the core, but the scars of your missed targets are visible in every diagnostic.`,
    failed:(a)=>`Your ${a} collapsed. Total system failure. The cascade overwhelmed every sector because your missed shots let it spread unchecked. Everything you built, every late night, every sacrifice, gone. Because when it mattered most, your aim was not enough.`
  },
  home:{
    survived:(a)=>`Your ${a} stands. Every barrier held. The threat slammed against the shields you activated and found no entry. When the morning came, your ${a} was untouched. Every window intact. Every wall solid. Your precision made it a fortress.`,
    partial:(a)=>`Your ${a} survived but took structural damage in the sections your missed shots left unshielded. It is still standing but weakened. The repairs will take time, and every damaged section is a reminder of where your aim failed.`,
    failed:(a)=>`Your ${a} was destroyed. The threat breached every section your failed barriers left exposed. What the threat did not demolish, the secondary damage finished. Your ${a} and everything inside it is gone because your aim could not build the wall it needed.`
  },
  health:{
    survived:(a)=>`Your ${a} made a full recovery. Every calibration point you hit restored critical function, and the systems that were failing stabilized completely. The precision of your hands gave back what was being lost. Full recovery. Because of you.`,
    partial:(a)=>`Your ${a} survived but with complications. Some functions were restored by your accurate shots, but others suffered permanent reduction because of the calibration points you missed. Recovery continues, but it will never be complete.`,
    failed:(a)=>`Your ${a} could not be saved. The functions that needed calibration failed one by one as your missed shots let the window close. What could have been restored was lost to your inaccuracy. The system needed precision. You did not deliver.`
  },
  financial:{
    survived:(a)=>`Your ${a} is secure. Every breach was sealed. The hostile system retreated against your precision, and a full audit confirms zero permanent losses. Your accuracy under fire was the firewall that saved everything.`,
    partial:(a)=>`Your ${a} survived but with significant losses. The breaches you sealed saved the core, but the drains your missed shots left open extracted irreplaceable assets. You saved most of it, but what you lost is not coming back.`,
    failed:(a)=>`Your ${a} is gone. The drains emptied everything while your shots missed their marks. The hostile system exploited every gap your inaccuracy created until there was nothing left to protect. Everything you built, drained. Because you could not hit the targets.`
  },
  dream:{
    survived:(a)=>`You reached your ${a}. Every barrier is destroyed. The path you carved with precision leads straight to the future you always imagined. The obstacles that tried to stop you are rubble behind you. Your ${a} is real now. You earned it with every shot.`,
    partial:(a)=>`Your ${a} is still possible but the path you cleared is narrow and fragile. Some barriers remain because your shots missed them. You moved closer but you are not there yet. The door is open but only partway. What you do next determines if you make it through.`,
    failed:(a)=>`Your ${a} is gone. The barriers your missed shots failed to destroy sealed the path permanently. The door closed while you were still trying to reach it. Everything you worked toward is walled off by the obstacles your aim could not break.`
  },
  team:{
    survived:(a)=>`Your ${a} made it out. Every member. Your covering fire eliminated every threat and the extraction window held open because of your precision. When the debrief happens, they will know it was your accuracy that brought everyone home alive.`,
    partial:(a)=>`Your ${a} made it out but not everyone is whole. The threats your missed shots left standing inflicted casualties before extraction. Everyone survived, but the injuries are a permanent record of where your aim failed the people counting on you.`,
    failed:(a)=>`Your ${a} did not make it. The threats overwhelmed their position because your covering fire had too many gaps. The extraction window closed while threats you failed to eliminate closed in. You were their only chance, and your aim was not enough.`
  },
  general:{
    survived:(a)=>`"${a}" is safe. The threat was defeated. Every target you hit pushed it back, and your precision built a defense it could not penetrate. What matters most to you endured because when it counted, your aim was true.`,
    partial:(a)=>`"${a}" survived but carries damage from the assault. The areas your shots protected held, but the gaps from your misses let the threat score lasting hits. "${a}" endures, but the scars of your inconsistency remain.`,
    failed:(a)=>`"${a}" was lost. The threat overwhelmed every defense your missed shots failed to build. What you said mattered most to you was destroyed while you failed to protect it. Your aim was the only thing standing between "${a}" and destruction, and it was not enough.`
  }
};

function getOverallOutcome(){
  if(roundHistory.length===0)return 'partial';
  let totalHits=0,totalShots=0,totalPrec=0,precCount=0,mathCorrect=0;
  roundHistory.forEach(r=>{
    totalHits+=r.hits;totalShots+=r.hits+r.misses;
    if(r.S.avgPrec>0&&r.hits>0){totalPrec+=r.S.avgPrec;precCount++}
    if(r.mathCorrect)mathCorrect++;
  });
  const hitRate=totalShots>0?totalHits/totalShots:0;
  const avgPrec=precCount>0?totalPrec/precCount:0;
  const mathRate=mathCorrect/roundHistory.length;
  if(avgPrec>=70&&hitRate>=0.75&&mathRate>=0.8)return 'survived';
  if(avgPrec<40||hitRate<0.5||mathRate<0.5)return 'failed';
  return 'partial';
}

function showStressorOutcome(){
  const tier=getOverallOutcome();
  const outcomeSet=OUTCOMES[stressorCategory]||OUTCOMES.general;
  const text=outcomeSet[tier](stressorDisplay);
  
  const screen=$('stressorOutcomeScreen');
  screen.className='screen';
  
  if(tier==='survived'){
    $('outcomeIcon').textContent='\u2714';$('outcomeIcon').style.color='var(--green)';
    $('outcomeTitle').textContent='MISSION COMPLETE';$('outcomeTitle').style.color='var(--green)';
    $('outcomeLabel').textContent='SURVIVED';$('outcomeLabel').style.color='var(--green)';
    $('outcomeBox').style.borderColor='var(--green)';
    $('outcomeContinueBtn').style.borderColor='var(--green)';$('outcomeContinueBtn').style.color='var(--green)';
  }else if(tier==='partial'){
    $('outcomeIcon').textContent='\u26A0';$('outcomeIcon').style.color='var(--yellow)';
    $('outcomeTitle').textContent='MISSION INCOMPLETE';$('outcomeTitle').style.color='var(--yellow)';
    $('outcomeLabel').textContent='PARTIAL SUCCESS';$('outcomeLabel').style.color='var(--yellow)';
    $('outcomeBox').style.borderColor='var(--yellow)';
    $('outcomeContinueBtn').style.borderColor='var(--yellow)';$('outcomeContinueBtn').style.color='var(--yellow)';
  }else{
    $('outcomeIcon').textContent='\u2718';$('outcomeIcon').style.color='var(--red)';
    $('outcomeTitle').textContent='MISSION FAILED';$('outcomeTitle').style.color='var(--red)';
    $('outcomeLabel').textContent='LOST';$('outcomeLabel').style.color='var(--red)';
    $('outcomeBox').style.borderColor='var(--red)';
    $('outcomeContinueBtn').style.borderColor='var(--red)';$('outcomeContinueBtn').style.color='var(--red)';
  }
  $('outcomeText').textContent=text;
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  screen.classList.add('active');
  $('exitBtn').classList.add('visible');
}

$('outcomeContinueBtn').addEventListener('click',()=>{showFinalResults()});

function generateStressor(answer){
  const{category,matched}=detectCategory(answer);
  const templates=SCENARIOS[category]||SCENARIOS.general;
  const briefingFn=pickRandom(templates);
  const display=category==='general'?matched:matched.charAt(0).toUpperCase()+matched.slice(1);
  stressorCategory=category;stressorDisplay=display;
  usedStressorMsgs=new Set();
  return{briefing:briefingFn(display)};
}

function startStressorFlow(){
  const q=STRESSOR_QUESTIONS[Math.floor(Math.random()*STRESSOR_QUESTIONS.length)];
  $('stressorQuestionText').textContent=q;$('stressorInput').value='';
  $('stressorSubmitBtn').disabled=false;$('stressorLoading').style.display='none';
  showScreen('stressorQuestionScreen');setTimeout(()=>$('stressorInput').focus(),100);
}
$('stressorInput').addEventListener('keydown',e=>{if(e.key==='Enter'&&$('stressorInput').value.trim())submitStressor()});
$('stressorSubmitBtn').addEventListener('click',submitStressor);
function submitStressor(){
  const answer=$('stressorInput').value.trim();if(!answer)return;
  stressorAnswer=answer;$('stressorSubmitBtn').disabled=true;$('stressorLoading').style.display='block';
  setTimeout(()=>{const result=generateStressor(answer);stressorScenario=result.briefing;$('briefingText').textContent=stressorScenario;showScreen('stressorBriefingScreen')},800);
}
$('engageBtn').addEventListener('click',()=>{nextRound()});
$('stressorRoundEngageBtn').addEventListener('click',()=>{$('stressorRoundOverlay').classList.remove('visible');startShootingPhase()});

// ═══════════════ DEMO START ═══════════════
$('demoBtn').addEventListener('click',startDemo);
function startDemo(){
  demoMode=true;demoActive=true;demoLevelIdx=0;currentRound=0;score=0;roundHistory=[];
  comboCount=0;maxCombo=0;clutchMathCount=0;clutchShotCount=0;clutchOpportunities=0;
  totalRounds=DEMO_LEVELS.length;lastAnswer=-1;targetCap=30;
  demoSavedMode=gameMode;gameMode='moving';
  demoSavedMath=mathEnabled;mathEnabled=true;
  demoSavedTune={s1:tuneSizeLv1,s25:tuneSizeLv25,sp1:tuneSpeedLv1,sp25:tuneSpeedLv25,v1:tuneVisLv1,v25:tuneVisLv25,si1:tuneSpawnLv1,si25:tuneSpawnLv25};
  tuneSizeLv1=45;tuneSizeLv25=14;tuneSpeedLv1=0.8;tuneSpeedLv25=4.5;tuneVisLv1=3.0;tuneVisLv25=0.55;tuneSpawnLv1=2.0;tuneSpawnLv25=0.35;
  aiX=window.innerWidth/2;aiY=window.innerHeight/2;
  $('demoBanner').classList.add('visible');
  updateDemoBanner();demoNextRound();
}
function updateDemoBanner(){
  $('demoBannerText').textContent='AI DEMO — LEVEL '+DEMO_LEVELS[demoLevelIdx];
  $('demoBannerSub').textContent=DEMO_LEVEL_NAMES[demoLevelIdx]+' • Round '+(demoLevelIdx+1)+'/'+DEMO_LEVELS.length;
}
function demoNextRound(){
  if(demoLevelIdx>=DEMO_LEVELS.length){showFinalResults();return}
  level=DEMO_LEVELS[demoLevelIdx];updateDemoBanner();nextRound();
  // AI answers after a delay proportional to difficulty
  const skill=AI_SKILL[demoLevelIdx];
  aiMathTimeout=setTimeout(()=>{
    if(demoMode&&!mathAnswered)demoAnswerMath();
  },skill.mathDelay+randInt(300,1000));
}
function demoAnswerMath(){
  const btns=document.querySelectorAll('.answer-btn');
  // Find correct button — hover effect first
  let correctBtn=null;
  btns.forEach(b=>{if(+b.textContent===correctAnswer)correctBtn=b});
  if(correctBtn&&!mathAnswered){
    correctBtn.classList.add('correct');// visual hover
    setTimeout(()=>handleAnswer(correctAnswer,correctBtn),300);
  }
}
function demoNextStep(){
  demoLevelIdx++;
  if(demoLevelIdx>=DEMO_LEVELS.length){showFinalResults();return}
  level=DEMO_LEVELS[demoLevelIdx];updateDemoBanner();nextRound();
  const skill=AI_SKILL[demoLevelIdx];
  aiMathTimeout=setTimeout(()=>{
    if(demoMode&&!mathAnswered)demoAnswerMath();
  },skill.mathDelay+randInt(300,1000));
}

// ═══════════════ AI SHOOTING CONTROLLER ═══════════════
function startAIShooting(){
  if(!demoMode)return;
  const skill=AI_SKILL[demoLevelIdx]||AI_SKILL[5];
  let currentTarget=null;
  let aimTime=0; // ms spent aiming at current target
  const baseAimDuration=lerp(250,600,demoLevelIdx/5); // how long AI aims before shooting
  let lastTickTime=performance.now();
  
  function pickTarget(){
    // Pick nearest alive target
    let best=null,bestDist=Infinity;
    for(const t of targets){if(!t.alive)continue;const d=Math.sqrt((t.x-aiX)**2+(t.y-aiY)**2);if(d<bestDist){bestDist=d;best=t}}
    return best;
  }
  
  function aiTick(){
    if(!shootingActive||!demoMode){clearInterval(aiInterval);return}
    const now=performance.now();
    const dt=now-lastTickTime;lastTickTime=now;
    
    // Pick target if none or current is dead
    if(!currentTarget||!currentTarget.alive){currentTarget=pickTarget();aimTime=0}
    if(!currentTarget){clearInterval(aiInterval);return}
    
    // Track target's CURRENT position directly
    const prec=randFloat(skill.precRange[0],skill.precRange[1])/100;
    const offsetX=(Math.random()-.5)*currentTarget.radius*(1-prec)*.8;
    const offsetY=(Math.random()-.5)*currentTarget.radius*(1-prec)*.8;
    const goalX=currentTarget.x+offsetX;
    const goalY=currentTarget.y+offsetY;
    
    // Move AI cursor aggressively toward target (high lerp factor)
    const lerpFactor=Math.min(1,0.25+skill.aimSpeed*0.05);
    const prevAiX=aiX,prevAiY=aiY;
    aiX+=(goalX-aiX)*lerpFactor;
    aiY+=(goalY-aiY)*lerpFactor;
    // Track cursor distance for path efficiency
    totalCursorDist+=Math.sqrt((aiX-prevAiX)**2+(aiY-prevAiY)**2);
    
    aimTime+=dt;
    
    // Check if AI is close enough AND has aimed long enough
    const distToCenter=Math.sqrt((aiX-currentTarget.x)**2+(aiY-currentTarget.y)**2);
    const insideTarget=distToCenter<currentTarget.radius*0.9;
    
    if(insideTarget&&aimTime>=baseAimDuration+randInt(-50,100)){
      // SHOOT — decide hit or intentional miss
      if(Math.random()<skill.missChance){
        // Intentional miss: click outside the target
        const missAngle=Math.random()*Math.PI*2;
        const missDist=currentTarget.radius*(1.5+Math.random());
        triggerAIClick(currentTarget.x+Math.cos(missAngle)*missDist,currentTarget.y+Math.sin(missAngle)*missDist);
      }else{
        // Hit: click at AI's current position (which is inside the target)
        triggerAIClick(aiX,aiY);
      }
      // Reset for next target
      currentTarget=null;aimTime=0;
    }
  }
  
  var aiInterval=setInterval(aiTick,50);aiShootInterval=aiInterval;
}

function triggerAIClick(cx,cy){
  if(!shootingActive)return;
  const now=performance.now();
  // Flash
  const fl=document.createElement('div');fl.className='muzzle-flash';fl.style.left=cx+'px';fl.style.top=cy+'px';document.body.appendChild(fl);setTimeout(()=>fl.remove(),200);
  totalClicks++;clickTimestamps.push(now);
  // Update mouseTrail for flick scoring
  mouseTrail.push({x:cx,y:cy,t:now});if(mouseTrail.length>50)mouseTrail.shift();
  let hit=false;
  for(let i=targets.length-1;i>=0;i--){const tg=targets[i];if(tg.alive&&tg.hitTest(cx,cy)){
    tg.alive=false;roundHits++;targetsRemaining--;hit=true;
    const d1=Math.sqrt((cx-tg.x)**2+(cy-tg.y)**2),d2=Math.sqrt((cx-tg.prevX)**2+(cy-tg.prevY)**2),d3=Math.sqrt((cx-(tg.x+tg.prevX)/2)**2+(cy-(tg.y+tg.prevY)/2)**2),dist=Math.min(d1,d2,d3);
    const precPct=Math.round(Math.max(0,(1-dist/tg.radius))*100);roundAccuracyScores.push(precPct);
    const tsl=now-lastHitTime;roundHitTimes.push(tsl);lastHitTime=now;
    const trail=mouseTrail.filter(p=>now-p.t<80);let fpx=0;if(trail.length>=2){const f=trail[0],l=trail[trail.length-1],fd=Math.sqrt((l.x-f.x)**2+(l.y-f.y)**2),ft=(l.t-f.t)/1000;if(ft>0)fpx=fd/ft}roundFlickScores.push(fpx);
    if(!firstBloodAwarded){firstBloodTime=now-shootPhaseStartTime;firstBloodAwarded=true}
    comboCount++;if(comboCount>maxCombo)maxCombo=comboCount;if(comboCount>roundMaxCombo)roundMaxCombo=comboCount;
    const cMult=Math.min(3,1+Math.floor(comboCount/2)*.5);roundComboPoints+=Math.round(50*(cMult-1));
    if(precPct>=85){bullseyeChain++;if(bullseyeChain>maxBullseyeChain)maxBullseyeChain=bullseyeChain;roundBullseyeBonus+=20*Math.pow(2,Math.min(bullseyeChain-1,7))}else bullseyeChain=0;
    if(lastShotWasMiss&&precPct>=80&&tsl<=400)roundRecoveries++;lastShotWasMiss=false;
    if(roundMisses>0&&precPct>=90){clutchShotCount++;clutchOpportunities++}
    hitPositions.push({x:tg.x,y:tg.y});
    let fl2,fc;if(precPct>=95){fl2='PERFECT!';fc='#00f0ff'}else if(precPct>=80){fl2='GREAT!';fc='#39ff14'}else if(precPct>=60){fl2='GOOD';fc='#ffe600'}else if(precPct>=35){fl2='OK';fc='#ff6b00'}else{fl2='HIT';fc='#ff2d95'}
    let extra=[];if(comboCount>=3)extra.push(comboCount+'x');if(fpx>=1500)extra.push('INHUMAN');else if(fpx>=800)extra.push('⚡');if(bullseyeChain>=3)extra.push('🎯×'+bullseyeChain);
    hitFeedbacks.push({x:tg.x,y:tg.y-tg.radius-10,label:fl2+' '+precPct+'%',sub:Math.round(tsl)+'ms'+(extra.length?' '+extra.join(' '):''),color:fc,life:1.8,vy:-55});
    spawnHit(tg.x,tg.y);updateShootHUD();
    if(comboCount>=3){const cd=$('comboDisplay');cd.textContent=comboCount+'x COMBO';cd.style.color=comboCount>=7?'var(--pink)':comboCount>=5?'var(--green)':'var(--cyan)';cd.classList.add('visible');clearTimeout(cd._to);cd._to=setTimeout(()=>cd.classList.remove('visible'),1500)}
    if(targetsRemaining<=0){shootingActive=false;setTimeout(()=>{cancelAnimationFrame(animFrameId);showRoundResult();if(demoMode){aiResultTimeout=setTimeout(()=>{if(demoMode)demoNextStep()},3000)}},500)}
    break;
  }}
  if(!hit){roundMisses++;comboCount=0;bullseyeChain=0;lastShotWasMiss=true;$('shootMisses').textContent=roundMisses;$('shootCombo').textContent='0';$('comboDisplay').classList.remove('visible');spawnMiss(cx,cy)}
}
function updateShootHUD(){
  $('shootHits').textContent=roundHits;$('shootTargetsLeft').textContent=targetsRemaining;
  $('shootCombo').textContent=comboCount;$('shootCombo').style.color=comboCount>=5?'var(--pink)':comboCount>=3?'var(--green)':'var(--cyan)';
  if(roundAccuracyScores.length){const a=Math.round(roundAccuracyScores.reduce((a,b)=>a+b,0)/roundAccuracyScores.length);$('shootAccuracy').textContent=a+'%';$('shootAccuracy').style.color=a>=80?'var(--green)':a>=50?'var(--yellow)':'var(--orange)'}
  if(roundHitTimes.length){const a=Math.round(roundHitTimes.reduce((a,b)=>a+b,0)/roundHitTimes.length);$('shootSpeed').textContent=a+'ms';$('shootSpeed').style.color=a<=500?'var(--green)':a<=1000?'var(--yellow)':'var(--orange)'}
}

// ═══════════════ MATH GENERATION ═══════════════
function generateProblem(lv){
  let q,a,attempts=0;
  // Keep generating until we get a different answer from last round (max 20 tries)
  do{
    attempts++;
    a=undefined;
  if(lv<=3){const op=Math.random()<.5;const a1=randInt(1,15),a2=randInt(1,10);if(op){q=`${a1} + ${a2}`;a=a1+a2}else{const b=Math.max(a1,a2),s=Math.min(a1,a2);q=`${b} - ${s}`;a=b-s}}
  else if(lv<=6){const t=randInt(0,2);if(t===0){const a1=randInt(2,9),a2=randInt(2,9);q=`${a1} × ${a2}`;a=a1*a2}else if(t===1){const a1=randInt(10,50),a2=randInt(5,30);q=`${a1} + ${a2}`;a=a1+a2}else{const a1=randInt(20,60),a2=randInt(5,20);q=`${a1} - ${a2}`;a=a1-a2}}
  else if(lv<=10){const t=randInt(0,3);if(t===0){const a1=randInt(20,100),a2=randInt(10,80);q=`${a1} + ${a2}`;a=a1+a2}else if(t===1){const a1=randInt(30,100),a2=randInt(10,30);q=`${a1} - ${a2}`;a=a1-a2}else if(t===2){const a1=randInt(3,12),a2=randInt(3,12);q=`${a1} × ${a2}`;a=a1*a2}else{const d=randInt(2,10),qt=randInt(2,12);q=`${d*qt} ÷ ${d}`;a=qt}}
  else if(lv<=15){const t=randInt(0,4);if(t===0){const a1=randInt(12,25),a2=randInt(5,15);q=`${a1} × ${a2}`;a=a1*a2}else if(t===1){const b=randInt(2,9),ad=randInt(1,20);q=`${b}² + ${ad}`;a=b*b+ad}else if(t===2){const a1=randInt(10,30),a2=randInt(2,8),a3=randInt(5,20);q=`${a1} × ${a2} - ${a3}`;a=a1*a2-a3}else if(t===3){const a1=randInt(100,300),a2=randInt(50,200);q=`${a1} + ${a2}`;a=a1+a2}else{const n=randInt(2,12);q=`${n}²`;a=n*n}}
  else if(lv<=20){const t=randInt(0,4);if(t===0){const a1=randInt(15,40),a2=randInt(3,12),a3=randInt(10,50);q=`${a1} × ${a2} + ${a3}`;a=a1*a2+a3}else if(t===1){const pf=[4,9,16,25,36,49,64,81,100,121,144],i=randInt(0,pf.length-1),ad=randInt(5,30);q=`√${pf[i]} + ${ad}`;a=Math.sqrt(pf[i])+ad}else if(t===2){const b=randInt(2,6);q=`${b}³`;a=b**3}else if(t===3){const a1=randInt(20,50),a2=randInt(3,9),a3=randInt(2,6);q=`(${a1} + ${a2}) × ${a3}`;a=(a1+a2)*a3}else{const a1=randInt(100,500),a2=randInt(50,300);q=`${a1} - ${a2}`;a=a1-a2}}
  else{const t=randInt(0,5);if(t===0){const a1=randInt(25,60),a2=randInt(10,30),a3=randInt(5,15),a4=randInt(2,8);q=`(${a1}×${a2})-(${a3}×${a4})`;a=a1*a2-a3*a4}else if(t===1){const b=randInt(2,5),c=randInt(2,4),ad=randInt(10,50);q=`${b}^${c} + ${ad}`;a=b**c+ad}else if(t===2){const pf=[16,25,36,49,64,81,100,121,144,169,196],i=randInt(0,pf.length-1),m=randInt(3,9);q=`√${pf[i]} × ${m}`;a=Math.sqrt(pf[i])*m}else if(t===3){const a1=randInt(50,150),a2=randInt(20,80),a3=randInt(10,50),m=randInt(2,5);q=`(${a1}+${a2})×${m}-${a3}`;a=(a1+a2)*m-a3}else if(t===4){const a1=randInt(3,12),a2=randInt(3,12),a3=randInt(3,12);q=`${a1}×${a2}×${a3}`;a=a1*a2*a3}else{const d=randInt(3,12),qt=randInt(10,25),ad=randInt(20,80);q=`(${d*qt}÷${d})+${ad}`;a=qt+ad}}
  a=Math.round(a);
  // Ensure answer is at least 1 (need at least 1 target)
  if(a<1)a=undefined;
  }while((a===lastAnswer||a===undefined)&&attempts<20);
  // Update last answer tracker
  lastAnswer=a;
  let cx=1;if(q.includes('×'))cx+=.5;if(q.includes('÷'))cx+=.5;if(q.includes('²')||q.includes('³'))cx+=.4;if(q.includes('√'))cx+=.6;if(q.includes('^'))cx+=.7;cx+=(q.match(/[+\-×÷]/g)||[]).length*.3;if(q.includes('('))cx+=.4;const ns=q.match(/\d+/g)||[];if(Math.max(...ns.map(Number))>100)cx+=.5;if(Math.max(...ns.map(Number))>500)cx+=.5;
  problemDifficultyMult=Math.max(1,Math.min(3,cx*.8));
  const ch=new Set([a]),rng=Math.max(5,Math.abs(a)*.3);let at=0;while(ch.size<4&&at<100){let w=a+randInt(-Math.ceil(rng),Math.ceil(rng));if(w!==a&&w>=0)ch.add(Math.round(w));at++}while(ch.size<4)ch.add(a+ch.size*3);

  // ── PAR TIME — expected time for a skilled player ──
  // Used purely for scoring: beat par = bonus, exceed par = penalty
  const lvSkill=lerp(1,.7,(lv-1)/24); // skilled players get faster at higher levels
  const parTime=Math.max(3,Math.round(cx*3.5*lvSkill)); // seconds

  return{question:q+' = ?',answer:a,choices:shuffle([...ch]),parTime};
}

// ═══════════════ GAME FLOW ═══════════════
function nextRound(){
  currentRound++;if(currentRound>totalRounds){if(stressorEnabled&&!demoMode){showStressorOutcome()}else{showFinalResults()}return}
  roundHits=0;roundMisses=0;roundMathCorrect=false;mathElapsed=0;mathAnswered=false;
  roundAccuracyScores=[];roundHitTimes=[];roundFlickScores=[];hitFeedbacks=[];
  lastHitTime=0;firstBloodTime=0;firstBloodAwarded=false;mathConfidenceRatio=0;
  bullseyeChain=0;maxBullseyeChain=0;roundBullseyeBonus=0;roundMaxCombo=comboCount;
  totalClicks=0;totalCursorDist=0;hitPositions=[];lastShotWasMiss=false;roundRecoveries=0;clickTimestamps=[];mouseTrail=[];roundComboPoints=0;problemDifficultyMult=1;capModifier=1;
  if(!mathEnabled){
    // Skip math — go straight to shooting
    roundMathCorrect=true;mathElapsed=0;mathConfidenceRatio=1;correctAnswer=noMathTargetCount;expectedTime=0;
    roundTargetCount=noMathTargetCount;capModifier=1;comboCount++;
    if(stressorEnabled&&!demoMode){
      setTimeout(()=>{
        const prevRound=roundHistory.length>0?roundHistory[roundHistory.length-1]:null;
        const isFinal=currentRound===totalRounds;
        const label=isFinal?'FINAL ROUND — EVERYTHING RIDES ON THIS':'ROUND '+currentRound+(currentRound===1?' — ENGAGE':' — STAY FOCUSED');
        $('stressorRoundLabel').textContent=label;
        $('stressorRoundText').textContent=generateRoundMessage(stressorCategory,stressorDisplay,currentRound,totalRounds,prevRound);
        $('stressorRoundOverlay').classList.add('visible');
      },300);
    }else{startShootingPhase()}
    return;
  }
  startMathPhase();
}

function startMathPhase(){
  showScreen('mathScreen');
  $('hudRound').textContent=`${currentRound}/${totalRounds}`;$('hudLevel').textContent=level;
  $('hudCombo').textContent=comboCount;$('hudCombo').style.color=comboCount>=5?'var(--pink)':comboCount>=3?'var(--green)':'var(--cyan)';
  $('hudScore').textContent=score;
  
  const p=generateProblem(level);
  correctAnswer=p.answer;expectedTime=p.parTime;mathElapsed=0;
  
  $('mathQuestion').textContent=p.question;
  $('timerText').textContent='0.0';$('timerText').style.color='var(--green)';
  
  const pb=$('pressureBadge');pb.textContent=problemDifficultyMult.toFixed(1)+'x PRESSURE';
  const pc=problemDifficultyMult>=2.5?'var(--red)':problemDifficultyMult>=1.8?'var(--orange)':problemDifficultyMult>=1.3?'var(--yellow)':'var(--cyan)';
  pb.style.color=pc;pb.style.borderColor=pc;
  
  // Ring starts empty, fills up as time passes
  const ring=$('timerRingFill');
  const circ=2*Math.PI*70;
  ring.style.strokeDashoffset=circ.toString(); // fully empty
  ring.style.stroke='var(--green)';
  
  // Show all answers immediately
  const grid=$('answersGrid');grid.innerHTML='';
  p.choices.forEach(c=>{const btn=document.createElement('button');btn.className='answer-btn';btn.textContent=c;btn.addEventListener('click',()=>handleAnswer(c,btn));grid.appendChild(btn)});
  
  // ── COUNT-UP STOPWATCH — no time limit ──
  mathStartTime=performance.now();
  clearInterval(timerInterval);
  
  timerInterval=setInterval(()=>{
    if(mathAnswered)return;
    mathElapsed=(performance.now()-mathStartTime)/1000;
    $('timerText').textContent=mathElapsed.toFixed(1);
    
    // Ring fills up: at par time = full ring, can exceed
    const fillPct=Math.min(1,mathElapsed/expectedTime);
    ring.style.strokeDashoffset=((1-fillPct)*circ).toString();
    
    // Color shifts based on how close to / past par time
    const ratio=mathElapsed/expectedTime;
    if(ratio<0.5){ring.style.stroke='var(--green)';$('timerText').style.color='var(--green)'}
    else if(ratio<0.8){ring.style.stroke='var(--cyan)';$('timerText').style.color='var(--cyan)'}
    else if(ratio<1.0){ring.style.stroke='var(--yellow)';$('timerText').style.color='var(--yellow)'}
    else if(ratio<1.5){ring.style.stroke='var(--orange)';$('timerText').style.color='var(--orange)'}
    else{ring.style.stroke='var(--red)';$('timerText').style.color='var(--red)'}
  },50);
}

function handleAnswer(choice,btn){
  if(mathAnswered)return;
  mathAnswered=true;clearInterval(timerInterval);
  mathElapsed=(performance.now()-mathStartTime)/1000;
  
  // Confidence = how fast vs par time (faster = higher)
  const speedRatio=mathElapsed/expectedTime;
  mathConfidenceRatio=Math.max(0,Math.min(1,1-((speedRatio-0.3)/1.4)));
  
  if(choice===correctAnswer){
    btn.classList.add('correct');playGameSound('hit');roundMathCorrect=true;
    
    // ── TARGET COUNT = ANSWER, with player cap ──
    const rawTargets=Math.max(1,correctAnswer); // answer IS the target count
    if(rawTargets<=targetCap){
      // Answer fits within cap: spawn exact amount, no modifier
      roundTargetCount=rawTargets;
      capModifier=1;
    }else{
      // Answer exceeds cap: spawn cap amount, targets get harder
      roundTargetCount=targetCap;
      // capModifier scales proportionally: answer=100, cap=30 -> ratio=3.33
      // But we clamp it so targets stay humanly hittable
      // Modifier range: 1.0 (no change) to 2.5 (maximum hardness)
      const overflowRatio=rawTargets/targetCap; // how many times over the cap
      capModifier=Math.min(2.5,1+(overflowRatio-1)*0.4); // gentle curve, maxes at 2.5x
    }
    
    if(speedRatio>1.5){clutchOpportunities++}
    comboCount++;
    if(stressorEnabled&&!demoMode){
      setTimeout(()=>{
        const prevRound=roundHistory.length>0?roundHistory[roundHistory.length-1]:null;
        const isFinal=currentRound===totalRounds;
        const label=isFinal?'FINAL ROUND — EVERYTHING RIDES ON THIS':'ROUND '+currentRound+(currentRound===1?' — ENGAGE':' — STAY FOCUSED');
        $('stressorRoundLabel').textContent=label;
        $('stressorRoundText').textContent=generateRoundMessage(stressorCategory,stressorDisplay,currentRound,totalRounds,prevRound);
        $('stressorRoundOverlay').classList.add('visible');
      },700);
    }else{setTimeout(()=>startShootingPhase(),700)}
  }else{
    btn.classList.add('wrong');playGameSound('miss');document.querySelectorAll('.answer-btn').forEach(b=>{if(+b.textContent===correctAnswer)b.classList.add('correct')});
    roundMathCorrect=false;roundTargetCount=0;capModifier=1;comboCount=0;showWrongOverlay('Correct answer: '+correctAnswer);
  }
}
function showWrongOverlay(m){$('wrongOverlaySub').textContent=m;$('wrongOverlay').classList.add('visible');setTimeout(()=>{$('wrongOverlay').classList.remove('visible');showRoundResult();if(demoMode){aiResultTimeout=setTimeout(()=>{if(demoMode)demoNextStep()},2500)}},2000)}

function startShootingPhase(){
  showScreen('shootScreen');canvas=$('shootCanvas');ctx=canvas.getContext('2d');resizeCanvas();
  roundHits=0;roundMisses=0;targets=[];particles=[];hitFeedbacks=[];shootingActive=false;targetsRemaining=roundTargetCount;
  roundAccuracyScores=[];roundHitTimes=[];roundFlickScores=[];lastHitTime=0;firstBloodAwarded=false;firstBloodTime=0;
  bullseyeChain=0;maxBullseyeChain=0;roundBullseyeBonus=0;roundMaxCombo=comboCount;
  totalClicks=0;totalCursorDist=0;hitPositions=[];lastShotWasMiss=false;roundRecoveries=0;clickTimestamps=[];mouseTrail=[];roundComboPoints=0;
  $('shootTargetsLeft').textContent=targetsRemaining;$('shootHits').textContent='0';$('shootMisses').textContent='0';
  $('shootAccuracy').textContent='—';$('shootSpeed').textContent='—';$('shootCombo').textContent=comboCount;
  $('comboDisplay').classList.remove('visible');
  // Show cap modifier in HUD if targets were capped
  if(capModifier>1){$('capModHud').style.display='';$('shootCapMod').textContent=capModifier.toFixed(1)+'x';$('shootCapMod').style.color=capModifier>=2?'var(--red)':capModifier>=1.5?'var(--orange)':'var(--yellow)'}
  else{$('capModHud').style.display='none'}
  aiX=canvas.width/2;aiY=canvas.height/2; // reset AI cursor
  showCenterMsg('3','var(--cyan)');
  setTimeout(()=>{showCenterMsg('2','var(--yellow)');
  setTimeout(()=>{showCenterMsg('1','var(--orange)');
  setTimeout(()=>{showCenterMsg('FIRE!','var(--red)');setTimeout(()=>$('shootCenterMsg').classList.remove('visible'),500);
    shootingActive=true;shootPhaseStartTime=performance.now();lastHitTime=performance.now();lastMouseX=mouseX;lastMouseY=mouseY;
    if(gameMode==='reflex'){startReflexSpawning()}else{spawnTargets()}
    startShootLoop();
    if(demoMode)startAIShooting();
  },700)},700)},700);
}
function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight}
window.addEventListener('resize',()=>{if(canvas)resizeCanvas()});
function showCenterMsg(t,c){const e=$('shootCenterMsg');e.textContent=t;e.style.color=c;e.style.textShadow=`0 0 30px ${c}`;e.classList.add('visible')}

// ═══════════════ TARGETS ═══════════════
class Target{
  constructor(x,y,r,s,p,pd,lifespan){this.x=x;this.y=y;this.prevX=x;this.prevY=y;this.baseX=x;this.baseY=y;this.radius=r;this.speed=s;this.pattern=p;this.pd=pd;this.alive=true;this.spawnTime=performance.now();this.phase=Math.random()*Math.PI*2;this.opacity=0;this.fadeIn=true;this.lifespan=lifespan||0;this.expiresAt=lifespan?(this.spawnTime+lifespan*1000):0;this.expired=false;this.fadeOut=false;this.fadeOutStart=0}
  update(dt,now){if(!this.alive)return;this.prevX=this.x;this.prevY=this.y;if(this.fadeIn){this.opacity=Math.min(1,this.opacity+dt*6);if(this.opacity>=1)this.fadeIn=false}
    // Reflex mode: handle fadeout when expired
    if(this.fadeOut){this.opacity=Math.max(0,this.opacity-dt*5);if(this.opacity<=0){this.alive=false;this.expired=true}return}
    // Reflex mode: check if lifespan exceeded
    if(this.lifespan>0&&now>=this.expiresAt&&!this.fadeOut){this.fadeOut=true;this.fadeOutStart=now;return}
    // Reflex mode: stationary targets just pulse gently
    if(this.pattern==='reflex'){
      const pulse=Math.sin((now-this.spawnTime)/1000*3)*2;
      this.x=this.baseX+pulse;this.y=this.baseY+pulse*0.5;
      this.x=clamp(this.x,this.radius+10,canvas.width-this.radius-10);this.y=clamp(this.y,this.radius+70,canvas.height-this.radius-10);
      return;
    }
    const t=(now-this.spawnTime)/1000,s=this.speed;
    switch(this.pattern){
      case'linear':this.x=this.baseX+Math.sin(t*s+this.phase)*this.pd.ampX;break;
      case'circle':this.x=this.baseX+Math.cos(t*s+this.phase)*this.pd.r;this.y=this.baseY+Math.sin(t*s+this.phase)*this.pd.r;break;
      case'figure8':this.x=this.baseX+Math.sin(t*s+this.phase)*this.pd.aX;this.y=this.baseY+Math.sin(t*s*2+this.phase)*this.pd.aY;break;
      case'zigzag':{const p=2/s,tp=((t+this.phase)%p)/p;this.x=this.baseX+(tp<.5?lerp(-1,1,tp*2):lerp(1,-1,(tp-.5)*2))*this.pd.aX;this.y=this.baseY+Math.sin(t*s*1.5)*this.pd.aY;break}
      case'teleport':if(Math.random()<this.pd.tc*dt){this.baseX=clamp(this.baseX+(Math.random()-.5)*this.pd.td,this.radius+50,canvas.width-this.radius-50);this.baseY=clamp(this.baseY+(Math.random()-.5)*this.pd.td,this.radius+80,canvas.height-this.radius-50)}this.x=this.baseX+Math.sin(t*s*3)*15;this.y=this.baseY+Math.cos(t*s*2.5)*12;break;
      case'spiral':{const st=t*s,sr=this.pd.bR+Math.sin(st*.5)*this.pd.aR;this.x=this.baseX+Math.cos(st+this.phase)*sr;this.y=this.baseY+Math.sin(st+this.phase)*sr;break}
      case'chaos':this.x=this.baseX+Math.sin(t*s+this.phase)*this.pd.a1+Math.cos(t*s*1.7+this.phase*.5)*this.pd.a2;this.y=this.baseY+Math.cos(t*s*1.3+this.phase)*this.pd.a3+Math.sin(t*s*2.1+this.phase*1.3)*this.pd.a4;break;
      case'dash':{const cy=(t*s)%4;if(cy>=1&&cy<1.3){const dp=(cy-1)/.3;this.x=this.baseX+dp*this.pd.dX;this.y=this.baseY+dp*this.pd.dY}else if(cy>=1.3&&cy<2.3){this.x=this.baseX+this.pd.dX;this.y=this.baseY+this.pd.dY}else if(cy>=2.3&&cy<2.6){const dp=(cy-2.3)/.3;this.x=this.baseX+(1-dp)*this.pd.dX;this.y=this.baseY+(1-dp)*this.pd.dY}break}
    }
    this.x=clamp(this.x,this.radius+10,canvas.width-this.radius-10);this.y=clamp(this.y,this.radius+70,canvas.height-this.radius-10);
  }
  draw(c){if(!this.alive)return;c.save();c.globalAlpha=this.opacity;const g=c.createRadialGradient(this.x,this.y,this.radius*.3,this.x,this.y,this.radius*1.5);g.addColorStop(0,'rgba(255,45,149,.3)');g.addColorStop(1,'rgba(255,45,149,0)');c.fillStyle=g;c.beginPath();c.arc(this.x,this.y,this.radius*1.5,0,Math.PI*2);c.fill();c.fillStyle='rgba(255,45,149,.15)';c.strokeStyle='rgba(255,45,149,.8)';c.lineWidth=2;c.beginPath();c.arc(this.x,this.y,this.radius,0,Math.PI*2);c.fill();c.stroke();c.strokeStyle='rgba(255,255,255,.3)';c.lineWidth=1;c.beginPath();c.arc(this.x,this.y,this.radius*.65,0,Math.PI*2);c.stroke();c.strokeStyle='rgba(255,255,255,.5)';c.beginPath();c.arc(this.x,this.y,this.radius*.3,0,Math.PI*2);c.stroke();c.fillStyle='#ff2d95';c.beginPath();c.arc(this.x,this.y,this.radius*.12,0,Math.PI*2);c.fill();
    // Reflex mode: draw countdown ring
    if(this.lifespan>0&&!this.fadeOut){const now=performance.now();const elapsed=(now-this.spawnTime)/1000;const remain=Math.max(0,1-elapsed/this.lifespan);const ringR=this.radius+8;const startA=-Math.PI/2;const endA=startA+remain*Math.PI*2;const rc=remain>0.6?'rgba(0,240,255,.8)':remain>0.3?'rgba(255,230,0,.9)':'rgba(255,0,60,.9)';c.strokeStyle=rc;c.lineWidth=3;c.beginPath();c.arc(this.x,this.y,ringR,startA,endA);c.stroke();c.lineWidth=1;c.strokeStyle='rgba(255,255,255,.08)';c.beginPath();c.arc(this.x,this.y,ringR,0,Math.PI*2);c.stroke()}
    c.restore()}
  hitTest(mx,my){
    // Base forgiveness: 15% buffer so clicks on the visible outer ring register
    const baseForgive=1.15;
    // Speed forgiveness: faster targets get more buffer (up to 30% extra)
    const dx=this.x-this.prevX,dy=this.y-this.prevY;
    const spd=Math.sqrt(dx*dx+dy*dy);
    const spdForgive=Math.min(0.3,spd*0.02);
    const effectiveR=this.radius*(baseForgive+spdForgive);
    // Check current position
    const d1=Math.sqrt((mx-this.x)**2+(my-this.y)**2);
    if(d1<=effectiveR)return true;
    // Motion compensation: also check against previous frame position
    // (player clicked where the target was visually rendered)
    if(spd>2){const d2=Math.sqrt((mx-this.prevX)**2+(my-this.prevY)**2);if(d2<=effectiveR)return true;
    // Check midpoint between prev and current for very fast movement
    if(spd>8){const midX=(this.x+this.prevX)/2,midY=(this.y+this.prevY)/2;const d3=Math.sqrt((mx-midX)**2+(my-midY)**2);if(d3<=effectiveR)return true}}
    return false;
  }
}
function spawnTargets(){
  targets=[];
  const c=roundTargetCount,t=(level-1)/24;
  // ── BASE VALUES from user-defined tuning endpoints ──
  const baseR=lerp(tuneSizeLv1,tuneSizeLv25,t),rv=lerp(5,4,t),baseS=lerp(tuneSpeedLv1,tuneSpeedLv25,t);
  
  // ── CAP MODIFIER: targets get harder when answer exceeds cap ──
  // capModifier ranges from 1.0 (no change) to 2.5 (max hardness)
  // Radius shrinks: divide by modifier (but never below 12px for human playability)
  // Speed increases: multiply by modifier (but never above 2.5x base)
  // Patterns shift toward harder types
  const cm=capModifier;
  const adjR=Math.max(12,baseR/Math.sqrt(cm)); // sqrt so it doesn't shrink too aggressively
  const adjS=baseS*Math.min(2.5,1+(cm-1)*0.6); // speed scales, capped at 2.5x
  
  // Use harder patterns if cap modifier is high
  let pats;
  if(cm>=2.0) pats=['chaos','teleport','dash','spiral','zigzag'];
  else if(cm>=1.5) pats=getPatterns(Math.min(25,level+5));
  else pats=getPatterns(level);
  
  // Use a harder pattern data level when capped
  const patLv=Math.min(25,level+Math.round((cm-1)*8)); // shift pattern intensity
  
  for(let i=0;i<c;i++){
    const r=adjR+(Math.random()-.5)*rv*2;
    const finalR=Math.max(12,Math.round(r)); // absolute minimum 12px radius
    const m=finalR+80;
    const x=randFloat(m,canvas.width-m),y=randFloat(m+60,canvas.height-m);
    const s=adjS*randFloat(.7,1.3);
    const pn=pats[i%pats.length];
    targets.push(new Target(x,y,finalR,s,pn,getPatData(pn,patLv)));
  }
}
function getPatterns(l){const p=['linear'];if(l>=3)p.push('circle');if(l>=5)p.push('figure8');if(l>=8)p.push('zigzag');if(l>=11)p.push('spiral');if(l>=14)p.push('teleport');if(l>=17)p.push('chaos');if(l>=20)p.push('dash');return p}
function getPatData(p,lv){const t=(lv-1)/24,a=lerp(60,200,t);switch(p){case'linear':return{ampX:a};case'circle':return{r:a*.6};case'figure8':return{aX:a,aY:a*.5};case'zigzag':return{aX:a,aY:a*.3};case'teleport':return{tc:lerp(.3,1.5,t),td:lerp(100,300,t)};case'spiral':return{bR:a*.4,aR:a*.3};case'chaos':return{a1:randFloat(30,a*.7),a2:randFloat(20,a*.5),a3:randFloat(25,a*.6),a4:randFloat(15,a*.4)};case'dash':return{dX:(Math.random()-.5)*a*1.5,dY:(Math.random()-.5)*a*.8};default:return{}}}

// ═══════════════ REFLEX MODE ENGINE ═══════════════
// Targets spawn on a fixed timer. Each lives for a set duration then vanishes (miss).
// Easy = slow spawns + long visibility. Hard = rapid spawns + short visibility.
let reflexSpawned=0,reflexTotal=0,reflexActive=false,reflexSpawnTimer=null;

function getReflexLifespan(lv){
  // How long each target stays visible — user-defined endpoints
  const t=(lv-1)/24;
  return Math.max(0.15,lerp(tuneVisLv1,tuneVisLv25,t));
}
function getReflexSpawnInterval(lv){
  // Time between each new target spawn — user-defined endpoints
  const t=(lv-1)/24;
  return Math.max(0.1,lerp(tuneSpawnLv1,tuneSpawnLv25,t));
}
function getReflexRadius(lv){
  const t=(lv-1)/24;
  const baseR=lerp(tuneSizeLv1,tuneSizeLv25,t);
  const cm=capModifier;
  return Math.max(10,baseR/Math.sqrt(cm));
}
function reflexSpawnOne(){
  if(!reflexActive||reflexSpawned>=reflexTotal)return;
  const r=getReflexRadius(level);
  const life=getReflexLifespan(level);
  const m=r+80;
  const x=randFloat(m,canvas.width-m),y=randFloat(m+60,canvas.height-m);
  targets.push(new Target(x,y,r,0,'reflex',{},life));
  reflexSpawned++;
  // Schedule next spawn if more remain
  if(reflexSpawned<reflexTotal){
    reflexSpawnTimer=setTimeout(reflexSpawnOne,getReflexSpawnInterval(level)*1000);
  }
}
function startReflexSpawning(){
  reflexSpawned=0;reflexTotal=roundTargetCount;reflexActive=true;
  // Spawn first target immediately
  reflexSpawnOne();
}
function checkReflexExpiry(){
  if(!reflexActive)return;
  for(let i=targets.length-1;i>=0;i--){
    const tg=targets[i];
    if(!tg.alive&&tg.expired===true){
      tg.expired='counted';
      roundMisses++;targetsRemaining--;comboCount=0;bullseyeChain=0;lastShotWasMiss=true;
      $('shootMisses').textContent=roundMisses;$('shootCombo').textContent='0';$('comboDisplay').classList.remove('visible');
      hitFeedbacks.push({x:tg.x,y:tg.y-tg.radius-10,label:'EXPIRED',sub:'Too slow!',color:'var(--red)',life:1.5,vy:-55});
      spawnMiss(tg.x,tg.y);updateShootHUD();
    }
  }
  // Clean up counted targets
  targets=targets.filter(t=>t.alive||t.expired!=='counted');
  // Check if round is complete: all spawned AND all resolved (hit or expired)
  if(reflexSpawned>=reflexTotal&&targets.filter(t=>t.alive).length===0&&targetsRemaining<=0){
    shootingActive=false;reflexActive=false;
    if(reflexSpawnTimer){clearTimeout(reflexSpawnTimer);reflexSpawnTimer=null}
    setTimeout(()=>{cancelAnimationFrame(animFrameId);showRoundResult()},500);
  }
}

class Particle{constructor(x,y,c){this.x=x;this.y=y;const a=Math.random()*Math.PI*2,s=randFloat(80,300);this.vx=Math.cos(a)*s;this.vy=Math.sin(a)*s;this.life=1;this.decay=randFloat(1.5,3.5);this.size=randFloat(2,5);this.color=c}update(d){this.x+=this.vx*d;this.y+=this.vy*d;this.vy+=200*d;this.life-=this.decay*d}draw(c){if(this.life<=0)return;c.globalAlpha=this.life;c.fillStyle=this.color;c.fillRect(this.x-this.size/2,this.y-this.size/2,this.size,this.size)}}
function spawnHit(x,y){playGameSound('hit');const c=['#ff2d95','#ff6b9d','#ffb3d1','#fff','#ff003c'];for(let i=0;i<20;i++)particles.push(new Particle(x,y,c[randInt(0,c.length-1)]))}
function spawnMiss(x,y){playGameSound('miss');for(let i=0;i<5;i++)particles.push(new Particle(x,y,'rgba(255,255,255,.3)'))}

// ═══════════════ CROSSHAIR DRAWING ═══════════════
function drawCross(c,x,y,isAI){
  c.save();const col=isAI?'rgba(255,215,0,.9)':'rgba(0,240,255,.8)';
  c.strokeStyle=col;c.lineWidth=isAI?2:1.5;c.beginPath();c.arc(x,y,isAI?22:18,0,Math.PI*2);c.stroke();
  const g=6,l=14;c.beginPath();c.moveTo(x-l,y);c.lineTo(x-g,y);c.moveTo(x+g,y);c.lineTo(x+l,y);c.moveTo(x,y-l);c.lineTo(x,y-g);c.moveTo(x,y+g);c.lineTo(x,y+l);c.stroke();
  c.fillStyle=col;c.beginPath();c.arc(x,y,2,0,Math.PI*2);c.fill();
  if(isAI){c.font='bold 10px Orbitron,sans-serif';c.fillStyle='rgba(255,215,0,.7)';c.textAlign='center';c.fillText('AI',x,y-26)}
  c.restore();
}

// ═══════════════ MOUSE & TOUCH (PLAYER MODE) ═══════════════
document.addEventListener('mousemove',e=>{mouseX=e.clientX;mouseY=e.clientY;mouseTrail.push({x:e.clientX,y:e.clientY,t:performance.now()});if(mouseTrail.length>50)mouseTrail.shift();if(shootingActive&&!demoMode){totalCursorDist+=Math.sqrt((e.clientX-lastMouseX)**2+(e.clientY-lastMouseY)**2);lastMouseX=e.clientX;lastMouseY=e.clientY}});
document.addEventListener('touchmove',e=>{if(!shootingActive||demoMode)return;const t=e.touches[0];mouseX=t.clientX;mouseY=t.clientY;mouseTrail.push({x:t.clientX,y:t.clientY,t:performance.now()});if(mouseTrail.length>50)mouseTrail.shift();totalCursorDist+=Math.sqrt((t.clientX-lastMouseX)**2+(t.clientY-lastMouseY)**2);lastMouseX=t.clientX;lastMouseY=t.clientY},{passive:true});
function handleShot(mx,my){
  if(!shootingActive||demoMode)return;
  const now=performance.now();
  const fl=document.createElement('div');fl.className='muzzle-flash';fl.style.left=mx+'px';fl.style.top=my+'px';document.body.appendChild(fl);setTimeout(()=>fl.remove(),200);
  totalClicks++;clickTimestamps.push(now);
  mouseTrail.push({x:mx,y:my,t:now});
  let hit=false;
  for(let i=targets.length-1;i>=0;i--){const tg=targets[i];if(tg.alive&&tg.hitTest(mx,my)){
    tg.alive=false;roundHits++;targetsRemaining--;hit=true;
    const d1=Math.sqrt((mx-tg.x)**2+(my-tg.y)**2),d2=Math.sqrt((mx-tg.prevX)**2+(my-tg.prevY)**2),d3=Math.sqrt((mx-(tg.x+tg.prevX)/2)**2+(my-(tg.y+tg.prevY)/2)**2),dist=Math.min(d1,d2,d3);
    const precPct=Math.round(Math.max(0,(1-dist/tg.radius))*100);roundAccuracyScores.push(precPct);
    const tsl=now-lastHitTime;roundHitTimes.push(tsl);lastHitTime=now;
    const trail=mouseTrail.filter(p=>now-p.t<80);let fpx=0;if(trail.length>=2){const f=trail[0],l=trail[trail.length-1],fd=Math.sqrt((l.x-f.x)**2+(l.y-f.y)**2),ft=(l.t-f.t)/1000;if(ft>0)fpx=fd/ft}roundFlickScores.push(fpx);
    if(!firstBloodAwarded){firstBloodTime=now-shootPhaseStartTime;firstBloodAwarded=true}
    comboCount++;if(comboCount>maxCombo)maxCombo=comboCount;if(comboCount>roundMaxCombo)roundMaxCombo=comboCount;
    const cMult=Math.min(3,1+Math.floor(comboCount/2)*.5);roundComboPoints+=Math.round(50*(cMult-1));
    if(precPct>=85){bullseyeChain++;if(bullseyeChain>maxBullseyeChain)maxBullseyeChain=bullseyeChain;roundBullseyeBonus+=20*Math.pow(2,Math.min(bullseyeChain-1,7))}else bullseyeChain=0;
    if(lastShotWasMiss&&precPct>=80&&tsl<=400)roundRecoveries++;lastShotWasMiss=false;
    if(roundMisses>0&&precPct>=90){clutchShotCount++;clutchOpportunities++}
    hitPositions.push({x:tg.x,y:tg.y});
    let fl2,fc;if(precPct>=95){fl2='PERFECT!';fc='#00f0ff'}else if(precPct>=80){fl2='GREAT!';fc='#39ff14'}else if(precPct>=60){fl2='GOOD';fc='#ffe600'}else if(precPct>=35){fl2='OK';fc='#ff6b00'}else{fl2='HIT';fc='#ff2d95'}
    let extra=[];if(comboCount>=3)extra.push(comboCount+'x');if(fpx>=1500)extra.push('INHUMAN');else if(fpx>=800)extra.push('⚡');if(bullseyeChain>=3)extra.push('🎯×'+bullseyeChain);
    hitFeedbacks.push({x:tg.x,y:tg.y-tg.radius-10,label:fl2+' '+precPct+'%',sub:Math.round(tsl)+'ms'+(extra.length?' '+extra.join(' '):''),color:fc,life:1.8,vy:-55});
    spawnHit(tg.x,tg.y);updateShootHUD();
    if(comboCount>=3){const cd=$('comboDisplay');cd.textContent=comboCount+'x COMBO';cd.style.color=comboCount>=7?'var(--pink)':comboCount>=5?'var(--green)':'var(--cyan)';cd.classList.add('visible');clearTimeout(cd._to);cd._to=setTimeout(()=>cd.classList.remove('visible'),1500)}
    if(targetsRemaining<=0&&(!reflexActive||targets.filter(t=>t.alive).length===0)){shootingActive=false;reflexActive=false;if(reflexSpawnTimer){clearTimeout(reflexSpawnTimer);reflexSpawnTimer=null}setTimeout(()=>{cancelAnimationFrame(animFrameId);showRoundResult()},500)}
    break;
  }}
  if(!hit){roundMisses++;comboCount=0;bullseyeChain=0;lastShotWasMiss=true;$('shootMisses').textContent=roundMisses;$('shootCombo').textContent='0';$('comboDisplay').classList.remove('visible');spawnMiss(mx,my)}
}
document.addEventListener('click',e=>handleShot(e.clientX,e.clientY));
document.addEventListener('touchstart',e=>{if(!shootingActive||demoMode)return;e.preventDefault();const t=e.changedTouches[0];handleShot(t.clientX,t.clientY)},{passive:false});

// ═══════════════ RENDER LOOP ═══════════════
let lastFrame=0;
function startShootLoop(){lastFrame=performance.now();if(animFrameId)cancelAnimationFrame(animFrameId);shootLoop()}
function shootLoop(){if(!shootingActive&&targetsRemaining<=0&&!reflexActive){drawFrame(0);return}animFrameId=requestAnimationFrame(shootLoop);const now=performance.now(),dt=Math.min((now-lastFrame)/1000,.05);lastFrame=now;drawFrame(dt,now)}
function drawFrame(dt,now){
  ctx.clearRect(0,0,canvas.width,canvas.height);ctx.strokeStyle='rgba(0,240,255,.04)';ctx.lineWidth=1;
  for(let x=0;x<canvas.width;x+=80){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke()}
  for(let y=0;y<canvas.height;y+=80){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke()}
  for(const t of targets){t.update(dt,now||performance.now());t.draw(ctx)}
  if(reflexActive)checkReflexExpiry();
  for(let i=particles.length-1;i>=0;i--){particles[i].update(dt);if(particles[i].life<=0)particles.splice(i,1);else particles[i].draw(ctx)}
  for(let i=hitFeedbacks.length-1;i>=0;i--){const f=hitFeedbacks[i];f.y+=f.vy*dt;f.life-=dt;if(f.life<=0){hitFeedbacks.splice(i,1);continue}ctx.save();ctx.globalAlpha=Math.min(1,f.life*2);ctx.fillStyle=f.color;ctx.font='bold 15px Orbitron,sans-serif';ctx.textAlign='center';ctx.shadowColor=f.color;ctx.shadowBlur=10;ctx.fillText(f.label,f.x,f.y);ctx.font='10px "Share Tech Mono",monospace';ctx.fillStyle='rgba(255,255,255,.5)';ctx.shadowBlur=0;ctx.fillText(f.sub,f.x,f.y+16);ctx.restore()}
  ctx.globalAlpha=1;
  if(shootingActive){if(demoMode)drawCross(ctx,aiX,aiY,true);else drawCross(ctx,mouseX,mouseY,false)}
}

// ═══════════════ ROUND SCORING ═══════════════
function calcRoundScore(){
  const S={},h=roundHits,m=roundMisses,tc=roundTargetCount;
  S.math=roundMathCorrect?100:0;
  
  // ── MATH SPEED BONUS (replaces old time-left bonus) ──
  // Compare elapsed time to par time: fast = big bonus, slow = penalty
  const speedRatio=expectedTime>0?mathElapsed/expectedTime:2;
  S.mathTime=mathElapsed.toFixed(1);S.parTime=expectedTime;
  if(!mathEnabled){S.timeBonus=0;S.timeRank='—';S.timeColor='var(--cyan)';S.math=0}
  else if(!roundMathCorrect){S.timeBonus=-50;S.timeRank='WRONG';S.timeColor='var(--red)'}
  else if(speedRatio<=0.3){S.timeBonus=250;S.timeRank='INSTANT';S.timeColor='var(--pink)'}
  else if(speedRatio<=0.5){S.timeBonus=180;S.timeRank='LIGHTNING';S.timeColor='var(--pink)'}
  else if(speedRatio<=0.75){S.timeBonus=120;S.timeRank='FAST';S.timeColor='var(--green)'}
  else if(speedRatio<=1.0){S.timeBonus=60;S.timeRank='ON PACE';S.timeColor='var(--cyan)'}
  else if(speedRatio<=1.5){S.timeBonus=20;S.timeRank='SLOW';S.timeColor='var(--yellow)'}
  else if(speedRatio<=2.0){S.timeBonus=-20;S.timeRank='SLUGGISH';S.timeColor='var(--orange)'}
  else{S.timeBonus=-60;S.timeRank='CRAWLING';S.timeColor='var(--red)'}
  
  S.hitPts=h*50;
  const cMult=Math.min(3,1+Math.floor(roundMaxCombo/2)*.5);S.streakMult=cMult;S.streakBonus=roundComboPoints;
  S.streakRank=roundMaxCombo>=5?'ON FIRE':roundMaxCombo>=3?'HOT':roundMaxCombo>=1?'WARM':'COLD';S.streakColor=roundMaxCombo>=5?'var(--pink)':roundMaxCombo>=3?'var(--green)':roundMaxCombo>=1?'var(--cyan)':'var(--red)';
  const af=roundFlickScores.length?roundFlickScores.reduce((a,b)=>a+b,0)/roundFlickScores.length:0;
  S.flickAvg=Math.round(af);S.flickBonus=af>=1500?h*40:af>=800?h*25:af>=200?h*10:0;S.flickPenalty=af<100&&h>0?-20:0;
  S.flickRank=af>=1500?'INHUMAN':af>=800?'LIGHTNING':af>=200?'FLICK':af>=50?'SNIPE':'STATIONARY';S.flickColor=af>=1500?'var(--pink)':af>=800?'var(--green)':af>=200?'var(--yellow)':af>=50?'var(--orange)':'var(--red)';
  S.fbMs=firstBloodAwarded?Math.round(firstBloodTime):0;S.fbBonus=S.fbMs<=200?350:S.fbMs<=500?100:S.fbMs<=1000?40:S.fbMs<=2000?0:-25;
  S.fbRank=S.fbMs<=200?'REFLEX GOD':S.fbMs<=500?'FIRST BLOOD':S.fbMs<=1000?'ALERT':S.fbMs<=2000?'SLOW':'ASLEEP';S.fbColor=S.fbMs<=200?'var(--pink)':S.fbMs<=500?'var(--green)':S.fbMs<=1000?'var(--yellow)':S.fbMs<=2000?'var(--orange)':'var(--red)';
  if(!firstBloodAwarded){S.fbBonus=-50;S.fbRank='NO HITS';S.fbColor='var(--red)'}
  S.confPct=Math.round(mathConfidenceRatio*100);S.confMult=mathConfidenceRatio>=.9?1.5:mathConfidenceRatio>=.7?1.3:mathConfidenceRatio>=.5?1.15:mathConfidenceRatio>=.25?1:.85;
  S.confRank=mathConfidenceRatio>=.9?'GENIUS':mathConfidenceRatio>=.7?'CONFIDENT':mathConfidenceRatio>=.5?'STEADY':mathConfidenceRatio>=.25?'SLOW':'STUMPED';S.confColor=mathConfidenceRatio>=.9?'var(--pink)':mathConfidenceRatio>=.7?'var(--green)':mathConfidenceRatio>=.5?'var(--yellow)':mathConfidenceRatio>=.25?'var(--orange)':'var(--red)';
  if(!mathEnabled){S.confPct=100;S.confMult=1;S.confRank='—';S.confColor='var(--cyan)'}
  else if(!roundMathCorrect){S.confMult=.5;S.confRank='WRONG';S.confColor='var(--red)'}
  S.bullMax=maxBullseyeChain;S.bullBonus=roundBullseyeBonus;if(maxBullseyeChain>=tc&&tc>0)S.bullBonus+=500;
  S.bullRank=maxBullseyeChain>=5?'DIAMOND EYE':maxBullseyeChain>=3?'SHARPSHOOTER':maxBullseyeChain>=1?'FOCUSED':'NONE';S.bullColor=maxBullseyeChain>=5?'var(--pink)':maxBullseyeChain>=3?'var(--green)':maxBullseyeChain>=1?'var(--yellow)':'var(--red)';
  const er=totalClicks>0?h/totalClicks:0;S.effPct=Math.round(er*100);S.effBonus=Math.round(300*er);if(er<.4&&totalClicks>0)S.effBonus=Math.max(-50,S.effBonus-100);
  S.effRank=er>=1?'SURGICAL':er>=.8?'PRECISE':er>=.6?'DECENT':er>=.4?'SLOPPY':'SPRAY & PRAY';S.effColor=er>=1?'var(--pink)':er>=.8?'var(--green)':er>=.6?'var(--yellow)':er>=.4?'var(--orange)':'var(--red)';
  let od=0;for(let i=1;i<hitPositions.length;i++){const a=hitPositions[i-1],b=hitPositions[i];od+=Math.sqrt((b.x-a.x)**2+(b.y-a.y)**2)}
  const pe=totalCursorDist>0&&od>0?Math.min(1,od/totalCursorDist):0;S.pathPct=Math.round(pe*100);S.pathBonus=pe>=.9?200:pe>=.7?100:pe>=.5?50:pe>=.3?10:h>0?-30:0;
  S.pathRank=pe>=.9?'LASER PATH':pe>=.7?'CLEAN ROUTE':pe>=.5?'ADEQUATE':pe>=.3?'WANDERER':'LOST';S.pathColor=pe>=.9?'var(--pink)':pe>=.7?'var(--green)':pe>=.5?'var(--yellow)':pe>=.3?'var(--orange)':'var(--red)';
  S.pressMult=problemDifficultyMult;S.pressColor=problemDifficultyMult>=2.5?'var(--red)':problemDifficultyMult>=1.8?'var(--orange)':problemDifficultyMult>=1.3?'var(--yellow)':'var(--cyan)';
  S.recCount=roundRecoveries;
  if(m===0){S.recBonus=50;S.recRank='CLEAN';S.recColor='var(--green)'}else if(roundRecoveries>=m){S.recBonus=roundRecoveries*35;S.recRank='FULL RECOVERY';S.recColor='var(--green)'}else if(roundRecoveries>0){S.recBonus=roundRecoveries*25;S.recRank='PARTIAL';S.recColor='var(--yellow)'}else{S.recBonus=-m*15;S.recRank='NO RECOVERY';S.recColor='var(--red)'}
  const avgHD=roundHitTimes.length?roundHitTimes.reduce((a,b)=>a+b,0)/roundHitTimes.length:9999;
  S.priorBonus=avgHD<400?h*15:avgHD<700?h*8:avgHD<1200?0:-h*5;S.priorRank=avgHD<400?'TACTICAL':avgHD<700?'AWARE':avgHD<1200?'RANDOM':'LOST';S.priorColor=avgHD<400?'var(--green)':avgHD<700?'var(--yellow)':avgHD<1200?'var(--orange)':'var(--red)';
  if(clickTimestamps.length>=3){const gaps=[];for(let i=1;i<clickTimestamps.length;i++)gaps.push(clickTimestamps[i]-clickTimestamps[i-1]);const mn=gaps.reduce((a,b)=>a+b,0)/gaps.length;const sd=Math.sqrt(gaps.reduce((a,b)=>a+(b-mn)**2,0)/gaps.length);S.hbStd=Math.round(sd);S.hbBonus=sd<100?150:sd<200?80:sd<300?40:sd<500?0:-30;S.hbRank=sd<100?'METRONOME':sd<200?'STEADY':sd<300?'COMPOSED':sd<500?'ERRATIC':'PANICKED';S.hbColor=sd<100?'var(--pink)':sd<200?'var(--green)':sd<300?'var(--yellow)':sd<500?'var(--orange)':'var(--red)'}else{S.hbStd=0;S.hbBonus=0;S.hbRank='—';S.hbColor='var(--cyan)'}
  const ap=roundAccuracyScores.length?Math.round(roundAccuracyScores.reduce((a,b)=>a+b,0)/roundAccuracyScores.length):0;
  const as2=roundHitTimes.length?Math.round(roundHitTimes.reduce((a,b)=>a+b,0)/roundHitTimes.length):0;
  let pB=roundAccuracyScores.reduce((s,p)=>s+Math.round(p*.5),0);if(ap<30&&h>0)pB-=50;
  let sB=0;for(const t of roundHitTimes){sB+=t<=300?30:t<=500?25:t<=800?15:t<=1200?5:0}if(as2>2000&&h>0)sB-=30;
  S.avgPrec=ap;S.avgSpd=as2;S.precBonus=pB;S.spdBonus=sB;
  S.precRank=ap>=90?'DEAD CENTER':ap>=70?'SHARP':ap>=50?'FAIR':ap>=30?'LOOSE':'WILD';S.precColor=ap>=90?'var(--pink)':ap>=70?'var(--green)':ap>=50?'var(--yellow)':ap>=30?'var(--orange)':'var(--red)';
  S.spdRank=as2<=300?'BLAZING':as2<=500?'FAST':as2<=800?'MODERATE':as2<=1200?'SLOW':'SLUGGISH';S.spdColor=as2&&as2<=300?'var(--pink)':as2<=500?'var(--green)':as2<=800?'var(--yellow)':as2<=1200?'var(--orange)':'var(--red)';
  // ── CAP MODIFIER: bonus multiplier when targets were harder due to cap ──
  S.capMod=capModifier;
  S.capColor=capModifier>=2?'var(--red)':capModifier>=1.5?'var(--orange)':capModifier>=1.2?'var(--yellow)':'var(--green)';
  S.capRank=capModifier>=2?'BRUTAL':capModifier>=1.5?'INTENSE':capModifier>=1.2?'BOOSTED':'STANDARD';
  
  let raw=S.math+S.timeBonus+S.hitPts+S.precBonus+S.spdBonus+S.streakBonus+S.flickBonus+(S.flickPenalty||0)+S.fbBonus+S.bullBonus+S.effBonus+S.pathBonus+S.recBonus+S.hbBonus+S.priorBonus;
  raw=Math.round(raw*S.confMult*S.pressMult*S.capMod);S.total=Math.max(0,raw);return S;
}
function sig(n){return n>=0?'+'+n:''+n}

function showRoundResult(){
  showScreen('roundResultScreen');const S=calcRoundScore();score+=S.total;
  roundHistory.push({round:currentRound,mathCorrect:roundMathCorrect,S,hits:roundHits,misses:roundMisses,targetCount:roundTargetCount,maxCombo:roundMaxCombo});
  $('roundResultTitle').textContent=`ROUND ${currentRound} — ${S.total} PTS`;
  const g=$('roundStatsGrid');g.innerHTML='';
  const allCards=[{l:'Math',v:roundMathCorrect?'✓':'✗',c:roundMathCorrect?'var(--green)':'var(--red)',s:'',math:true},{l:'Answer',v:correctAnswer,c:'var(--cyan)',s:roundTargetCount<correctAnswer?correctAnswer+' targets → '+roundTargetCount+' (capped)':correctAnswer+' targets',math:true},{l:'Solve Time',v:S.mathTime+'s',c:S.timeColor,s:S.timeRank+' '+sig(S.timeBonus)+' (par '+S.parTime+'s)',math:true},{l:'Confidence',v:S.confPct+'%',c:S.confColor,s:S.confRank+' ×'+S.confMult.toFixed(1),math:true},{l:'Pressure',v:S.pressMult.toFixed(1)+'x',c:S.pressColor,s:'Diff multiplier',math:true},{l:'Cap Mod',v:S.capMod.toFixed(1)+'x',c:S.capColor,s:S.capRank+(S.capMod>1?' (×'+S.capMod.toFixed(1)+' score)':''),math:true},{l:'Targets',v:roundHits+'/'+roundTargetCount,c:roundHits===roundTargetCount?'var(--green)':'var(--yellow)',s:''},{l:'Precision',v:S.avgPrec+'%',c:S.precColor,s:S.precRank+' '+sig(S.precBonus)},{l:'Speed',v:S.avgSpd?S.avgSpd+'ms':'—',c:S.spdColor,s:S.spdRank+' '+sig(S.spdBonus)},{l:'Combo',v:roundMaxCombo+'x',c:S.streakColor,s:S.streakRank+' '+sig(S.streakBonus)},{l:'Flick',v:S.flickAvg+'px/s',c:S.flickColor,s:S.flickRank+' '+sig(S.flickBonus+(S.flickPenalty||0))},{l:'1st Blood',v:S.fbMs?S.fbMs+'ms':'—',c:S.fbColor,s:S.fbRank+' '+sig(S.fbBonus)},{l:'Bullseye',v:S.bullMax+'x',c:S.bullColor,s:S.bullRank+' '+sig(S.bullBonus)},{l:'Efficiency',v:S.effPct+'%',c:S.effColor,s:S.effRank+' '+sig(S.effBonus)},{l:'Heartbeat',v:S.hbStd?'σ'+S.hbStd+'ms':'—',c:S.hbColor,s:S.hbRank+' '+sig(S.hbBonus)},{l:'Recovery',v:roundMisses===0?'CLEAN':S.recCount+'/'+roundMisses,c:S.recColor,s:S.recRank+' '+sig(S.recBonus)}];
  allCards.filter(c=>!c.math||mathEnabled).forEach(c=>{const d=document.createElement('div');d.className='stat-card';d.innerHTML=`<div class="stat-card-label">${c.l}</div><div class="stat-card-value" style="color:${c.c}">${c.v}</div>${c.s?`<div class="stat-card-sub" style="color:${c.c}">${c.s}</div>`:''}`;g.appendChild(d)});
  $('nextRoundBtn').textContent=currentRound>=totalRounds?'VIEW RESULTS':'NEXT ROUND';
}

function showFinalResults(){
  showScreen('finalScreen');
  // Populate match info
  if(demoMode){
    $('finalMatchInfo').textContent='AI DEMO — Levels 1, 5, 10, 15, 20, 25';$('finalMatchInfo').style.color='var(--pink)';
  }else{
    const lc=getLevelColor(level);const desc=getLevelDesc(level).split('•')[0].trim();
    const modeLabel=gameMode==='reflex'?' — <span style="color:var(--yellow);font-family:Orbitron,sans-serif;font-weight:700">REFLEX</span>':' — <span style="color:var(--cyan);font-family:Orbitron,sans-serif;font-weight:700">MOVING</span>';
    const mathLabel=mathEnabled?'':' — <span style="color:var(--green);font-family:Orbitron,sans-serif;font-weight:700">AIM ONLY</span>';
    const isDefaultTune=tuneSizeLv1===45&&tuneSizeLv25===14&&tuneSpeedLv1===0.8&&tuneSpeedLv25===4.5&&tuneVisLv1===3.0&&tuneVisLv25===0.55&&tuneSpawnLv1===2.0&&tuneSpawnLv25===0.35;
    const tuneLabel=isDefaultTune?'':' — <span style="color:var(--yellow);font-family:Share Tech Mono,monospace;font-size:11px">CUSTOM</span>';
    $('finalMatchInfo').innerHTML='Level <span style="color:'+lc+';font-family:Orbitron,sans-serif;font-weight:700">'+level+'</span> — '+desc+' — '+totalRounds+' Rounds'+modeLabel+mathLabel+tuneLabel;$('finalMatchInfo').style.color='rgba(255,255,255,.5)';
  }
  let tH=0,tM=0,tT=0,mC=0,allP=[],allS=[],allF=[],allE=[],allPa=[],allHB=[],bC=0,bBC=0,bFB=Infinity;
  roundHistory.forEach(r=>{const s=r.S;tH+=r.hits;tM+=r.misses;tT+=r.targetCount;if(r.mathCorrect)mC++;if(s.avgPrec>0&&r.hits>0)for(let i=0;i<r.hits;i++)allP.push(s.avgPrec);if(s.avgSpd>0&&r.hits>0)for(let i=0;i<r.hits;i++)allS.push(s.avgSpd);if(s.flickAvg>0)allF.push(s.flickAvg);allE.push(s.effPct);allPa.push(s.pathPct);if(s.hbStd>0)allHB.push(s.hbStd);if(r.maxCombo>bC)bC=r.maxCombo;if(s.bullMax>bBC)bBC=s.bullMax;if(s.fbMs>0&&s.fbMs<bFB)bFB=s.fbMs});if(bFB===Infinity)bFB=0;
  const tSh=tH+tM,hR=tSh>0?Math.round(tH/tSh*100):0,aP=allP.length?Math.round(allP.reduce((a,b)=>a+b,0)/allP.length):0,aS=allS.length?Math.round(allS.reduce((a,b)=>a+b,0)/allS.length):0,aF=allF.length?Math.round(allF.reduce((a,b)=>a+b,0)/allF.length):0,aE=allE.length?Math.round(allE.reduce((a,b)=>a+b,0)/allE.length):0,aPa=allPa.length?Math.round(allPa.reduce((a,b)=>a+b,0)/allPa.length):0,aHB=allHB.length?Math.round(allHB.reduce((a,b)=>a+b,0)/allHB.length):0;
  const cR=clutchOpportunities>0?Math.round((clutchMathCount+clutchShotCount)/clutchOpportunities*100):0;let cB=cR>=80?200:cR>=50?80:cR>=25?30:clutchOpportunities>0?-30:0;score+=cB;
  const cRk=cR>=80?'ICE VEINS':cR>=50?'CLUTCH':cR>=25?'TRIES':clutchOpportunities>0?'CHOKES':'NONE',cCl=cR>=80?'var(--pink)':cR>=50?'var(--green)':cR>=25?'var(--yellow)':clutchOpportunities>0?'var(--red)':'var(--cyan)';
  const half=Math.floor(roundHistory.length/2);let eM=1,eRk='—',eCl='var(--cyan)';
  if(half>=2){const f=roundHistory.slice(0,half),s2=roundHistory.slice(half);const a1=f.reduce((s,r)=>s+r.S.total,0)/f.length,a2=s2.reduce((s,r)=>s+r.S.total,0)/s2.length;const imp=a2/(a1||1);if(imp>=1.2){eM=1.4;eRk='IRONMAN';eCl='var(--pink)'}else if(imp>=1.05){eM=1.2;eRk='ENDURING';eCl='var(--green)'}else if(imp>=.95){eM=1;eRk='STEADY';eCl='var(--yellow)'}else if(imp>=.8){eM=.9;eRk='FATIGUED';eCl='var(--orange)'}else{eM=.75;eRk='COLLAPSED';eCl='var(--red)'}}
  score=Math.round(score*eM);
  const pb=getPersonalBest();let gD=0,gRk='1ST RUN',gCl='var(--green)';
  if(pb){gD=score-pb.score;if(gD>0){gRk='NEW RECORD!';gCl='var(--pink)';score+=500;setPersonalBest({score})}else if(gD===0){gRk='TIED';gCl='var(--yellow)'}else{gRk='BELOW BEST';gCl='var(--red)'}}else setPersonalBest({score});
  const mPct=mC/totalRounds,hPct=tT>0?tH/tT:0,pN=aP/100,sN=aS>0?Math.max(0,1-aS/2000):0,cN=Math.min(1,bC/10),eN=aE/100,edN=eM>=1.2?1:eM>=1?.7:eM>=.9?.5:.2,clN=cR/100;
  const mastery=mathEnabled?
    Math.round(mPct*150+hPct*150+pN*200+sN*150+cN*100+eN*100+edN*100+clN*50):
    Math.round(hPct*200+pN*250+sN*200+cN*120+eN*120+edN*80+clN*30);
  const mG=mastery>=950?'S+':mastery>=850?'S':mastery>=750?'A':mastery>=600?'B':mastery>=400?'C':mastery>=200?'D':'F';
  $('finalScoreBig').textContent=score.toLocaleString();const mf=$('masteryFill');mf.style.width=Math.min(100,mastery/10)+'%';mf.style.background=mastery>=800?'linear-gradient(90deg,var(--cyan),var(--pink))':mastery>=600?'linear-gradient(90deg,var(--green),var(--cyan))':mastery>=400?'var(--yellow)':'var(--red)';$('masteryLabel').textContent=`MASTERY: ${mastery}/1000 — GRADE: ${mG}`;
  const mg=$('finalMetricsGrid');mg.innerHTML='';
  const fmCards=[{t:'Hit Rate',v:hR+'%',c:hR>=90?'var(--pink)':hR>=70?'var(--green)':hR>=50?'var(--yellow)':'var(--red)',r:hR>=90?'LETHAL':hR>=70?'ACCURATE':hR>=50?'FAIR':'POOR'},{t:'Math',v:mC+'/'+totalRounds,c:mPct>=.9?'var(--pink)':mPct>=.7?'var(--green)':mPct>=.5?'var(--yellow)':'var(--red)',r:mPct>=.9?'GENIUS':mPct>=.7?'SHARP':mPct>=.5?'OKAY':'WEAK',math:true},{t:'Precision',v:aP+'%',c:aP>=90?'var(--pink)':aP>=70?'var(--green)':aP>=50?'var(--yellow)':'var(--red)',r:aP>=90?'DEAD CENTER':aP>=70?'SHARP':aP>=50?'FAIR':'WILD'},{t:'Avg Speed',v:aS?aS+'ms':'—',c:aS&&aS<=300?'var(--pink)':aS<=500?'var(--green)':aS<=800?'var(--yellow)':'var(--red)',r:aS<=300?'BLAZING':aS<=500?'FAST':aS<=800?'MODERATE':'SLOW'},{t:'Best Combo',v:bC+'x',c:bC>=10?'var(--pink)':bC>=5?'var(--green)':bC>=3?'var(--yellow)':'var(--red)',r:bC>=10?'LEGENDARY':bC>=5?'ON FIRE':bC>=3?'HOT':'COLD'},{t:'Avg Flick',v:aF+'px/s',c:aF>=1500?'var(--pink)':aF>=800?'var(--green)':aF>=200?'var(--yellow)':'var(--orange)',r:aF>=1500?'INHUMAN':aF>=800?'LIGHTNING':aF>=200?'FLICK':'SNIPE'},{t:'Best 1st Blood',v:bFB?bFB+'ms':'—',c:bFB&&bFB<=200?'var(--pink)':bFB<=500?'var(--green)':bFB<=1000?'var(--yellow)':'var(--red)',r:bFB<=200?'REFLEX GOD':bFB<=500?'QUICK DRAW':bFB<=1000?'ALERT':'SLOW'},{t:'Bullseye',v:bBC+'x',c:bBC>=5?'var(--pink)':bBC>=3?'var(--green)':bBC>=1?'var(--yellow)':'var(--red)',r:bBC>=5?'DIAMOND EYE':bBC>=3?'SHARPSHOOTER':bBC>=1?'FOCUSED':'NONE'},{t:'Efficiency',v:aE+'%',c:aE>=95?'var(--pink)':aE>=80?'var(--green)':aE>=60?'var(--yellow)':'var(--red)',r:aE>=95?'SURGICAL':aE>=80?'PRECISE':aE>=60?'DECENT':'SLOPPY'},{t:'Path Eff',v:aPa+'%',c:aPa>=90?'var(--pink)':aPa>=70?'var(--green)':aPa>=50?'var(--yellow)':'var(--red)',r:aPa>=90?'LASER':aPa>=70?'CLEAN':aPa>=50?'OK':'WANDER'},{t:'Heartbeat',v:aHB?'σ'+aHB+'ms':'—',c:aHB&&aHB<100?'var(--pink)':aHB<200?'var(--green)':aHB<300?'var(--yellow)':'var(--red)',r:aHB<100?'METRONOME':aHB<200?'STEADY':aHB<300?'OK':'ERRATIC'},{t:'Endurance',v:'×'+eM.toFixed(2),c:eCl,r:eRk},{t:'Clutch',v:cR+'%',c:cCl,r:cRk},{t:'Ghost',v:pb&&gD!==undefined?(gD>=0?'+':'')+gD:'1ST',c:gCl,r:gRk},{t:'Mastery',v:mG,c:mastery>=850?'var(--cyan)':mastery>=600?'var(--green)':mastery>=400?'var(--yellow)':'var(--red)',r:mastery+'/1000'}];
  fmCards.filter(m=>!m.math||mathEnabled).forEach(m=>{const d=document.createElement('div');d.className='fm-card';d.innerHTML=`<div class="fm-title">${m.t}</div><div class="fm-value" style="color:${m.c}">${m.v}</div><div class="fm-rank" style="color:${m.c}">${m.r}</div>`;mg.appendChild(d)});
  const tb=$('breakdownBody');tb.innerHTML='';
  // Dynamically set headers based on math mode
  const bHead=tb.closest('table').querySelector('thead tr');
  bHead.innerHTML=mathEnabled?'<th>#</th><th>Math</th><th>Hits</th><th>Prec</th><th>Spd</th><th>Combo</th><th>Flick</th><th>Eff</th><th>Miss</th><th>Pts</th>':'<th>#</th><th>Hits</th><th>Prec</th><th>Spd</th><th>Combo</th><th>Flick</th><th>Eff</th><th>Miss</th><th>Pts</th>';
  roundHistory.forEach(r=>{const s=r.S,tr=document.createElement('tr');
    if(mathEnabled){tr.innerHTML=`<td>${r.round}</td><td style="color:${r.mathCorrect?'var(--green)':'var(--red)'}">${r.mathCorrect?'✓':'✗'}</td><td>${r.mathCorrect?r.hits+'/'+r.targetCount:'—'}</td><td style="color:${s.precColor}">${s.avgPrec}%</td><td style="color:${s.spdColor}">${s.avgSpd||'—'}</td><td style="color:${s.streakColor}">${r.maxCombo}x</td><td style="color:${s.flickColor}">${s.flickRank}</td><td style="color:${s.effColor}">${s.effPct}%</td><td style="color:${r.misses>0?'var(--red)':'var(--green)'}">${r.misses}</td><td style="color:var(--cyan)">${s.total}</td>`}
    else{tr.innerHTML=`<td>${r.round}</td><td>${r.hits}/${r.targetCount}</td><td style="color:${s.precColor}">${s.avgPrec}%</td><td style="color:${s.spdColor}">${s.avgSpd||'—'}</td><td style="color:${s.streakColor}">${r.maxCombo}x</td><td style="color:${s.flickColor}">${s.flickRank}</td><td style="color:${s.effColor}">${s.effPct}%</td><td style="color:${r.misses>0?'var(--red)':'var(--green)'}">${r.misses}</td><td style="color:var(--cyan)">${s.total}</td>`}
    tb.appendChild(tr)});
  if(demoMode){$('demoBanner').classList.remove('visible');gameMode=demoSavedMode;mathEnabled=demoSavedMath;restoreTune();demoMode=false;demoActive=false}
}

// ═══════════════ UTILITIES ═══════════════
function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function randFloat(a,b){return Math.random()*(b-a)+a}
function lerp(a,b,t){return a+(b-a)*Math.max(0,Math.min(1,t))}
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=randInt(0,i);[a[i],a[j]]=[a[j],a[i]]}return a}
document.addEventListener('contextmenu',e=>{if(shootingActive)e.preventDefault()});

// ═══════════════ SAVE SCORE SCREENSHOT ═══════════════
$('saveScoreBtn').addEventListener('click',saveScoreScreenshot);
function saveScoreScreenshot(){
  const btn=$('saveScoreBtn');
  const origText=btn.textContent;
  btn.textContent='SAVING...';btn.style.pointerEvents='none';
  
  // Hide buttons and exit btn during capture
  const btnsDiv=document.querySelector('.final-buttons');
  const exitB=$('exitBtn');
  btnsDiv.style.display='none';exitB.style.display='none';
  
  const el=$('finalScreen');
  // Temporarily make finalScreen fill content naturally for capture
  const origStyles={position:el.style.position,overflow:el.style.overflow,height:el.style.height};
  el.style.position='relative';el.style.overflow='visible';el.style.height='auto';
  
  // Use canvas to render
  const W=960,pad=40;
  const c=document.createElement('canvas');const ctx=c.getContext('2d');
  
  // Resolve CSS variables
  const cs=getComputedStyle(document.documentElement);
  function resolveColor(col){
    if(!col)return'#ffffff';
    const m=col.match(/var\(--(\w+)\)/);
    if(m)return cs.getPropertyValue('--'+m[1]).trim();
    return col;
  }
  
  // Gather data from the DOM
  const title=$('finalScreen').querySelector('.final-title').textContent;
  const scoreBig=$('finalScoreBig').textContent;
  const masteryText=$('masteryLabel').textContent;
  const masteryFillW=parseFloat($('masteryFill').style.width)||0;
  const masteryBg=$('masteryFill').style.background||'var(--cyan)';
  
  // Metric cards
  const cards=[...document.querySelectorAll('#finalMetricsGrid .fm-card')].map(cd=>({
    t:cd.querySelector('.fm-title').textContent,
    v:cd.querySelector('.fm-value').textContent,
    vc:cd.querySelector('.fm-value').style.color,
    r:cd.querySelector('.fm-rank').textContent,
    rc:cd.querySelector('.fm-rank').style.color
  }));
  
  // Round breakdown rows
  const rows=[...document.querySelectorAll('#breakdownBody tr')].map(tr=>{
    const tds=[...tr.querySelectorAll('td')];
    return tds.map(td=>({text:td.textContent,color:td.style.color||'rgba(255,255,255,.7)'}));
  });
  const headers=[...document.querySelectorAll('.breakdown-table thead th')].map(th=>th.textContent);
  
  // Calculate dimensions
  const cardW=108,cardH=70,cardGap=8,cardsPerRow=Math.min(5,Math.floor((W-pad*2+cardGap)/(cardW+cardGap)));
  const cardRows=Math.ceil(cards.length/cardsPerRow);
  const rowH=22,headerH=24;
  
  let H=pad+50+80+40+20+30+(cardRows*(cardH+cardGap))+30+headerH+(rows.length*rowH)+pad+40;
  
  c.width=W;c.height=H;
  
  // Background
  ctx.fillStyle='#0a0a1a';ctx.fillRect(0,0,W,H);
  // Grid overlay
  ctx.strokeStyle='rgba(0,240,255,.03)';ctx.lineWidth=1;
  for(let x=0;x<W;x+=60){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke()}
  for(let y=0;y<H;y+=60){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke()}
  // Subtle glow
  const grd=ctx.createRadialGradient(W*.3,H*.3,0,W*.3,H*.3,W*.6);
  grd.addColorStop(0,'rgba(0,240,255,.04)');grd.addColorStop(1,'transparent');
  ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);
  
  let y=pad;
  
  // Title
  ctx.font='900 28px Orbitron,sans-serif';ctx.textAlign='center';
  const tGrd=ctx.createLinearGradient(W*.3,y,W*.7,y);
  tGrd.addColorStop(0,'#00f0ff');tGrd.addColorStop(1,'#39ff14');
  ctx.fillStyle=tGrd;ctx.fillText(title,W/2,y+28);
  y+=50;
  
  // Big score
  ctx.font='900 64px Orbitron,sans-serif';ctx.fillStyle='#ffffff';
  ctx.shadowColor='rgba(0,240,255,.4)';ctx.shadowBlur=30;
  ctx.fillText(scoreBig,W/2,y+58);
  ctx.shadowBlur=0;
  y+=70;
  
  // "TOTAL SCORE" label
  ctx.font='13px "Share Tech Mono",monospace';ctx.fillStyle='rgba(255,255,255,.4)';ctx.letterSpacing='4px';
  ctx.fillText('TOTAL SCORE',W/2,y+13);
  y+=30;
  
  // Mastery bar
  const barW=400,barH=10,barX=(W-barW)/2;
  ctx.fillStyle='rgba(255,255,255,.06)';
  ctx.beginPath();ctx.roundRect(barX,y,barW,barH,5);ctx.fill();
  // Fill
  const fillW=barW*(masteryFillW/100);
  if(fillW>0){
    let barGrd;
    if(masteryBg.includes('pink')){barGrd=ctx.createLinearGradient(barX,0,barX+fillW,0);barGrd.addColorStop(0,'#00f0ff');barGrd.addColorStop(1,'#ff2d95')}
    else if(masteryBg.includes('green')){barGrd=ctx.createLinearGradient(barX,0,barX+fillW,0);barGrd.addColorStop(0,'#39ff14');barGrd.addColorStop(1,'#00f0ff')}
    else if(masteryBg.includes('yellow')){barGrd='#ffe600'}
    else{barGrd='#ff003c'}
    ctx.fillStyle=barGrd;
    ctx.beginPath();ctx.roundRect(barX,y,fillW,barH,5);ctx.fill();
  }
  y+=barH+6;
  ctx.font='11px "Share Tech Mono",monospace';ctx.fillStyle='rgba(255,255,255,.4)';
  ctx.fillText(masteryText,W/2,y+11);
  y+=26;
  
  // Metric cards
  const gridW=cardsPerRow*(cardW+cardGap)-cardGap;
  const gridX=(W-gridW)/2;
  cards.forEach((cd,i)=>{
    const col=i%cardsPerRow,row=Math.floor(i/cardsPerRow);
    const cx=gridX+col*(cardW+cardGap),cy=y+row*(cardH+cardGap);
    // Card bg
    ctx.fillStyle='rgba(10,10,30,.92)';ctx.strokeStyle='rgba(255,255,255,.06)';ctx.lineWidth=1;
    ctx.beginPath();ctx.roundRect(cx,cy,cardW,cardH,8);ctx.fill();ctx.stroke();
    // Title
    ctx.font='8px "Share Tech Mono",monospace';ctx.fillStyle='rgba(255,255,255,.3)';ctx.textAlign='center';
    ctx.fillText(cd.t.toUpperCase(),cx+cardW/2,cy+14);
    // Value
    ctx.font='900 18px Orbitron,sans-serif';ctx.fillStyle=resolveColor(cd.vc);
    ctx.fillText(cd.v,cx+cardW/2,cy+36);
    // Rank
    ctx.font='9px "Share Tech Mono",monospace';ctx.fillStyle=resolveColor(cd.rc);
    ctx.fillText(cd.r,cx+cardW/2,cy+50);
  });
  y+=cardRows*(cardH+cardGap)+20;
  
  // Breakdown title
  ctx.font='12px "Share Tech Mono",monospace';ctx.fillStyle='rgba(255,255,255,.35)';ctx.textAlign='center';
  ctx.fillText('ROUND BREAKDOWN',W/2,y+12);
  y+=24;
  
  // Table headers
  const colW=(W-pad*2)/headers.length;
  const tableX=pad;
  ctx.font='9px "Share Tech Mono",monospace';ctx.fillStyle='rgba(255,255,255,.3)';
  headers.forEach((h,i)=>{ctx.textAlign='center';ctx.fillText(h.toUpperCase(),tableX+i*colW+colW/2,y+10)});
  ctx.strokeStyle='rgba(255,255,255,.08)';ctx.beginPath();ctx.moveTo(tableX,y+headerH-4);ctx.lineTo(W-pad,y+headerH-4);ctx.stroke();
  y+=headerH;
  
  // Table rows
  rows.forEach(row=>{
    row.forEach((cell,i)=>{
      ctx.font='600 13px Rajdhani,sans-serif';
      ctx.fillStyle=resolveColor(cell.color);ctx.textAlign='center';
      ctx.fillText(cell.text,tableX+i*colW+colW/2,y+15);
    });
    ctx.strokeStyle='rgba(255,255,255,.04)';ctx.beginPath();ctx.moveTo(tableX,y+rowH-2);ctx.lineTo(W-pad,y+rowH-2);ctx.stroke();
    y+=rowH;
  });
  
  // Footer watermark
  y+=16;
  ctx.font='10px "Share Tech Mono",monospace';ctx.fillStyle='rgba(255,255,255,.2)';ctx.textAlign='center';
  ctx.fillText('MATH AIM — SOLVE & SHOOT',W/2,y+10);
  
  // Download
  c.toBlob(blob=>{
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download='MATH_AIM_Score_'+Date.now()+'.png';
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
    // Restore
    btnsDiv.style.display='';exitB.style.display='';
    el.style.position=origStyles.position;el.style.overflow=origStyles.overflow;el.style.height=origStyles.height;
    btn.textContent='✓ SAVED';btn.style.color='var(--green)';btn.style.borderColor='var(--green)';
    setTimeout(()=>{btn.textContent=origText;btn.style.color='';btn.style.borderColor='';btn.style.pointerEvents=''},2000);
  },'image/png');
}
// ═══════════════ SOUND ENGINE ═══════════════
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let soundEnabled = true;
let soundVolume = 0.8;
let soundAssignMode = 'hit'; // 'hit' or 'miss'
let selectedHitSound = 'plasma_burst';
let selectedMissSound = 'dull_thud';

function sndNoiseBuf(dur) {
  const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * dur, audioCtx.sampleRate);
  const d = buf.getChannelData(0);
  for (let i = 0; i < d.length; i++) d[i] = Math.random() * 2 - 1;
  return buf;
}

const SOUND_DEFS = [
  { id: 'plasma_burst', name: 'Plasma Burst', desc: 'Fast sine drop + noise crack',
    play(vol) {
      const t = audioCtx.currentTime;
      const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(1800, t); osc.frequency.exponentialRampToValueAtTime(120, t + 0.1);
      g.gain.setValueAtTime(0.4 * vol, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
      osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(t + 0.15);
      const src = audioCtx.createBufferSource(); const ng = audioCtx.createGain();
      const filt = audioCtx.createBiquadFilter(); filt.type = 'highpass'; filt.frequency.value = 2000;
      src.buffer = sndNoiseBuf(0.04); ng.gain.setValueAtTime(0.35 * vol, t); ng.gain.exponentialRampToValueAtTime(0.001, t + 0.04);
      src.connect(filt); filt.connect(ng); ng.connect(audioCtx.destination); src.start();
    }},
  { id: 'zarium_strike', name: 'Zarium Strike', desc: 'Sharp attack + resonant thud',
    play(vol) {
      const t = audioCtx.currentTime;
      const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
      osc.type = 'square'; osc.frequency.setValueAtTime(3000, t); osc.frequency.exponentialRampToValueAtTime(800, t + 0.03);
      g.gain.setValueAtTime(0.25 * vol, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
      osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(t + 0.06);
      const osc2 = audioCtx.createOscillator(); const g2 = audioCtx.createGain();
      osc2.type = 'sine'; osc2.frequency.setValueAtTime(120, t); osc2.frequency.exponentialRampToValueAtTime(40, t + 0.15);
      g2.gain.setValueAtTime(0.5 * vol, t); g2.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
      osc2.connect(g2); g2.connect(audioCtx.destination); osc2.start(); osc2.stop(t + 0.2);
    }},
  { id: 'diolozom_pulse', name: 'Diolozom Pulse', desc: 'Deep sub-bass punch + mid crack',
    play(vol) {
      const t = audioCtx.currentTime;
      const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
      osc.type = 'sine'; osc.frequency.setValueAtTime(80, t); osc.frequency.exponentialRampToValueAtTime(25, t + 0.12);
      g.gain.setValueAtTime(0.7 * vol, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.18);
      osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(t + 0.18);
      const src = audioCtx.createBufferSource(); const ng = audioCtx.createGain();
      const filt = audioCtx.createBiquadFilter(); filt.type = 'bandpass'; filt.frequency.value = 800; filt.Q.value = 3;
      src.buffer = sndNoiseBuf(0.04); ng.gain.setValueAtTime(0.5 * vol, t); ng.gain.exponentialRampToValueAtTime(0.001, t + 0.04);
      src.connect(filt); filt.connect(ng); ng.connect(audioCtx.destination); src.start();
    }},
  { id: 'fragment_snap', name: 'Fragment Snap', desc: 'Tight noise pop + low body',
    play(vol) {
      const t = audioCtx.currentTime;
      const src = audioCtx.createBufferSource(); const ng = audioCtx.createGain();
      const filt = audioCtx.createBiquadFilter(); filt.type = 'bandpass'; filt.frequency.value = 1200; filt.Q.value = 2;
      src.buffer = sndNoiseBuf(0.03); ng.gain.setValueAtTime(0.5 * vol, t); ng.gain.exponentialRampToValueAtTime(0.001, t + 0.035);
      src.connect(filt); filt.connect(ng); ng.connect(audioCtx.destination); src.start();
      const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
      osc.type = 'sine'; osc.frequency.setValueAtTime(150, t); osc.frequency.exponentialRampToValueAtTime(50, t + 0.1);
      g.gain.setValueAtTime(0.45 * vol, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
      osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(t + 0.15);
    }},
  { id: 'core_crush', name: 'Core Crush', desc: 'Heavy layered thud + filtered crunch',
    play(vol) {
      const t = audioCtx.currentTime;
      const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
      osc.type = 'sine'; osc.frequency.setValueAtTime(60, t); osc.frequency.exponentialRampToValueAtTime(20, t + 0.15);
      g.gain.setValueAtTime(0.6 * vol, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
      osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(t + 0.2);
      const osc2 = audioCtx.createOscillator(); const g2 = audioCtx.createGain();
      osc2.type = 'sine'; osc2.frequency.setValueAtTime(140, t); osc2.frequency.exponentialRampToValueAtTime(45, t + 0.1);
      g2.gain.setValueAtTime(0.35 * vol, t); g2.gain.exponentialRampToValueAtTime(0.001, t + 0.12);
      osc2.connect(g2); g2.connect(audioCtx.destination); osc2.start(); osc2.stop(t + 0.12);
      const src = audioCtx.createBufferSource(); const ng = audioCtx.createGain();
      const filt = audioCtx.createBiquadFilter(); filt.type = 'lowpass'; filt.frequency.value = 2000;
      src.buffer = sndNoiseBuf(0.06); ng.gain.setValueAtTime(0.3 * vol, t); ng.gain.exponentialRampToValueAtTime(0.001, t + 0.06);
      src.connect(filt); filt.connect(ng); ng.connect(audioCtx.destination); src.start();
    }},
  { id: 'void_rupture', name: 'Void Rupture', desc: 'Sub boom + distorted mid burst',
    play(vol) {
      const t = audioCtx.currentTime;
      const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
      osc.type = 'sine'; osc.frequency.setValueAtTime(100, t); osc.frequency.exponentialRampToValueAtTime(28, t + 0.2);
      g.gain.setValueAtTime(0.65 * vol, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.25);
      osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(t + 0.25);
      const osc2 = audioCtx.createOscillator(); const g2 = audioCtx.createGain();
      osc2.type = 'square'; osc2.frequency.setValueAtTime(300, t); osc2.frequency.exponentialRampToValueAtTime(80, t + 0.08);
      g2.gain.setValueAtTime(0.2 * vol, t); g2.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
      osc2.connect(g2); g2.connect(audioCtx.destination); osc2.start(); osc2.stop(t + 0.1);
    }},
  { id: 'kings_hammer', name: "King's Hammer", desc: 'Massive low impact + rumble tail',
    play(vol) {
      const t = audioCtx.currentTime;
      const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
      osc.type = 'sine'; osc.frequency.setValueAtTime(90, t); osc.frequency.exponentialRampToValueAtTime(22, t + 0.2);
      g.gain.setValueAtTime(0.7 * vol, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
      osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(t + 0.3);
      const osc2 = audioCtx.createOscillator(); const g2 = audioCtx.createGain();
      osc2.type = 'triangle'; osc2.frequency.setValueAtTime(200, t); osc2.frequency.exponentialRampToValueAtTime(60, t + 0.08);
      g2.gain.setValueAtTime(0.35 * vol, t); g2.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
      osc2.connect(g2); g2.connect(audioCtx.destination); osc2.start(); osc2.stop(t + 0.1);
      const src = audioCtx.createBufferSource(); const ng = audioCtx.createGain();
      const filt = audioCtx.createBiquadFilter(); filt.type = 'lowpass'; filt.frequency.value = 400;
      src.buffer = sndNoiseBuf(0.3); ng.gain.setValueAtTime(0.001, t); ng.gain.linearRampToValueAtTime(0.15 * vol, t + 0.05);
      ng.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
      src.connect(filt); filt.connect(ng); ng.connect(audioCtx.destination); src.start();
    }},
  { id: 'hollow_whoosh', name: 'Hollow Whoosh', desc: 'Bandpass sweep through noise',
    play(vol) {
      const t = audioCtx.currentTime;
      const src = audioCtx.createBufferSource(); const g = audioCtx.createGain();
      const filt = audioCtx.createBiquadFilter(); filt.type = 'bandpass';
      filt.frequency.setValueAtTime(800, t); filt.frequency.exponentialRampToValueAtTime(200, t + 0.3); filt.Q.value = 2;
      src.buffer = sndNoiseBuf(0.35); g.gain.setValueAtTime(0.5 * vol, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
      src.connect(filt); filt.connect(g); g.connect(audioCtx.destination); src.start();
    }},
  { id: 'dull_thud', name: 'Dull Thud', desc: 'Low freq wall impact + noise',
    play(vol) {
      const t = audioCtx.currentTime;
      const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
      osc.type = 'sine'; osc.frequency.setValueAtTime(80, t); osc.frequency.exponentialRampToValueAtTime(30, t + 0.15);
      g.gain.setValueAtTime(0.6 * vol, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
      osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(t + 0.2);
      const src = audioCtx.createBufferSource(); const ng = audioCtx.createGain();
      src.buffer = sndNoiseBuf(0.05); ng.gain.setValueAtTime(0.15 * vol, t); ng.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
      src.connect(ng); ng.connect(audioCtx.destination); src.start();
    }},
  { id: 'static_fizzle', name: 'Static Fizzle', desc: 'Filtered noise burst',
    play(vol) {
      const t = audioCtx.currentTime;
      const src = audioCtx.createBufferSource(); const g = audioCtx.createGain();
      const filt = audioCtx.createBiquadFilter(); filt.type = 'lowpass'; filt.frequency.value = 3000;
      src.buffer = sndNoiseBuf(0.15); g.gain.setValueAtTime(0.4 * vol, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
      src.connect(filt); filt.connect(g); g.connect(audioCtx.destination); src.start();
    }},
  { id: 'void_drag', name: 'Void Drag', desc: 'Low rumble whoosh, heavy air',
    play(vol) {
      const t = audioCtx.currentTime;
      const src = audioCtx.createBufferSource(); const g = audioCtx.createGain();
      const filt = audioCtx.createBiquadFilter(); filt.type = 'lowpass';
      filt.frequency.setValueAtTime(600, t); filt.frequency.exponentialRampToValueAtTime(100, t + 0.35);
      src.buffer = sndNoiseBuf(0.4); g.gain.setValueAtTime(0.4 * vol, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.35);
      src.connect(filt); filt.connect(g); g.connect(audioCtx.destination); src.start();
      const osc = audioCtx.createOscillator(); const g2 = audioCtx.createGain();
      osc.type = 'sine'; osc.frequency.setValueAtTime(50, t); osc.frequency.exponentialRampToValueAtTime(20, t + 0.25);
      g2.gain.setValueAtTime(0.3 * vol, t); g2.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
      osc.connect(g2); g2.connect(audioCtx.destination); osc.start(); osc.stop(t + 0.3);
    }},
  { id: 'ash_scatter', name: 'Ash Scatter', desc: 'Soft filtered crumble',
    play(vol) {
      const t = audioCtx.currentTime;
      const src = audioCtx.createBufferSource(); const g = audioCtx.createGain();
      const filt = audioCtx.createBiquadFilter(); filt.type = 'bandpass';
      filt.frequency.setValueAtTime(1000, t); filt.frequency.exponentialRampToValueAtTime(300, t + 0.2); filt.Q.value = 1;
      src.buffer = sndNoiseBuf(0.2); g.gain.setValueAtTime(0.25 * vol, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
      src.connect(filt); filt.connect(g); g.connect(audioCtx.destination); src.start();
    }},
  { id: 'deep_miss', name: 'Deep Miss', desc: 'Sub thud + muffled fizzle',
    play(vol) {
      const t = audioCtx.currentTime;
      const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
      osc.type = 'sine'; osc.frequency.setValueAtTime(55, t); osc.frequency.exponentialRampToValueAtTime(20, t + 0.12);
      g.gain.setValueAtTime(0.4 * vol, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.18);
      osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(t + 0.18);
      const src = audioCtx.createBufferSource(); const ng = audioCtx.createGain();
      const filt = audioCtx.createBiquadFilter(); filt.type = 'lowpass'; filt.frequency.value = 1500;
      src.buffer = sndNoiseBuf(0.12); ng.gain.setValueAtTime(0.001, t); ng.gain.linearRampToValueAtTime(0.2 * vol, t + 0.02);
      ng.gain.exponentialRampToValueAtTime(0.001, t + 0.12);
      src.connect(filt); filt.connect(ng); ng.connect(audioCtx.destination); src.start();
    }},
  { id: 'shadow_pass', name: 'Shadow Pass', desc: 'Dark filtered sweep, ominous',
    play(vol) {
      const t = audioCtx.currentTime;
      const src = audioCtx.createBufferSource(); const g = audioCtx.createGain();
      const filt = audioCtx.createBiquadFilter(); filt.type = 'bandpass';
      filt.frequency.setValueAtTime(500, t); filt.frequency.exponentialRampToValueAtTime(100, t + 0.25); filt.Q.value = 3;
      src.buffer = sndNoiseBuf(0.3); g.gain.setValueAtTime(0.35 * vol, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.28);
      src.connect(filt); filt.connect(g); g.connect(audioCtx.destination); src.start();
    }}
];

function playGameSound(type) {
  if (!soundEnabled || soundVolume <= 0) return;
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const id = type === 'hit' ? selectedHitSound : selectedMissSound;
  const def = SOUND_DEFS.find(s => s.id === id);
  if (def) def.play(soundVolume);
}

function setSoundAssignMode(mode) {
  soundAssignMode = mode;
  $('assignHitBtn').classList.toggle('active', mode === 'hit');
  $('assignMissBtn').classList.toggle('active', mode === 'miss');
}

function selectSound(id) {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const def = SOUND_DEFS.find(s => s.id === id);
  if (def) def.play(soundVolume);
  if (soundAssignMode === 'hit') {
    selectedHitSound = id;
    $('currentHitName').textContent = def.name;
  } else {
    selectedMissSound = id;
    $('currentMissName').textContent = def.name;
  }
  buildSoundGrid();
  updateSoundSummary();
}

function updateSoundCards() {
  document.querySelectorAll('.sound-card').forEach(card => {
    const id = card.dataset.soundId;
    card.classList.toggle('selected-hit', id === selectedHitSound);
    card.classList.toggle('selected-miss', id === selectedMissSound);
  });
}

function updateSoundSummary() {
  if (!soundEnabled) { $('soundSummary').textContent = 'OFF'; return; }
  const vol = Math.round(soundVolume * 100);
  $('soundSummary').textContent = 'ON • ' + vol + '%';
}

function buildSoundGrid() {
  const grid = $('soundGrid');
  grid.innerHTML = '';
  SOUND_DEFS.forEach(s => {
    const card = document.createElement('div');
    card.className = 'sound-card';
    card.dataset.soundId = s.id;
    if (s.id === selectedHitSound) card.classList.add('selected-hit');
    if (s.id === selectedMissSound) card.classList.add('selected-miss');
    card.onclick = () => selectSound(s.id);
    card.innerHTML = '<div class="sound-card-icon">🔊</div><div class="sound-card-info">' +
      '<div class="sound-card-name">' + s.name + '</div>' +
      '<div class="sound-card-desc">' + s.desc + '</div>' +
      '<div class="sound-card-tags">' +
      (s.id === selectedHitSound ? '<span class="sound-tag tag-hit">HIT</span>' : '') +
      (s.id === selectedMissSound ? '<span class="sound-tag tag-miss">MISS</span>' : '') +
      '</div></div>';
    grid.appendChild(card);
  });
}

// Sound toggle
$('soundToggle').addEventListener('click', function() {
  this.classList.toggle('active');
  soundEnabled = this.classList.contains('active');
  $('soundVolRow').style.opacity = soundEnabled ? '1' : '.3';
  $('soundVolRow').style.pointerEvents = soundEnabled ? '' : 'none';
  updateSoundSummary();
});

// Volume slider
$('soundVolSlider').addEventListener('input', function() {
  soundVolume = this.value / 100;
  $('soundVolVal').textContent = this.value + '%';
  updateSoundSummary();
});

// Build grid on load
buildSoundGrid();
updateSoundSummary();
</script>
</body>
</html>
